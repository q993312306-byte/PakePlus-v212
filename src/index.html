<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CBM 箱规计算 & 托板展示（离线单文件｜HTML/CSS/JS）</title>
<style>
:root{
  --bg-light:#ffffff;
  --card-light:#ffffff;
  --text-light:#333333;
  --muted:#666666;
  --bg-dark:#0b1020;
  --card-dark:#111831;
  --text-dark:#eaf2ff;
  /* 主配色：蓝/黄/红 */
  --accent:#1e88e5;           /* 蓝 */
  --accent-rgb:30,136,229;
  --accent-yellow:#fbc02d;    /* 黄 */
  --accent-yellow-rgb:251,192,45;
  --accent-red:#e53935;       /* 红 */
  --accent-red-rgb:229,57,53;
  --left-w:520px;
}
*{box-sizing:border-box}
body{position:relative;margin:0;font-family:Roboto,system-ui,Segoe UI,Arial;background:var(--bg-light);color:var(--text-light)}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#fff;color:#333;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:10}
header .right{display:flex;align-items:center;gap:10px}
button{background:var(--accent);color:#fff;border:1px solid #dfe3e8;border-radius:0;padding:8px 12px;cursor:pointer}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,.7);color:#fff}
main{display:grid;grid-template-columns: var(--left-w) 8px 1fr;gap:16px;padding:16px;align-items:start}
.left{grid-column:1}
.splitter{grid-column:2;cursor:col-resize;background:repeating-linear-gradient(90deg,rgba(0,0,0,.12) 0 1px,transparent 1px 3px);border-radius:6px;min-height:40px}
.right{grid-column:3}
.panel{background:var(--card-light);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:14px}
.h{margin:0 0 8px;font-weight:600}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
input,select{padding:9px 10px;border:1px solid #cfcfcf;border-radius:0;min-width:120px}
.product-list{max-height:none;overflow:visible}
.product-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px;border:1px solid rgba(0,0,0,.08);border-radius:3px;margin-top:8px}
/* 新增行强调高亮，便于一目了然 */
.flash{box-shadow:0 0 0 2px var(--accent) inset}
.field{display:flex;flex-direction:column;gap:4px;min-width:120px;flex:1}
.field .label{font-size:12px;opacity:.8;text-align:left;width:100%}
.thumb{width:56px;height:56px;border:1px solid #cfcfcf;border-radius:3px;background:#e9eef6 center/cover no-repeat}
.viewer{position:relative;height:540px;border:1px solid rgba(0,0,0,.12);border-radius:3px;overflow:hidden;background:#fff}
body.dark .viewer{background:#fff}
.legend{position:absolute;left:10px;top:10px;color:#333;font-size:12px;border-radius:3px;padding:8px 10px;white-space:pre-line;background:#f7f8fa;border:1px solid var(--border-light);box-shadow:none}
.legend .ghost.small{border-radius:0;padding:4px 10px;border:1px solid var(--border-light);background:#fff;color:#333}
.legend .ghost.small:hover{filter:brightness(1.03)}
canvas{display:block;width:100%;height:100%}
.resizer{position:absolute;right:8px;bottom:8px;width:16px;height:16px;cursor:se-resize;opacity:.7}
.resizer:before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 0 40%,rgba(0,0,0,.3) 40% 60%,transparent 60%)}
  #viewerStack .viewer-grid{display:grid;grid-template-columns:repeat(2,minmax(280px,1fr));gap:16px;align-items:start}
  .viewer-card{display:flex;flex-direction:column;gap:6px}
  .viewer-card .title{margin:0 0 4px;font-weight:600}
  .viewer-card.span-2{grid-column:1 / -1}
  /* 自由摆放模式 */
  #viewerToolbar{display:flex;gap:8px;align-items:center;margin:6px 0 8px}
  #viewerStack.free .viewer-grid{position:relative;display:block}
  #viewerStack.free .viewer-card{position:absolute}
  #viewerStack.free .viewer-card .title{cursor:move}
.hidden-color{position:absolute;left:-9999px;width:0;height:0;opacity:0}
.swatch-grid{display:flex;flex-wrap:wrap;gap:6px;align-items:center;position:relative}
.swatch-grid.collapsed{display:none}
/* 颜色折叠开关按钮 */
.color-toggle{margin-left:8px;font-size:12px;padding:4px 8px;border:1px solid var(--border,#ddd);border-radius:3px;background:var(--btn-bg,#f6f7f9);color:var(--fg,#333);cursor:pointer}
/* 内联颜色选择弹窗 */
.color-popover{position:absolute;z-index:50;background:var(--panel-bg,#fff);color:var(--fg,#222);border:1px solid var(--border,#ddd);border-radius:3px;padding:10px;box-shadow:0 8px 24px rgba(0,0,0,.12);width:220px}
.color-popover .preview{width:100%;height:28px;border-radius:3px;border:1px solid var(--border,#ddd);margin-bottom:8px}
.color-popover .ctrl{display:flex;align-items:center;gap:8px;margin:6px 0}
.color-popover .ctrl label{flex:0 0 56px;color:var(--muted,#666)}
.color-popover .ctrl input[type="range"]{flex:1}
.color-popover .hex{font-family:monospace;font-size:12px;color:var(--muted,#666);margin-top:4px}
.color-popover .row{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
/* Windows 原生颜色选择器兜底按钮（仅用于产品颜色） */
  .color-native{width:24px;height:24px;padding:0;border:none;background:transparent;cursor:pointer;border-radius:4px;box-shadow:0 0 0 1px var(--border,#ddd) inset}
  /* 折叠时显示当前色的小色块 */
  .color-dot{display:inline-block;width:12px;height:12px;border-radius:3px;border:1px solid var(--border,#ddd);margin-right:6px;vertical-align:-2px}
  /* 右下角 AI 指示器 */
.ai-widget{position:fixed;right:16px;bottom:16px;z-index:9999;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:3px;background:rgba(255,255,255,.75);backdrop-filter:none;-webkit-backdrop-filter:none;border:1px solid var(--border-light);box-shadow:var(--shadow-1)}
  body.dark .ai-widget{background:rgba(255,255,255,.08);border-color:var(--border-dark)}
.ai-icon{width:22px;height:22px;border-radius:3px;display:flex;align-items:center;justify-content:center;background:#f3f4f6;color:#333;font-size:14px;box-shadow:var(--shadow-2)}
  .ai-icon{background:linear-gradient(180deg, var(--accent), var(--accent2, #32f08c));box-shadow:0 2px 8px rgba(var(--accent-rgb), .35)}
  .ai-spinner{display:none;width:12px;height:12px;border-radius:50%;border:2px solid rgba(50,240,140,.25);border-top-color:#32f08c;animation:aiSpin 1s linear infinite}
  .ai-text{font-size:12px;color:var(--text-light)}
  body.dark .ai-text{color:var(--text-dark)}
  .ai-pulse{width:8px;height:8px;border-radius:999px;background:#32f08c;box-shadow:0 0 0 0 rgba(50,240,140,.7);animation:aiPulse 2s infinite}
  @keyframes aiPulse{0%{box-shadow:0 0 0 0 rgba(50,240,140,.6)}70%{box-shadow:0 0 0 10px rgba(50,240,140,0)}100%{box-shadow:0 0 0 0 rgba(50,240,140,0)}}
  .ai-widget.busy{border-color:#32f08c}
  .ai-widget.busy .ai-pulse{background:#ff9800;box-shadow:0 0 0 0 rgba(255,152,0,.7);animation:aiPulseBusy 1.1s infinite}
  @keyframes aiPulseBusy{0%{box-shadow:0 0 0 0 rgba(255,152,0,.7)}70%{box-shadow:0 0 0 10px rgba(255,152,0,0)}100%{box-shadow:0 0 0 0 rgba(255,152,0,0)}}
  @keyframes aiSpin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  .ai-progress{position:absolute;left:0;right:0;bottom:0;height:2px;background:linear-gradient(90deg, rgba(50,240,140,0), rgba(50,240,140,.85), rgba(50,240,140,0));background-size:200% 100%;opacity:0}
  .ai-widget.busy .ai-progress{opacity:1;animation:aiProgress 1.2s linear infinite}
  @keyframes aiProgress{0%{background-position:0% 0}100%{background-position:200% 0}}
  /* 顶部细进度条 */
  #aiTopBar{position:fixed;left:0;top:0;height:3px;width:100%;background:linear-gradient(90deg, rgba(50,240,140,0), rgba(50,240,140,.85), rgba(50,240,140,0));background-size:200% 100%;opacity:0;pointer-events:none;z-index:9999}
  #aiTopBar.active{opacity:1;animation:aiProgress 1.2s linear infinite}
  /* 完成提示Toast */
  .ai-toast{position:fixed;right:16px;bottom:64px;background:rgba(0,0,0,.75);color:#fff;padding:8px 12px;border-radius:10px;font-size:12px;box-shadow:0 6px 18px rgba(0,0,0,.25);opacity:0;transform:translateY(10px);transition:all .28s ease;z-index:9999}
  .ai-toast.show{opacity:1;transform:translateY(0)}
  /* 重型按钮霓虹悬停与忙碌联动 */
  .btn-ai{position:relative;transition:transform .12s ease, box-shadow .2s ease}
  .btn-ai:hover{box-shadow:0 6px 16px rgba(50,240,140,.35)}
  .btn-ai:active{transform:scale(.98)}
  .btn-ai.busy{pointer-events:none}
  .btn-ai.busy::after{content:'';position:absolute;inset:-2px;border-radius:10px;padding:2px;background:linear-gradient(135deg, rgba(50,240,140,.9), rgba(50,240,140,.9));-webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask-composite:destination-out;mask-composite:exclude;animation:aiBorderFlow 1.2s linear infinite;opacity:.35}
  @keyframes aiBorderFlow{0%{filter:hue-rotate(0)}100%{filter:hue-rotate(360deg)}}
  .btn-ai .btn-progress{position:absolute;left:0;right:0;bottom:0;height:2px;background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.9), rgba(255,255,255,0));background-size:200% 100%;opacity:0}
  .btn-ai.busy .btn-progress{opacity:1;animation:aiProgress 1.2s linear infinite}
  .btn-ai .btn-spinner{display:none;position:absolute;right:8px;top:50%;transform:translateY(-50%);width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;animation:aiSpin 1s linear infinite}
  .btn-ai.busy .btn-spinner{display:block}
  /* 视图卡片闪光动效 */
  .viewer.flash{box-shadow:0 0 0 2px rgba(50,240,140,.35) inset, 0 8px 24px rgba(50,240,140,.25)}
  /* 计算按钮科技感特效与进度 */
  #calc{position:relative;overflow:hidden}
  #calc.busy{pointer-events:none}
  #calc.busy::after{content:'';position:absolute;inset:-2px;border-radius:10px;padding:2px;background:linear-gradient(135deg, rgba(50,240,140,.9), rgba(50,240,140,.9));-webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask-composite:destination-out;mask-composite:exclude;animation:aiBorderFlow 1.2s linear infinite;opacity:.35}
  @keyframes aiBorderFlow{0%{filter:hue-rotate(0)}100%{filter:hue-rotate(360deg)}}
  #calc .btn-progress{position:absolute;left:0;right:0;bottom:0;height:2px;background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.9), rgba(255,255,255,0));background-size:200% 100%;opacity:0}
  #calc.busy .btn-progress{opacity:1;animation:aiProgress 1.2s linear infinite}
  #calc .btn-spinner{display:none;position:absolute;right:8px;top:50%;transform:translateY(-50%);width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;animation:aiSpin 1s linear infinite}
  #calc.busy .btn-spinner{display:block}
  /* 点击涟漪特效 */
  .btn-ripple{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(.2);width:12px;height:12px;border-radius:999px;box-shadow:0 0 60px rgba(50,240,140,.6), 0 0 100px rgba(50,240,140,.45);opacity:.6;animation:aiRipple .7s ease-out forwards}
  @keyframes aiRipple{0%{transform:translate(-50%,-50%) scale(.2);opacity:.6}80%{opacity:.15}100%{transform:translate(-50%,-50%) scale(24);opacity:0}}
.swatch{width:24px;height:24px;border-radius:999px;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.15);cursor:pointer;display:inline-block;position:relative}
body.dark .swatch{box-shadow:0 0 0 1px rgba(255,255,255,.2)}
.swatch.selected{box-shadow:0 0 0 2px var(--accent), 0 0 0 1px rgba(0,0,0,.15) inset}
.swatch.plus{background:repeating-conic-gradient(#e9e9e9 0 25%, #f8f8f8 0 50%) 50%/200% 200%}
.swatch.plus::before{content:'+';position:absolute;left:50%;top:50%;transform:translate(-50%, -50%);font-weight:700;color:#333}
.watermark{position:absolute;inset:0;pointer-events:none;user-select:none;opacity:.06;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='420' height='220'%3E%3Ctext x='20' y='120' font-size='48' fill='rgba(255,255,255,0.12)' transform='rotate(-25 200 100)' font-family='Roboto, Arial'%3E%E9%99%88%E6%96%87%3C/text%3E%3C/svg%3E");background-repeat:repeat;z-index:0}
#historyList{margin-top:8px;max-height:180px;overflow:auto;border:1px dashed rgba(0,0,0,.2);border-radius:8px;padding:6px}
.history-item{display:flex;align-items:center;justify-content:space-between;padding:6px;border-bottom:1px dashed rgba(0,0,0,.15);gap:8px}
.history-item .txt{flex:1;min-width:0}
.history-item button.del{background:#e53935;color:#fff;border:none;border-radius:6px;padding:4px 8px;cursor:pointer}
body.dark .history-item button.del{background:#b71c1c}
.badge{display:inline-block;background:#eef3fe;color:#1a73e8;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
body.dark .badge{background:#0d244b;color:var(--muted)}
/* 中性化徽章颜色 */
.badge{color:var(--muted)}
/* --- UI Overhaul: Windows 11 + Frosted Glass --- */
:root{
  --glass-light: rgba(255,255,255,.55);
  --glass-dark: rgba(17,24,49,.45);
  --border-light: rgba(0,0,0,.10);
  --border-dark: rgba(255,255,255,.14);
  --shadow-1: none;
  --shadow-2: none;
}
/* 强制使用浅色系统控件渲染，避免原生下拉列表在暗色主题系统下偏白/反色 */
:root, body, .panel, .panel.left, #langSelect { color-scheme: light !important; }
body{background:#f7f8fa}
/* Header: glass */
header{backdrop-filter:none;-webkit-backdrop-filter:none;border-bottom:1px solid var(--border-light);background:#f7f8fa;color:#333}
body.dark header{background:#0f1730;border-bottom:1px solid var(--border-dark);color:#eaf2ff}
/* Buttons */
button{background:#f3f4f6;color:#333;border:1px solid #d0d7de;border-radius:0;height:34px;padding:0 14px;box-shadow: var(--shadow-2)}
button:hover{filter:brightness(1.05)}
button:active{transform:translateY(1px)}
button.ghost{background:transparent;border:1px solid var(--border-light);color:#333}
body.dark button.ghost{border-color:var(--border-dark);color:var(--text-dark)}
/* Semantic variants */
.btn-secondary{background:linear-gradient(180deg,#607d8b,#546e7a)!important}
.btn-secondary:hover{filter:brightness(1.06)}
.btn-danger{background:var(--accent-red)!important;color:#fff;border-color:transparent}
.btn-warning{background:var(--accent-yellow)!important;color:#333;border-color:transparent}
/* Panel: simplified surface */
.panel{background:#f7f8fa;backdrop-filter:none;-webkit-backdrop-filter:none;border:1px solid var(--border-light);border-radius:3px;box-shadow: none}
body.dark .panel{background:rgba(255,255,255,.08);border-color:var(--border-dark);box-shadow: none}
/* Inputs */
input,select{height:34px;padding:0 10px;border:1px solid #d0d7de;border-radius:0;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.03) inset}
input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(var(--accent-rgb),.18)}
body.dark input,body.dark select{background:#0e162d;border-color:#2a3b63;color:var(--text-dark)}
textarea{padding:10px 12px;border:1px solid #d0d7de;border-radius:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.03) inset;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace;line-height:1.5}
textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(var(--accent-rgb),.18)}
body.dark textarea{background:#0e162d;border-color:#2a3b63;color:var(--text-dark)}
/* Viewer */
.viewer{border:1px solid var(--border-light);border-radius:8px;background:#fff}
body.dark .viewer{border-color:var(--border-dark)}
/* Swatch */
.swatch{box-shadow:none; border:1px solid rgba(0,0,0,.12)}
/* 参数分组样式 */
.group{margin:12px 0;padding:12px;border-left:4px solid var(--accent);border-radius:8px;background:rgba(var(--accent-rgb),.06)}
body.dark .group{background:rgba(var(--accent-rgb),.12);border-left-color:var(--accent)}
.group-title{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:0 0 8px;font-weight:700;color:var(--accent)}
body.dark .group-title{color:var(--accent)}
.group-body{display:flex;flex-direction:column;gap:8px}
/* 分组折叠与图标 */
.group.collapsed .group-body{display:none}
.group .title-left{display:flex;align-items:center;gap:8px}
.gicon{display:inline-flex;width:22px;height:22px;border-radius:6px;align-items:center;justify-content:center;background:#eef3fe;color:var(--accent);font-size:14px}
body.dark .gicon{background:#0d244b;color:var(--accent)}
.group-toggle{background:transparent;border:1px solid var(--border-light);color:var(--accent);border-radius:8px;padding:2px 8px;cursor:pointer}
body.dark .group-toggle{border-color:var(--border-dark);color:var(--accent)}
.chip{display:inline-block;padding:2px 8px;border:1px solid var(--border-light);border-radius:0;font-size:12px;color:var(--muted);background:#fff;margin-right:6px}
body.dark .chip{background:#0e162d;border-color:var(--border-dark);color:var(--text-dark);opacity:.8}
/* 噪点毛玻璃纹理覆盖 */
header::before,.panel::before,.viewer::before{content:'';position:absolute;inset:0;pointer-events:none;opacity:.12;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Crect fill='rgba(255,255,255,0.02)' x='0' y='0' width='80' height='80'/%3E%3Ccircle cx='10' cy='12' r='1' fill='rgba(255,255,255,0.08)'/%3E%3Ccircle cx='28' cy='22' r='1' fill='rgba(255,255,255,0.06)'/%3E%3Ccircle cx='54' cy='18' r='1' fill='rgba(255,255,255,0.07)'/%3E%3Ccircle cx='40' cy='40' r='0.8' fill='rgba(255,255,255,0.07)'/%3E%3Ccircle cx='20' cy='58' r='1' fill='rgba(255,255,255,0.06)'/%3E%3Ccircle cx='66' cy='62' r='1' fill='rgba(255,255,255,0.06)'/%3E%3C/svg%3E");background-repeat:repeat;background-size:80px 80px;}
body.dark header::before,body.dark .panel::before,body.dark .viewer::before{opacity:.08}
/* 左侧面板滚动与动画优化 */
.panel.left{position:sticky;top:64px;max-height:calc(100vh - 80px);overflow:auto;display:flex;flex-direction:column;gap:12px}
.panel.left .group-body{opacity:1;max-height:999px;transition:max-height .2s ease, opacity .2s ease}
.panel.left .group.collapsed .group-body{opacity:0;max-height:0;overflow:hidden}
.panel.left .group.cat-prod .group-body{max-height:none}
.panel.left::-webkit-scrollbar{width:8px}
.panel.left::-webkit-scrollbar-thumb{background:#cfd6dd;border-radius:3px}
.panel.left::-webkit-scrollbar-track{background:transparent}
.panel.left:hover::-webkit-scrollbar-thumb{background:#bfc6cd}
.group:hover{background:rgba(var(--accent-rgb),.08)}
/* 分类标题 */
.category-title{font-weight:600;padding:6px 10px;border-radius:12px;background:rgba(var(--accent-rgb),.08);backdrop-filter:blur(8px);border:1px solid var(--border-light);color:var(--text-light);box-shadow:0 1px 3px rgba(0,0,0,.08)}
body.dark .category-title{background:rgba(255,255,255,.06);border-color:var(--border-dark);color:var(--text-dark)}
 /* 每托板缩略视角网格（嵌入托板预览卡片内） */
 .pallet-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;margin-top:10px}
 .pallet-cell{display:flex;flex-direction:column;gap:6px}
 .pallet-cell .mini-title{font-size:12px;opacity:.8;padding-left:2px}
.viewer.mini{height:280px}
/* 分类排序 */
.ct-base{order:10}
.ct-prod{order:20}
.ct-reco{order:30}
.ct-theme{order:40}
.group.cat-base{order:11}
.group.cat-prod{order:21}
.group.cat-reco{order:31}
.group.cat-theme{order:41}
/* 回到顶部按钮 */
#backTop{position:fixed;right:20px;bottom:24px;z-index:1000;display:none;border:1px solid var(--border-light);border-radius:0;padding:10px 14px;cursor:pointer;color:var(--text-light);background:#fff;box-shadow:var(--shadow-1)}
/* 当右下存在AI指示器时，自动上移避免重叠 */
body.has-ai-widget #backTop{bottom: calc(16px + var(--ai-widget-h, 60px) + 12px)}
body.dark #backTop{color:var(--text-dark);background:var(--glass-dark);border-color:var(--border-dark);}
#backTop:hover{transform:translateY(-1px);box-shadow:var(--shadow-2)}
/* 导入模块样式 */
.import-area textarea{width:100%;border:1px solid #d0d7de;border-radius:10px;padding:8px;min-height:120px}
body.dark .import-area textarea{background:#0e162d;border-color:#2a3b63;color:var(--text-dark)}
.table-sample{border:1px dashed var(--border-light);border-radius:10px;padding:8px;background:rgba(0,0,0,.02)}
body.dark .table-sample{border-color:var(--border-dark);background:rgba(255,255,255,.02)}
.table-sample pre{margin:0;white-space:pre;overflow:auto}
.hidden{display:none !important}
/* 货车推荐项样式 */
.truck-item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border-light);border-radius:10px;padding:8px 10px;margin:6px 0}
.truck-item .meta{color:var(--muted)}
.truck-item.recommended{background:rgba(52,168,83,.12);border-color:rgba(52,168,83,.35)}
body.dark .truck-item.recommended{background:rgba(76,175,80,.15);border-color:rgba(76,175,80,.45)}
.truck-tag{display:inline-block;border-radius:999px;padding:2px 8px;font-size:12px;margin-right:8px;background:rgba(52,168,83,.18);color:#1f5e2e;border:1px solid rgba(52,168,83,.35)}
body.dark .truck-tag{background:rgba(76,175,80,.22);color:#c8f0d2;border-color:rgba(76,175,80,.45)}
/* --- Luxe Tech Overrides --- */
:root{
  --lux-gold:#d4af37;
  --lux-gold-rgb:212,175,55;
  --tech-cyan:#00e5ff;
  --tech-cyan-rgb:0,229,255;
}
.viewer{background:#fff}
.viewer::after{content:none}
.group{position:relative;border-radius:3px;background:#fff;border:1px solid var(--border-light);overflow:hidden}
.group::before{content:none}
.group:hover{box-shadow:var(--shadow-1)}
.group-title{letter-spacing:.3px}
.group .title-left .gicon{background:linear-gradient(180deg, rgba(var(--accent-rgb),.18), rgba(var(--accent-rgb),.10)); border:1px solid var(--border-light); box-shadow:0 4px 12px rgba(0,0,0,.10)}
.group-toggle{border-radius:0;padding:4px 10px;transition:all .2s ease}
.group-toggle:hover{transform:translateY(-1px);box-shadow:var(--shadow-2)}
button:hover{filter:brightness(1.03);box-shadow:var(--shadow-2)}
button{background-image:none; background-size:auto; background-position:initial; transition:none}
button:hover{background-position:initial}
</style>
<style id="lang-select-contrast-fix">
  /* 语言选择下拉对比度优化，避免与右侧3D背景冲突 */
  .panel.left #langSelect { 
    background: rgba(255,255,255,0.92) !important; 
    color: #000 !important; 
    border: 1px solid rgba(0,0,0,0.12) !important; 
    border-radius: 8px !important; 
    padding: 8px 12px !important; 
    position: relative !important; 
    z-index: 10 !important;
    font-size: 14px !important;
    font-weight: 500 !important;
    min-width: 140px !important;
    height: 36px !important;
    box-shadow: 0 1px 2px rgba(0,0,0,.04) inset !important;
    filter: none !important;
    backdrop-filter: none !important;
    mix-blend-mode: normal !important;
  }
  /* 语言选择的下拉选项文字使用纯黑，背景白色，保证可读性 */
  .panel.left #langSelect option{ color:#000 !important; background:#fff !important; }
  .group.cat-lang .field { 
    background: transparent !important; 
    border: 0 !important; 
    border-radius: 8px !important; 
    padding: 0 !important;
    position: relative !important;
    isolation: isolate !important; /* 防止父级伪元素叠加影响子控件的混合与对比 */
  }
  .group.cat-lang .label { 
    font-weight: 600 !important; 
    color: inherit !important;
  }
  .group.cat-lang select:focus { 
    outline: 2px solid var(--accent, #4a90e2) !important; 
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2) !important;
  }
</style>
<style id="select-unify">
  /* 统一全站下拉与输入框的背景/文字/边框样式，贴合整体玻璃质感 */
  select, input{
    background: rgba(255,255,255,0.92) !important;
    color: #222 !important; /* 默认控件文本为深灰，语言选择框单独设为纯黑 */
    border: 1px solid rgba(0,0,0,0.12) !important;
    border-radius: 8px !important;
    height: 36px !important;
    padding: 8px 12px !important;
    box-shadow: 0 1px 2px rgba(0,0,0,.04) inset !important;
  }
  /* 下拉选项可读性（系统原生控件支持差异较大，尽可能统一） */
  select option{ background:#333; color:#fff; }
  /* 聚焦态统一视觉 */
  select:focus, input:focus{
    outline: none !important;
    border-color: var(--accent, #4a90e2) !important;
    box-shadow: 0 0 0 3px rgba(74,144,226,.18) !important;
  }
</style>
<!-- 删除自定义语言下拉样式：改用原生 select，保留对比度统一样式 -->
<style id="custom-select">
  /* 通用自定义下拉组件（黑色毛玻璃风格） */
  .ui-select-custom{ position: relative; max-width: 280px; display: inline-block; }
  @media all{ .ui-select-custom{ width: 100%; } }
  .ui-select-display{
    background: rgba(43,43,43,0.90);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.26);
    border-radius: 8px;
    height: 36px;
    padding: 8px 12px;
    display: flex; align-items: center; justify-content: space-between;
    cursor: pointer;
    pointer-events: auto;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    box-shadow: 0 6px 18px rgba(0,0,0,.12);
  }
  .ui-select-display .arrow{ width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:6px solid rgba(255,255,255,.85); margin-left:8px; }
  .ui-select-options{
    position: absolute; top: calc(100% + 6px); left: 0; min-width: 220px;
    background: rgba(43,43,43,0.94);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.28);
    border-radius: 12px;
    padding: 6px;
    box-shadow: 0 12px 28px rgba(0,0,0,.25);
    display: none;
    z-index: 3000;
    pointer-events: auto;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .ui-select-custom.open .ui-select-options{ display: block; }
  .ui-select-option{ padding: 8px 10px; border-radius: 8px; display:flex; align-items:center; justify-content:space-between; }
  .ui-select-option:hover{ background: rgba(255,255,255,0.12); }
  .native-hidden{
    position: absolute !important;
    left: -9999px !important;
    width: 1px !important;
    height: 1px !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }
</style>
<style id="custom-select-portal">
  /* 门户层：用于将下拉列表移动到 body 顶层，避免被父级遮挡 */
  .ui-portal{ position: fixed !important; z-index: 10000 !important; pointer-events: auto !important; }
</style>
<style id="i18n-rtl">
  /* RTL 支持：阿拉伯语时切换方向与对齐 */
  [dir="rtl"] body{ text-align: right; }
  [dir="rtl"] .panel.left .group-title .title-left{ flex-direction: row-reverse; }
  [dir="rtl"] .panel.left .group-body .row{ direction: rtl; }
  [dir="rtl"] header.commandbar{ direction: rtl; }
  [dir="rtl"] header.commandbar .right{ justify-self: start; }
  [dir="rtl"] header.commandbar > div:first-child{ justify-self: center; text-align: center; }
</style>
<style id="rtl-safety-reset">
  /* RTL 安全重置：保持布局容器为 LTR，避免栅格/绝对定位在 RTL 下异常 */
  [dir="rtl"] main,
  [dir="rtl"] section.panel,
  [dir="rtl"] .panel.left,
  [dir="rtl"] .panel.right,
  [dir="rtl"] .viewer,
  [dir="rtl"] #viewerStack,
  [dir="rtl"] .ui-select-custom,
  [dir="rtl"] .lang-custom{
    direction: ltr;
  }
  /* 保持图例与自定义下拉显示方向为 LTR，避免文本/箭头错位导致遮挡 */
  [dir="rtl"] .legend,
  [dir="rtl"] .lang-display,
  [dir="rtl"] .ui-select-display{
    direction: ltr;
    text-align: left;
  }
</style>
<style>
/* AI Glass Minimal Theme */
body.ai{font-family: var(--win-font, system-ui); letter-spacing:.1px}
/* 降低噪点覆盖，保持简约 */
body.ai header::before, body.ai .panel::before, body.ai .viewer::before{opacity:.06}
body.dark.ai header::before, body.dark.ai .panel::before, body.dark.ai .viewer::before{opacity:.05}
/* Header 更简洁的玻璃态 */
body.ai header{backdrop-filter: blur(16px) saturate(160%); -webkit-backdrop-filter: blur(16px) saturate(160%); border-bottom:1px solid var(--border-light); box-shadow:0 6px 20px rgba(0,0,0,.10)}
body.dark.ai header{border-bottom:1px solid var(--border-dark); box-shadow:0 8px 28px rgba(0,0,0,.35)}
/* Panel/Group 统一玻璃面 */
body.ai .panel{background:rgba(255,255,255,.32); border:1px solid rgba(255,255,255,.30); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); box-shadow:0 12px 40px rgba(0,0,0,.12)}
body.dark.ai .panel{background:rgba(17,24,49,.34); border-color:rgba(255,255,255,.16); box-shadow:0 12px 40px rgba(0,0,0,.45)}
body.ai .group{margin:12px 0; padding:12px; border-radius:16px; background:rgba(255,255,255,.22); border:1px solid rgba(255,255,255,.28); border-left:none}
body.dark.ai .group{background:rgba(17,24,49,.26); border-color:rgba(255,255,255,.16)}
body.ai .group-title{font-weight:600; color:var(--accent)}
/* 分类标题更轻盈 */
body.ai .category-title{background:rgba(255,255,255,.24); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.3); color:var(--text-light)}
body.dark.ai .category-title{background:rgba(255,255,255,.12); border-color:var(--border-dark); color:var(--text-dark)}
/* Viewer 卡片玻璃态 */
body.ai .viewer{background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.28); backdrop-filter: blur(16px) saturate(160%); -webkit-backdrop-filter: blur(16px) saturate(160%)}
body.dark.ai .viewer{background:rgba(17,24,49,.28); border-color:rgba(255,255,255,.16)}
/* AI 指示器更强AI感：轻发光+玻璃 */
body.ai .ai-widget{background:rgba(255,255,255,.50); border:1px solid rgba(255,255,255,.35); box-shadow:0 12px 28px rgba(0,0,0,.18)}
body.dark.ai .ai-widget{background:rgba(17,24,49,.55); border-color:rgba(255,255,255,.18)}
/* 重型按钮，极简玻璃边框与忙碌发光 */
body.ai .btn-ai{background:transparent; color:var(--accent); border:1px solid rgba(255,255,255,.35)}
body.ai .btn-ai.busy::after{background:linear-gradient(135deg, rgba(var(--accent-rgb),.85), rgba(var(--accent-rgb),.9))}
/* 通用按钮与输入的玻璃统一 */
body.ai button{background:linear-gradient(180deg, var(--accent), var(--accent)); color:#fff}
body.ai button.ghost{border-color:rgba(255,255,255,.35); color:var(--accent)}
body.ai input, body.ai select, body.ai textarea{background:rgba(255,255,255,.6); border:1px solid rgba(255,255,255,.38)}
</style>
<style>
/* Win11 Fluent Shell */
:root{
  --win-font:"Segoe UI Variable","Segoe UI",system-ui,-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
  --win-radius-8:8px; --win-radius-12:12px; --win-radius-16:16px;
  --win-stroke:rgba(0,0,0,.08); --win-stroke-strong:rgba(0,0,0,.12);
  --win-shadow-1:0 6px 18px rgba(0,0,0,.10);
  --win-shadow-2:0 12px 30px rgba(0,0,0,.14);
  --win-mica-1:linear-gradient(180deg, rgba(255,255,255,.75), rgba(245,247,251,.88));
  --win-mica-noise:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="1"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.05"/></svg>');
}
body.win11{font-family:var(--win-font); background:#ffffff; position:relative}
body.win11::before{content:none}
header.commandbar{backdrop-filter:none; -webkit-backdrop-filter:none; background:#ffffff; border-bottom:1px solid var(--win-stroke); box-shadow:none; border-radius:0}
header.commandbar .left .title{font-weight:600; letter-spacing:.2px}
header.commandbar .right .ghost, header.commandbar .right .btn, header.commandbar .right .button{border-radius:0; border:1px solid var(--win-stroke); background:rgba(255,255,255,.85)}
.panel.left{background:rgba(255,255,255,.85); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border-right:1px solid var(--win-stroke); box-shadow:var(--win-shadow-1)}
.group{border-radius:12px; border:1px solid var(--win-stroke); background:rgba(255,255,255,.65)}
.group .title-left .gicon{border-radius:10px}
.group-title{font-weight:600}
.input, select, input[type='number'], input[type='text']{border-radius:0; border:1px solid var(--win-stroke); background:#fff}
button, .btn{border-radius:0; border:1px solid var(--win-stroke); background:#fff; box-shadow:none}
button.primary, .btn.primary{background:var(--accent); color:#fff; border-color:transparent}
button:hover, .btn:hover{box-shadow:var(--win-shadow-1)}
.viewer{border-radius:3px; border:1px solid var(--win-stroke-strong); background:#fff}
.legend{border-radius:3px; border:1px solid var(--win-stroke)}
/* Focus visuals for Win11 nativeness */
:focus{outline:none}
:focus-visible{outline:none}
button:focus-visible, .btn:focus-visible, .input:focus-visible, select:focus-visible, input[type='number']:focus-visible, input[type='text']:focus-visible{
  box-shadow:0 0 0 2px rgba(var(--accent-rgb),.28);
  border-color:rgba(var(--accent-rgb),.55);
}
/* Dashboard metrics */
.dash-grid{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:12px;margin-bottom:12px}
.dash-card{border-radius:3px;border:1px solid var(--win-stroke);background:#f7f8fa;backdrop-filter:none;-webkit-backdrop-filter:none;padding:12px;box-shadow:var(--shadow-1)}
body.dark .dash-card{background:rgba(255,255,255,.08)}
.dash-label{font-size:12px;color:var(--muted)}
.dash-value{font-size:20px;font-weight:600;color:var(--text-light)}
body.dark .dash-value{color:var(--text-dark)}
/* Fix: prevent gradient border pseudo-element artifacts on group cards */
.group::before{content:none}
.group{border:1px solid var(--win-stroke); border-image:none; background:#f7f8fa}
/* --- Left Pane Redesign (Win11 Navigation Pane) --- */
.panel.left{padding:14px; background:#f7f8fa; border-right:1px solid var(--win-stroke); box-shadow:none; border-radius:1px}
body.dark .panel.left{background:rgba(255,255,255,.06)}
.panel.left .category-title{background:#f7f8fa; border:1px solid var(--win-stroke); border-radius:1px; padding:8px 12px; margin:6px 0 10px; box-shadow:none}
body.dark .panel.left .category-title{background:rgba(255,255,255,.08); border-color:var(--win-stroke-strong)}
.panel.left .group{background:#f7f8fa; border:1px solid var(--win-stroke); border-image:none; box-shadow:none; border-radius:1px}
.panel.left .group{overflow:visible}
body.dark .panel.left .group{background:rgba(255,255,255,.08)}
.panel.left .group + .group{margin-top:10px}
.panel.left .group-title{display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:none}
.panel.left .group .title-left{display:flex; align-items:center; gap:8px}
.panel.left .group .title-left .gicon{display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:1px; background:#f3f4f6; border:1px solid var(--win-stroke)}
.panel.left .group-toggle{border-radius:1px; padding:4px 10px; border:1px solid var(--win-stroke); background:#fff}
.panel.left .group-toggle:hover{transform:none; box-shadow:none; filter:brightness(1.02)}
.panel.left .group:hover{background:#f7f8fa}
.panel.left .group-body{padding:10px}

/* 左栏滚动条统一为浅灰与3px圆角 */
.panel.left::-webkit-scrollbar{width:10px}
.panel.left::-webkit-scrollbar-thumb{background:#d0d7de; border-radius:1px}
.panel.left .group-body .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.panel.left .field{flex:1 1 180px; min-width:160px}
.panel.left input, .panel.left select{height:34px}
.panel.left .small{opacity:.85}
.panel.left::-webkit-scrollbar-thumb{background:#cfd6dd}
.panel.left:hover::-webkit-scrollbar-thumb{background:#bfc6cd}

/* --- Google Material Overrides --- */
body.google{
  --md-primary:#3f51b5; --md-primary-rgb:63,81,181;
  --md-secondary:#009688; --md-secondary-rgb:0,150,136;
  --md-surface:#FFFFFF; --md-on-surface:#1F1F1F;
  --md-outline:rgba(0,0,0,.12);
  --accent:#3f51b5; --accent-rgb:63,81,181;
  font-family:"Roboto",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
  background:var(--md-surface); color:var(--md-on-surface);
}
body.google header.commandbar{background:#fff; color:var(--md-on-surface); border-bottom:1px solid var(--md-outline); box-shadow:0 2px 6px rgba(0,0,0,.08)}
body.google .panel.left{background:#fff; border-right:1px solid var(--md-outline); box-shadow:none}
body.google .category-title{background:#fff; border:1px solid var(--md-outline); color:var(--md-on-surface)}
body.google .group{background:#fff; border:1px solid var(--md-outline); border-image:none; box-shadow:0 1px 4px rgba(0,0,0,.08)}
body.google .group-title{font-weight:600; color:var(--md-on-surface)}
body.google .group-toggle{border:1px solid var(--md-outline); background:#fff; color:var(--md-primary); border-radius:10px}
body.google .gicon{background:#fff; color:var(--md-primary); border:1px solid var(--md-outline)}
body.google input, body.google select{border:1px solid var(--md-outline); border-radius:10px; background:#fff}
body.google input:focus, body.google select:focus{outline:none; box-shadow:0 0 0 3px rgba(var(--md-primary-rgb),.20); border-color:var(--md-primary)}
body.google button, body.google .btn{border-radius:10px; padding:8px 14px; background:var(--md-primary); color:#fff; border:none; box-shadow:0 2px 6px rgba(var(--md-primary-rgb),.25)}
body.google button.ghost, body.google .btn.ghost{background:transparent; border:1px solid rgba(var(--md-primary-rgb),.40); color:var(--md-primary)}
body.google .legend{border:1px solid var(--md-outline)}
body.google .dash-card{background:#fff; border:1px solid var(--md-outline); box-shadow:0 1px 4px rgba(0,0,0,.08)}
body.google .panel.left .group:hover{background:#fff}

/* --- Apple Design Overrides --- */
body.apple{--accent:#0a84ff; --accent-rgb:10,132,255; --apple-bg:#f5f5f7; --apple-stroke:rgba(0,0,0,.10); --apple-shadow:0 8px 20px rgba(0,0,0,.08); font-family:"SF Pro Text","SF Pro Display",-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif; background:var(--apple-bg)}
body.apple header.commandbar{backdrop-filter:saturate(1.3) blur(20px); -webkit-backdrop-filter:saturate(1.3) blur(20px); background:rgba(250,250,252,.72); border-bottom:1px solid var(--apple-stroke); color:#111}
body.apple .panel.left{background:#f5f5f7; border-right:1px solid var(--apple-stroke); box-shadow:none}
body.apple .category-title{background:#eef0f4; border:1px solid var(--apple-stroke); color:#111}
body.apple .group{background:#fff; border:1px solid var(--apple-stroke); border-image:none; box-shadow:0 1px 3px rgba(0,0,0,.06)}
body.apple .group-title{font-weight:600; color:#111}
body.apple .group-toggle{border:1px solid var(--apple-stroke); background:#fff; color:#0a84ff; border-radius:14px}
body.apple .gicon{background:#eef2ff; color:#0a84ff; border:1px solid var(--apple-stroke)}
body.apple input, body.apple select{border:1px solid var(--apple-stroke); border-radius:12px; background:#fff}
body.apple input:focus, body.apple select:focus{outline:none; box-shadow:0 0 0 3px rgba(var(--accent-rgb),.22); border-color:rgba(var(--accent-rgb),.55)}
body.apple button, body.apple .btn{border-radius:22px; padding:8px 16px; background:var(--accent); color:#fff; border:none}
body.apple button.ghost, body.apple .btn.ghost{background:transparent; border:1px solid var(--apple-stroke); color:#0a84ff}
body.apple .legend{border:1px solid var(--apple-stroke)}
</style>
<style id="ai-dock-style">
  .ai-dock { position: fixed; right: 16px; bottom: 0; width: 440px; height: 56vh; z-index: 10000;
    border-radius: 1px 16px 0 0; border: 1px solid rgba(255,255,255,.25);
    background: rgba(23,23,26,.72); backdrop-filter: blur(14px) saturate(120%);
    box-shadow: 0 18px 50px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.25);
    transform: translateY(100%); opacity: 0; pointer-events: none;
    transition: transform .28s ease, opacity .28s ease;
  }
  .ai-dock.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
  .ai-dock .bar { height: 38px; display: flex; align-items: center; justify-content: space-between;
    padding: 0 12px; border-bottom: 1px solid rgba(255,255,255,.12); color: #fff; font-size: 14px;
  }
  .ai-dock .bar .title { display:flex; align-items:center; gap:8px; font-weight:600; }
  .ai-dock .bar .actions { display:flex; align-items:center; gap:8px; }
  .ai-dock .bar button { height: 26px; padding: 0 10px; font-size: 12px; border-radius: 1px;
    background: rgba(255,255,255,.08); color:#fff; border: 1px solid rgba(255,255,255,.18);
    cursor: pointer; transition: background .18s ease, transform .08s ease; }
  .ai-dock .bar button:hover { background: rgba(255,255,255,.14); }
  .ai-dock .bar button:active { transform: scale(.98); }
  .ai-dock iframe { width: 100%; height: calc(100% - 38px); border: none; background: #fff; }
  body.light .ai-dock { background: rgba(255,255,255,.82); border-color: rgba(0,0,0,.12); }
  body.light .ai-dock .bar { color: #222; border-bottom-color: rgba(0,0,0,.08); }
  body.light .ai-dock .bar button { background: rgba(0,0,0,.05); color: #222; border-color: rgba(0,0,0,.12); }
  @media (max-width: 520px){ .ai-dock { right: 8px; width: calc(100vw - 16px); height: 60vh; } }
  .dock-fallback{display:none; height: calc(100% - 38px); padding: 12px; color: var(--text-light);}
  body.dark .dock-fallback{color: var(--text-dark)}
  .dock-fallback .hint{font-size: 13px; opacity: .8; margin-bottom: 8px}
  .dock-fallback .row{display:flex; gap:8px; align-items:center}
  .dock-fallback button{height:28px; padding:0 10px; font-size:12px; border-radius:8px; background: rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.18); cursor:pointer}
  body.light .dock-fallback button{background: rgba(0,0,0,.05); color:#222; border-color: rgba(0,0,0,.12)}
  /* 整个AI指示器区域可点击，显示手型指针 */
  .ai-widget{cursor:pointer}
</style>
</head>
<style id="linear-theme">
  /* Linear Dark Aesthetic — gradients, blur, micro noise, ultra-thin strokes, restrained motion */
  @keyframes linearSheen { to { background-position: 200% 0; } }
  @keyframes linearGlow { 0%, 100% { box-shadow: 0 0 0 0 rgba(50,240,140,.0); } 50% { box-shadow: 0 0 30px 6px rgba(50,240,140,.15); } }

  body.linear {
    font-family: Inter, "SF Pro Text", Segoe UI, system-ui, -apple-system, "Microsoft YaHei", Arial, sans-serif;
    color: #e6e8ec;
    background: radial-gradient(800px at 20% 10%, rgba(72,84,255,.08), transparent 60%),
                radial-gradient(600px at 80% 90%, rgba(50,240,140,.10), transparent 60%),
                linear-gradient(180deg, #0f1115 0%, #121417 40%, #15171a 100%);
    background-attachment: fixed;
    --linear-stroke: rgba(255,255,255,.14);
    --linear-stroke-strong: rgba(255,255,255,.24);
    --linear-card-bg: rgba(20,22,26,.65);
    --linear-panel-bg: rgba(20,22,26,.55);
    --linear-shadow-1: 0 20px 60px rgba(0,0,0,.35), 0 6px 20px rgba(0,0,0,.25);
    --accent: #32f08c;
    --accent-rgb: 50,240,140;
    --accent-2: #32f08c;
    --accent-2-rgb: 50,240,140;
    /* Text palette for unified typography */
    --text-primary: #e6e8ec;
    --text-secondary: #c7ccd4;
    --text-muted: #a9afb8;
    --text-accent: #9aa7ff;
  }

  body.linear::before {
    content: '';
    position: fixed; inset: 0; pointer-events: none;
    background-image:
      radial-gradient(1px 1px at 10% 10%, rgba(255,255,255,.05), transparent),
      radial-gradient(1px 1px at 22% 36%, rgba(255,255,255,.03), transparent),
      radial-gradient(1px 1px at 70% 80%, rgba(255,255,255,.04), transparent);
    opacity: .5;
  }

  /* Smooth, restrained motion defaults */
  header.commandbar,
  .dash-card,
  .panel,
  .panel.left,
  .group,
  .viewer,
  .legend,
  button, .btn,
  input, select, textarea,
  .splitter {
    transition: background .20s ease, border-color .20s ease, box-shadow .20s ease, transform .06s ease, filter .12s ease;
  }

  /* Header: glassy dark with ultra-thin stroke */
  body.linear header.commandbar {
    background: rgba(18,20,24,.65);
    border-bottom: 1px solid var(--linear-stroke);
    backdrop-filter: blur(12px) saturate(120%);
    box-shadow: var(--linear-shadow-1);
    border-radius: 0;
  }
  body.linear header.commandbar .right .button,
  body.linear header.commandbar .right .btn,
  body.linear header.commandbar .right .ghost {
    border: 1px solid var(--linear-stroke);
    background: rgba(255,255,255,.06);
    color: #e6e8ec;
    border-radius: 1px;
  }

  /* Panels & cards: blurred, subtle glow, ultra-thin stroke */
  body.linear .panel,
  body.linear .dash-card {
    background: var(--linear-card-bg);
    border: 1px solid var(--linear-stroke);
    backdrop-filter: blur(14px) saturate(120%);
    -webkit-backdrop-filter: blur(14px) saturate(120%);
    box-shadow: var(--linear-shadow-1);
    border-radius: 8px;
  }
  /* Left sidebar keeps 1px radius per requirement */
  body.linear .panel.left,
  body.linear .panel.left .category-title,
  body.linear .panel.left .group,
  body.linear .panel.left .group .title-left .gicon,
  body.linear .panel.left .group-toggle,
  body.linear .panel.left::-webkit-scrollbar-thumb {
    border-radius: 1px !important;
    border-color: var(--linear-stroke) !important;
    background: rgba(24,26,30,.55) !important;
    color: #e6e8ec !important;
  }

  /* Buttons: gradient with restrained sheen */
  body.linear button,
  body.linear .btn {
    border: 1px solid var(--linear-stroke);
    background: rgba(255,255,255,.06);
    color: var(--text-primary);
    border-radius: var(--radius-6);
    position: relative;
    overflow: hidden;
    min-height: var(--btn-h, 32px);
    padding: 0 var(--btn-pad-x, 12px);
    font-weight: 500;
  }
  body.linear .btn.primary,
  body.linear button.primary {
    background: rgba(var(--accent-rgb), .12);
    border-color: rgba(var(--accent-rgb), .38);
    color: var(--text-primary);
  }
  body.linear .btn.primary::after,
  body.linear button.primary::after {
    content: none;
  }
  body.linear button:hover,
  body.linear .btn:hover { filter: brightness(1.06); }
  body.linear button:active,
  body.linear .btn:active { transform: translateY(0); }

  /* Inputs: subtle inner stroke on glass */
  body.linear input,
  body.linear select,
  body.linear textarea {
    background: rgba(255,255,255,.06);
    border: 1px solid var(--linear-stroke);
    color: #e6e8ec;
    box-shadow: 0 1px 0 rgba(255,255,255,.06) inset;
    border-radius: 6px;
  }

  /* Viewer & legend */
  body.linear .viewer {
    background: #0f1115;
    border: 1px solid var(--linear-stroke-strong);
    border-radius: 8px;
    box-shadow: var(--linear-shadow-1);
  }
  body.linear .legend {
    background: rgba(24,26,30,.55);
    border: 1px solid var(--linear-stroke);
    color: var(--text-primary);
    border-radius: 6px;
    box-shadow: none;
  }

  /* Splitter: delicate texture subdued */
  body.linear .splitter {
    background: linear-gradient(90deg, rgba(255,255,255,.12) 0 1px, transparent 1px 3px);
    border-radius: 6px;
  }

  /* Accent glow utility */
  body.linear .glow {
    animation: linearGlow 2.8s ease-in-out infinite;
  }
  /* --- Linear V2: Color controls refinement --- */
  body.linear .color-toggle {
    border: 1px solid var(--linear-stroke);
    background: rgba(255,255,255,.06);
    color: #e6e8ec;
    border-radius: 6px;
  }
  body.linear .color-popover {
    background: rgba(24,26,30,.65);
    border: 1px solid var(--linear-stroke);
    color: #e6e8ec;
    border-radius: 6px;
    box-shadow: var(--linear-shadow-1);
  }
  body.linear .color-popover .preview {
    border: 1px solid var(--linear-stroke);
    border-radius: 6px;
  }
  body.linear .color-native {
    border-radius: 6px;
    box-shadow: 0 0 0 1px var(--linear-stroke) inset;
  }
  body.linear .color-dot {
    border-radius: 4px;
    border: 1px solid var(--linear-stroke);
  }

  /* --- Linear V2: AI Dock & widgets --- */
  body.linear .ai-dock {
    background: rgba(23,25,29,.75);
    border: 1px solid var(--linear-stroke-strong);
    backdrop-filter: blur(14px) saturate(120%);
    -webkit-backdrop-filter: blur(14px) saturate(120%);
    box-shadow: var(--linear-shadow-1);
    border-radius: 8px 8px 0 0;
  }
  body.linear .ai-dock .bar button {
    border: 1px solid var(--linear-stroke);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    color: #e6e8ec;
    border-radius: 6px;
  }
  body.linear .ai-widget {
    background: rgba(255,255,255,.10);
    border: 1px solid var(--linear-stroke);
    color: #e6e8ec;
    border-radius: 6px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  body.linear .ai-icon {
    background: rgba(255,255,255,.12);
    border-radius: 6px;
    color: #e6e8ec;
    box-shadow: none;
  }
  body.linear .ai-toast {
    background: rgba(0,0,0,.70);
    border: 1px solid var(--linear-stroke);
    border-radius: 6px;
    box-shadow: var(--linear-shadow-1);
  }

  /* --- Linear V2: chips & titles --- */
  body.linear .chip {
    border: 1px solid var(--linear-stroke);
    background: rgba(255,255,255,.06);
    color: var(--text-primary);
    border-radius: 6px;
  }
  body.linear .group-title,
  body.linear .category-title {
    border-color: var(--linear-stroke);
    background: rgba(24,26,30,.55);
    color: var(--text-primary);
  }

  /* --- Linear V2: import/table/truck items --- */
  body.linear .import-area textarea {
    background: rgba(255,255,255,.06);
    border: 1px solid var(--linear-stroke);
    color: var(--text-primary);
    border-radius: 6px;
  }
  body.linear .table-sample {
    border: 1px solid var(--linear-stroke);
    border-radius: 6px;
    background: rgba(24,26,30,.40);
  }
  body.linear .truck-item {
    border: 1px solid var(--linear-stroke);
    border-radius: 6px;
    background: rgba(24,26,30,.40);
  }
  /* --- Linear V3: Tokens, typography, micro-motion, utilities --- */
  body.linear {
    --radius-1: 1px;
    --radius-4: 4px;
    --radius-6: 6px;
    --shadow-soft: 0 8px 28px rgba(0,0,0,.28), 0 2px 8px rgba(0,0,0,.20);
  }
  /* Utilities */
  body.linear .thin-stroke { border: 1px solid var(--linear-stroke) !important; }
  body.linear .radius-1 { border-radius: var(--radius-1) !important; }
  body.linear .radius-6 { border-radius: var(--radius-6) !important; }

  /* Subgroup styles for organized params */
  body.linear .subgroup {
    margin-top: 8px;
    padding: 8px;
    border: 1px solid var(--linear-stroke);
    border-radius: var(--radius-6);
    background: rgba(255,255,255,.04);
  }
  body.linear .sub-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 6px;
  }

  /* Typography */
  body.linear h1, body.linear h2, body.linear h3 { font-weight: 600; letter-spacing: .2px; color: #eef0f3; }
  body.linear h4, body.linear h5, body.linear h6 { font-weight: 600; letter-spacing: .1px; color: #e6e8ec; }
  body.linear .muted { color: #a9afb8; }

  /* Focus rings */
  body.linear :focus-visible {
    outline: 1px solid rgba(var(--accent-rgb), .55);
    outline-offset: 2px;
    box-shadow: 0 0 0 4px rgba(var(--accent-rgb), .12);
    transition: outline-color .2s ease, box-shadow .2s ease;
  }

  /* Cards hover micro-motion */
  body.linear .dash-card:hover, body.linear .panel:hover {
    transform: translateY(-0.5px);
    box-shadow: var(--shadow-soft);
  }

  /* Group toggle hover refinement */
  body.linear .panel.left .group-toggle:hover { filter: brightness(1.08); }

  /* Legend & viewer refinement */
  body.linear .legend { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }

  /* Splitter subtle feedback */
  body.linear .splitter:hover { filter: brightness(1.06); }

  /* Toast glow restraint */
  body.linear .ai-toast { box-shadow: var(--shadow-soft); }

  /* Back-to-top button: Linear theme */
  body.linear #backTop{
    background: rgba(255,255,255,.08);
    color: var(--text-primary);
    border: 1px solid var(--linear-stroke);
    border-radius: var(--radius-6);
    box-shadow: var(--linear-shadow-1);
    min-height: var(--btn-h, 32px);
    padding: 0 var(--btn-pad-x, 12px);
  }
  body.linear #backTop:hover{
    filter: brightness(1.06);
    box-shadow: var(--shadow-soft);
  }

  /* Buttons: align content center horizontally and vertically */
  body.linear button,
  body.linear .btn,
  body.linear .group-toggle,
  body.linear .dock-fallback button,
  body.linear .ai-dock .bar button,
  body.linear header.commandbar .right .button,
  body.linear header.commandbar .right .btn,
  body.linear header.commandbar .right .ghost{
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    text-align: center !important;
    gap: 6px;
    line-height: 1.2;
    vertical-align: middle;
    white-space: nowrap;
  }
  /* icons inside buttons should not baseline shift */
  body.linear button > i,
  body.linear .btn > i,
  body.linear .group-toggle > i,
  body.linear button > svg,
  body.linear .btn > svg,
  body.linear .group-toggle > svg{
    display: block;
  }

  /* —————————————————————————————————————————— */
  /* Linear Hard Text Reset (fix stray white/purple) */
  /* 强化在 Linear 主题下的文字颜色一致性，消除白色与紫色残留 */
  body.linear h1, body.linear h2, body.linear h3, body.linear h4, body.linear h5, body.linear h6,
  body.linear p, body.linear span, body.linear label, body.linear small,
  body.linear .legend, body.linear .group-title, body.linear .category-title,
  body.linear .chip, body.linear .badge, body.linear .truck-item, body.linear .truck-tag,
  body.linear .product-row, body.linear .list-item, body.linear .title,
  body.linear header.commandbar, body.linear header.commandbar *,
  body.linear button, body.linear .btn, body.linear .group-toggle,
  body.linear .dock-fallback button,
  body.linear .ai-dock, body.linear .ai-dock *, body.linear .ai-widget, body.linear .ai-toast,
  body.linear input, body.linear select, body.linear textarea,
  body.linear a, body.linear a:visited,
  body.linear .gicon, body.linear .gicon *
  { color: var(--text-primary) !important; }

  /* 链接使用主文本色，悬停仅下划线强调，避免“紫色/主题色” */
  body.linear a:hover{ color: var(--text-primary) !important; text-decoration: underline; }

  /* 个别组件的显式白色：覆盖为主文本色 */
  body.linear .ai-toast{ color: var(--text-primary) !important; }
  body.linear .dock-fallback button{ color: var(--text-primary) !important; }
  body.linear .badge{ color: var(--text-primary) !important; }
  body.linear .group-title{ color: var(--text-primary) !important; }
  body.linear .gicon{ color: var(--text-primary) !important; }
  body.linear .group-toggle{ color: var(--text-primary) !important; }

  /* 输入控件 placeholder 保持弱提示 */
  body.linear ::placeholder{ color: var(--text-muted) !important; }
</style>
<body class="linear">
<div class="watermark"></div>
<style id="custom-ai-button-colors">
  /* 自定义：按需设定特定AI按钮的配色与对齐 */
  /* 绿：#32f08c；橙：#ff9800；文字统一黑色 */
  #autoArrange,
  #smartFillRun,
  #truckManualBtn,
  #wallpaperApply,
  #parseAndImport{
    background: #32f08c !important;
    color: #000 !important;
    border-color: rgba(0,0,0,.18) !important;
  }
  #calc{
    background: #ff9800 !important;
    color: #000 !important;
    border-color: rgba(0,0,0,.20) !important;
  }
  /* 与容器内填选框对齐：按钮设定与输入一致的高度与列宽 */
  #truckManualBtn{
    height: 34px; /* 与通用按钮高度一致 */
    padding: 0 14px; /* 与通用按钮内边距一致 */
    /* 与旁侧 field 列宽严格对齐 */
    width: 180px;
    flex: 0 0 180px;
    box-sizing: border-box;
    /* 与输入框底部对齐，避免视觉上“偏上” */
    align-self: flex-end;
  }
  /* 右栏仪表盘卡片：填充绿色、文字黑色 */
  #dashboardBar .dash-card{
    background: #32f08c !important;
    border-color: rgba(0,0,0,.18) !important;
  }
  #dashboardBar .dash-card .dash-label,
  #dashboardBar .dash-card .dash-value{
    color: #000 !important;
    font-weight: 700 !important;
  }
  /* 通用绿色按钮：背景绿色，文字黑色，边框弱黑 */
  .btn-green{
    background: #32f08c !important;
    color: #000 !important;
    border-color: rgba(0,0,0,.18) !important;
  }
  .btn-green:hover{ filter: brightness(1.06); }
     /* 仅保留 .btn-green 等定点按钮为黑字，移除全局覆盖 */
    </style>
  <style id="smart-fill-responsive">
  /* 智能识别文本框：跟随布局（左栏宽度）一起变大变小 */
  #smartFillInput{
    width: 100%;
    height: clamp(120px, calc(var(--left-w) * 0.35), 340px);
    transition: height .12s ease;
  }
  /* 窄屏时的保护：避免过小高度 */
  @media (max-width: 980px){
    #smartFillInput{ height: clamp(120px, 22vh, 340px); }
  }
</style>
<style id="preset-select-visibility">
  /* 统一为自定义下拉组件，移除原生下拉的强制白底设置（保留为兜底空样式） */

</style>
<style id="ai-badge-gold">
  /* AI 视觉预览徽章：渐变金色 + 黑色不透明文字，并加入闪光效果 */
  .commandbar .badge{
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #ffe082 0%, #ffca28 35%, #ffc107 70%, #ffb300 100%) !important;
    color:#000 !important; /* 黑色不透明文字 */
    border:1px solid rgba(0,0,0,.35);
    font-weight:700;
    isolation: isolate; /* 确保伪元素不会遮挡文本 */
  }
  /* 闪光效果：高亮带缓慢掠过，提升“闪闪发光”的质感 */
  .commandbar .badge::after{
    content:"";
    position:absolute;left:-150%;top:0;width:300%;height:100%;
    background: linear-gradient(120deg, transparent 30%, rgba(255,255,255,.65) 48%, transparent 70%);
    animation: badgeShimmer 2.6s ease-in-out infinite;
    z-index: -1; /* 放到文本后面，避免遮挡 */
    pointer-events:none;
  }
  @keyframes badgeShimmer { 0% { transform: translateX(0); } 100% { transform: translateX(50%); } }
  body.dark .commandbar .badge,
  body.light .commandbar .badge{ background: linear-gradient(135deg, #ffe082 0%, #ffca28 35%, #ffc107 70%, #ffb300 100%) !important; color:#000 !important; }
</style>
<style id="ai-header-center-fix">
  /* 使导航标题居中，同时保留右侧区域 */
  header.commandbar { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; }
  header.commandbar > div:first-child { grid-column: 2; justify-self: center; text-align: center; }
  header.commandbar .right { grid-column: 3; justify-self: end; }

  /* 提升在 Linear 主题下徽章文本颜色的选择器优先级，避免被 Hard Text Reset 覆盖 */
  body.linear header.commandbar .badge { color: #000 !important; }
</style>
 <style id="form-grey">
    /* 全局输入控件灰色样式（扩展各类型，提升覆盖力） */
    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="tel"],
    input[type="url"],
    input[type="search"],
    input[type="password"],
    input[type="file"],
    input:not([type]),
    select,
    textarea{
      background:#eee !important;
      color:#333 !important;
      border-color:#ccc !important;
    }
    /* 主题特定类下也强制灰底 */
    body.dark input, body.dark select, body.dark textarea,
    body.ai input, body.ai select, body.ai textarea,
    body.win11 input, body.win11 select, body.win11 textarea{
      background:#eee !important;
      color:#333 !important;
      border-color:#ccc !important;
    }
    /* 自定义下拉显示统一灰底 */
    .ui-select-display{ background:#eee !important; color:#333 !important; border-color:#ccc !important; }
    /* range 轨道与滑块（尽可能统一灰色） */
    input[type="range"]::-webkit-slider-runnable-track{ background:#eee; height:6px; border-radius:4px; }
    input[type="range"]::-webkit-slider-thumb{ background:#ccc; border:1px solid #999; width:14px; height:14px; border-radius:50%; margin-top:-4px; }
    input[type="range"]{ background:transparent; }
    input[type="range"]::-moz-range-track{ background:#eee; height:6px; border-radius:4px; }
    input[type="range"]::-moz-range-thumb{ background:#ccc; border:1px solid #999; width:14px; height:14px; border-radius:50%; }
  </style>
  <header class="commandbar">
  <div><span id="headerTitle" data-i18n="header.title">🤖 AI 物流排布引擎 · CBM 智能装箱 & 托板 3D</span> <span class="badge" data-i18n="badge.preview">AI 视觉预览</span></div>
  <div class="right">
    <span id="weatherDisplay" class="small" style="margin-right:8px"></span>
    <span id="timeDisplay" class="small"></span>
  </div>
</header>
<main>
  <section class="panel left">
    <div class="category-title ct-base" data-i18n="ct.base">基础设置</div>
    <div class="category-title ct-prod" data-i18n="ct.prod">产品与智能计算</div>
    <div class="category-title ct-reco" data-i18n="ct.reco">推荐与历史</div>
    <div class="category-title ct-theme" data-i18n="ct.theme">外观</div>
    <div class="group cat-lang">
      <div class="group-title"><div class="title-left"><span class="gicon">🌐</span><span data-i18n="lang.title">界面语言</span></div></div>
      <div class="group-body">
        <div class="row">
          <label class="field" style="flex:1 1 220px"><span class="label" data-i18n="lang.choose">选择语言</span>
            <select id="langSelect" data-native-only="true">
              <option value="zh-CN">简体中文</option>
              <option value="zh-TW">繁體中文</option>
              <option value="en">English</option>
              <option value="ar">العربية</option>
              <option value="es">Español</option>
            </select>
          </label>
        </div>
      </div>
    </div>
    <div class="group cat-reco">
      <div class="group-title"><div class="title-left"><span class="gicon">🚚</span><span data-i18n="group.truck">AI 货车推荐</span></div><button class="group-toggle" type="button">折叠</button></div>
      <div class="group-body">
        <div class="row" style="gap:8px;align-items:center;margin-bottom:6px">
          <label class="field" style="flex:0 0 180px"><span class="label" data-i18n="label.manualVol">手动体积(m³)</span>
            <input id="truckManualVol" placeholder="例如 12.5" data-i18n-ph="ph.truckManualVol">
          </label>
          <button id="truckManualBtn" class="btn-secondary" data-i18n="btn.aiRecommend">AI 智能推荐</button>
        </div>
        <div id="truckManualSummary" class="small" style="margin:6px 0"></div>
        <div id="truckManualList"></div>
        <div class="row small" style="align-items:center;justify-content:space-between;color:var(--muted)">
          <span data-i18n="truck.hint">AI 根据外箱总体积智能推荐车辆类型（常见车型近似数据）</span>
          <button id="truckRefresh" class="ghost" data-i18n="btn.refreshAIRecommend">刷新 AI 推荐</button>
        </div>
        <div id="truckRecoSummary" class="small" style="margin:6px 0"></div>
        <div id="truckRecoList"></div>
        <!-- 造型细节设置已移除。驾驶室斜面前脸默认开启，并按车型尺寸自动匹配。 -->
      </div>
    </div>
    <div class="group cat-theme">
<div class="group-title"><div class="title-left"><span class="gicon">🧩</span><span data-i18n="group.other">其他设置</span></div><button class="group-toggle" type="button">折叠</button></div>
      <div class="group-body">
        <div class="row">
          <label class="field" style="flex:1 1 220px"><span class="label" data-i18n="label.themePrimary">主题主色</span>
            <!-- 自定义主题主色已移除 -->
          </label>
        </div>
        <div class="row" style="gap:8px;align-items:center">
          <label class="field" style="flex:1 1 260px"><span class="label" data-i18n="label.wallpaperUrl">壁纸 URL（网络图片）</span>
            <input id="wallpaperUrl" placeholder="例如：https://.../image.jpg" data-i18n-ph="ph.wallpaperUrl" />
          </label>
          <label class="field" style="flex:0 0 220px"><span class="label" data-i18n="label.localImage">本地图片</span>
            <button id="wallpaperFileBtn" type="button" class="btn-secondary" data-i18n="btn.chooseFile">选择文件</button>
            <span id="wallpaperFileName" class="small" style="margin-left:6px;color:var(--muted)" data-i18n="file.none">未选择任何文件</span>
            <input id="wallpaperFile" type="file" accept="image/*" style="display:none" aria-hidden="true" />
          </label>
        </div>
        <div class="row" style="gap:8px;align-items:center">
          <button id="wallpaperApply" class="btn-secondary" data-i18n="btn.applyWallpaper">应用壁纸</button>
          <button id="wallpaperClear" class="ghost" data-i18n="btn.clearWallpaper">清除壁纸</button>
          <span class="small" style="color:var(--muted)" data-i18n="hint.wallpaper">提示：壁纸将以“覆盖+居中”方式铺设，滚动时保持固定。</span>
        </div>
        <div class="row" style="gap:8px;align-items:center;margin-top:8px">
          <label class="field" style="flex:0 0 160px"><span class="label" data-i18n="label.weatherFreq">天气刷新频率（分钟）</span>
            <input id="weatherFreq" placeholder="例如：30" data-i18n-ph="ph.weatherFreq" />
          </label>
          <label class="field" style="flex:1 1 240px"><span class="label" data-i18n="label.weatherCityManual">备用/手动城市</span>
            <input id="weatherCity" placeholder="例如：上海 或 Shenzhen" data-i18n-ph="ph.weatherCity" />
          </label>
          <label class="field" style="flex:0 0 160px"><span class="label" data-i18n="label.windUnit">风速单位</span>
            <select id="weatherWindUnit"><option value="mps">m/s</option><option value="kmh">km/h</option></select>
          </label>
          <button id="weatherRefresh" class="ghost" data-i18n="btn.refreshWeather">刷新天气</button>
        </div>
      </div>
    </div>
    <div class="group cat-base">
<div class="group-title"><div class="title-left"><span class="gicon">🧑‍💼</span><span data-i18n="group.customer">客户信息</span></div><button class="group-toggle" type="button">折叠</button></div>
      <div class="group-body">
        <div class="row">
          <input id="customerName" placeholder="客户名称" data-i18n-ph="ph.customerName"/>
        </div>
        <div class="row" style="gap:8px">
          <input id="customerContact" placeholder="联系人" data-i18n-ph="ph.customerContact"/>
          <input id="customerPhone" placeholder="联系电话" data-i18n-ph="ph.customerPhone"/>
          <input id="customerEmail" placeholder="电子邮箱" data-i18n-ph="ph.customerEmail"/>
          <input id="customerWechat" placeholder="微信/QQ（可选）" data-i18n-ph="ph.customerWechat"/>
        </div>
      </div>
    </div>

    <div class="group cat-base">
      <div class="group-title"><div class="title-left"><span class="gicon">📦</span><span data-i18n="group.box">AI 外箱参数</span></div><button class="group-toggle" type="button">折叠</button></div>
      <div class="group-body">
        <div class="subgroup">
          <div class="sub-title" data-i18n="box.dimUnit">尺寸与单位</div>
          <div class="row">
            <input id="cL" placeholder="箱长 L" data-i18n-ph="ph.boxL"/>
            <input id="cW" placeholder="箱宽 W" data-i18n-ph="ph.boxW"/>
            <input id="cH" placeholder="箱高 H" data-i18n-ph="ph.boxH"/>
            <select id="unitSelect"><option value="mm" data-i18n="unit.mm">mm</option><option value="cm" data-i18n="unit.cm">cm</option><option value="m" data-i18n="unit.m">m</option></select>
            <label class="small" style="margin-left:8px" data-i18n="box.volUnitLabel">体积单位</label>
            <select id="volUnit"><option value="m3" data-i18n="option.m3">立方米 (m³)</option><option value="cm3" data-i18n="option.cm3">立方厘米 (cm³)</option></select>
          </div>
          <div class="row">
            <label class="field" style="flex:1 1 220px;min-width:220px">
              <span class="label" data-i18n="box.commonLabel">常见外箱</span>
              <div class="row" style="gap:8px;align-items:center">
                <select id="boxPreset" style="flex:1 1 220px">
                  <option value="" data-i18n="box.commonSelectPlaceholder">选择常见外箱尺寸…</option>
                  <option value="600x450x330" data-i18n="boxPreset.600x450x330">600×450×330（标准）</option>
                  <option value="530x430x300" data-i18n="boxPreset.530x430x300">530×430×300（常用）</option>
                  <option value="500x400x300" data-i18n="boxPreset.500x400x300">500×400×300（常用）</option>
                  <option value="400x300x250" data-i18n="boxPreset.400x300x250">400×300×250（常用）</option>
                  <option value="350x250x200" data-i18n="boxPreset.350x250x200">350×250×200（常用）</option>
                </select>
                <button id="addBoxPreset" class="ghost" type="button" data-i18n="btn.addPreset">添加为预设</button>
              </div>
            </label>
          </div>
        </div>
        <div class="subgroup">
          <div class="sub-title" data-i18n="box.weightMix">重量与混装</div>
          <div class="row">
            <label class="small" style="display:flex;align-items:center;gap:6px;min-width:220px"><input type="checkbox" id="weightFeatureToggle"> <span data-i18n="label.enableWeight">是否启用重量功能</span></label>
            <label class="small" style="display:flex;align-items:center;gap:6px;min-width:220px"><input type="checkbox" id="mixToggle"> <span data-i18n="label.allowMix">允许不同产品混装</span></label>
          </div>
          <div class="row hidden" id="weightLimitRow">
            <div class="field" style="flex:1 1 220px;min-width:220px">
              <span class="label" data-i18n="label.maxWeight">最大重量</span>
              <div style="display:flex;gap:8px;align-items:center">
                <input id="maxWeight" placeholder="最大重量" value="30" data-i18n-ph="ph.maxWeight"/>
                <select id="maxWeightUnit"><option value="kg" data-i18n="unit.kg">kg</option><option value="g" data-i18n="unit.g">g</option><option value="jin" data-i18n="unit.jin">斤</option></select>
              </div>
            </div>
          </div>
        </div>
        <div class="subgroup">
          <div class="sub-title" data-i18n="box.visualWireframe">可视化与线框</div>
          <div class="row">
            <label class="small" style="display:flex;align-items:center;gap:6px;min-width:220px"><input type="checkbox" id="paramTextToggle" checked> <span data-i18n="label.showParamInViewport">显示参数（图窗内）</span></label>
            <label class="small" style="display:flex;align-items:center;gap:6px;min-width:220px"><input type="checkbox" id="product3DTextToggle" checked> <span data-i18n="label.showProduct3DText">显示产品3D文字</span></label>
            <div class="field" style="flex:1 1 220px;min-width:220px">
              <span class="label" data-i18n="label.wireframeColor">外箱线框颜色</span>
              <div class="swatch-grid" data-for="boxColor"></div>
<input type="color" id="boxColor" value="#ffffff" class="hidden-color">
            </div>
          </div>
        </div>
        <div class="subgroup">
          <div class="sub-title" data-i18n="box.packCategory">分类打包</div>
          <div class="row">
            <label class="small" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="classPasteOnly"> <span data-i18n="box.packPasteOnly">膏体分类打包</span></label>
            <label class="small" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="classHazOnly"> <span data-i18n="box.packHazOnly">带电/带磁分类打包</span></label>
          </div>
        </div>
      </div>
    </div>

    <div class="group cat-base">
      <div class="group-title"><div class="title-left"><span class="gicon">🧱</span><span data-i18n="group.pallet">托板参数</span></div><button class="group-toggle" type="button">折叠</button></div>
      <div class="group-body">
        <div class="row">
          <input id="pL" placeholder="托板长 L" data-i18n-ph="ph.palletL"/>
          <input id="pW" placeholder="托板宽 W" data-i18n-ph="ph.palletW"/>
          <input id="pH" placeholder="最大堆高 H（可选）" data-i18n-ph="ph.palletH"/>
          <span class="small" data-i18n="pallet.unitSame">单位与外箱一致</span>
        </div>
        <div class="row">
          <label class="field" style="flex:1 1 220px;min-width:220px">
            <span class="label" data-i18n="pallet.commonLabel">常见尺寸</span>
            <div class="row" style="gap:8px;align-items:center">
            <select id="pPreset" style="flex:1 1 220px">
              <option value="" data-i18n="pallet.commonSelectPlaceholder">选择常见托板尺寸…</option>
              <option value="1200x1000" data-i18n="pPreset.1200x1000">1200×1000（ISO/常用）</option>
              <option value="1200x800" data-i18n="pPreset.1200x800">1200×800（欧标 EUR）</option>
              <option value="1100x1100" data-i18n="pPreset.1100x1100">1100×1100（亚洲常用）</option>
              <option value="1140x1140" data-i18n="pPreset.1140x1140">1140×1140（亚洲常用）</option>
              <option value="1219x1016" data-i18n="pPreset.1219x1016">1219×1016（美标 48×40in）</option>
              <option value="1000x1000" data-i18n="pPreset.1000x1000">1000×1000（通用）</option>
            </select>
            <button id="addPalletPreset" class="ghost" type="button" data-i18n="btn.addPreset">添加为预设</button>
            </div>
          </label>
        </div>
        <div class="row">
          <label class="field"><span class="label" data-i18n="label.layoutPattern">铺设策略</span>
            <select id="pPattern">
              <option value="auto" data-i18n="pPattern.auto">自动选择</option>
              <option value="grid" data-i18n="pPattern.grid">标准网格</option>
              <option value="stagger" data-i18n="pPattern.stagger">错位铺设</option>
              <option value="altRotate" data-i18n="pPattern.altRotate">交错旋转</option>
            </select>
          </label>
          <label class="field"><span class="label" data-i18n="label.marginX">边距X</span><input id="pMarginX" placeholder="如：10" data-i18n-ph="ph.eg10"/></label>
          <label class="field"><span class="label" data-i18n="label.marginY">边距Y</span><input id="pMarginY" placeholder="如：10" data-i18n-ph="ph.eg10"/></label>
          <label class="field"><span class="label" data-i18n="label.gap">间距</span><input id="pGap" placeholder="如：0" data-i18n-ph="ph.eg0"/></label>
          <label class="field" style="flex:1 1 220px"><span class="label" data-i18n="label.palletColor">托板颜色</span>
            <div class="swatch-grid" data-for="palletColor"></div>
            <input type="color" id="palletColor" value="#8d6e63" class="hidden-color">
          </label>
        </div>
      </div>
    </div>

    <div class="group cat-prod">
      <div class="group-title"><div class="title-left"><span class="gicon">🛒</span><span data-i18n="group.product">产品参数</span></div><button class="group-toggle" type="button">折叠</button></div>
      <div class="group-body">
        <div class="product-list" id="productList"></div>
        <div class="row" style="margin-top:6px">
          <button id="addProduct" data-i18n="btn.addProduct">添加产品</button>
          <button id="calc" data-i18n="btn.calc">AI 计算装箱</button>
          <button id="autoArrange" class="btn-secondary" data-i18n="btn.autoArrange">AI 自动整理摆放</button>
          <button id="clearAll" class="ghost" data-i18n="btn.clearAll">清空全部</button>
          <button id="exportCSV" class="ghost" data-i18n="btn.exportCSV">导出产品/结果 CSV</button>
          <button id="exportHistoryCSV" class="ghost" data-i18n="btn.exportHistoryCSV">导出全部记录 CSV</button>
        </div>
        <div class="smart-fill" style="margin-top:8px">
          <label class="small" data-i18n="smartFill.title">AI 识别内容自动填入（每行一个产品）</label>
          <div class="row small" style="align-items:center;color:var(--muted);gap:6px;margin:6px 0">
            <span class="chip" data-i18n="chip.name">名称</span>
            <span class="chip" data-i18n="chip.len">长(L)</span>
            <span class="chip" data-i18n="chip.width">宽(W)</span>
            <span class="chip" data-i18n="chip.height">高(H)</span>
            <span class="chip" data-i18n="chip.qty">数量</span>
            <span class="chip" data-i18n="chip.weight">重量</span>
            <span class="chip" data-i18n="chip.unit">单位 kg/g</span>
            <span class="chip" data-i18n="chip.type">类型</span>
            <span class="chip" data-i18n="chip.color">颜色</span>
          </div>
          <textarea id="smartFillInput" rows="5" placeholder="示例：\nA001 600 450 330 10 0.5 kg normal #34a853\n或 L:600 W:450 H:330 数量:10 重量:0.5kg 类型:膏体 颜色:#1a73e8" data-i18n-ph="ph.smartFill"></textarea>
          <div class="row" style="gap:8px;margin-top:6px;flex-wrap:wrap">
            <button id="smartFillRun" class="btn-secondary" data-i18n="btn.smartFillRun">识别并填入</button>
            <button id="smartFillSample1" class="ghost" data-i18n="btn.smartFillSample1">填充示例一</button>
            <button id="smartFillSample2" class="ghost" data-i18n="btn.smartFillSample2">填充示例二</button>
            <button id="smartFillClear" class="ghost" data-i18n="btn.smartFillClear">清空输入</button>
          </div>
          <div id="smartFillStatus" class="small" style="margin-top:6px;color:var(--muted)"></div>
        </div>
      </div>
    </div>

    <div class="group cat-reco">
      <div class="group-title"><div class="title-left"><span class="gicon">📝</span><span data-i18n="group.history">记录历史</span></div><button class="group-toggle" type="button">折叠</button></div>
      <div class="group-body">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div class="row">
            <button id="saveHistoryBtn" class="ghost" data-i18n="btn.saveHistory">保存当前为历史</button>
            <button id="deleteLatestHistory" class="ghost" data-i18n="btn.deleteLatestHistory">删除最新一条</button>
            <button id="clearHistoryAll" class="ghost" data-i18n="btn.clearHistoryAll">清空全部历史</button>
            <button id="wipeHistoryAll" class="ghost" data-i18n="btn.wipeHistoryAll">一键删除所有历史</button>
          </div>
        </div>
        <div id="historyList"></div>
        <pre id="result" class="small"></pre>
      </div>
    </div>
  </section>

  <div id="splitter" class="splitter" title="拖动改变左侧参数区宽度"></div>

  <section class="panel right">
    <h3 class="h" data-i18n="viewer.title">AI 3D 排布视图（首行固定托板 + 每托板 + 总览 + 每箱）</h3>
    <div id="viewerToolbar"></div>
    <div id="dashboardBar" class="dash-grid">
      <div class="dash-card"><div class="dash-label" data-i18n="dash.totalBoxes">总箱数</div><div class="dash-value" id="dashTotalBoxes">—</div></div>
      <div class="dash-card"><div class="dash-label" data-i18n="dash.perPallet">每托板件数</div><div class="dash-value" id="dashPerPallet">—</div></div>
      <div class="dash-card"><div class="dash-label" data-i18n="dash.totalVol">总体积</div><div class="dash-value" id="dashTotalVol">—</div></div>
      <div class="dash-card"><div class="dash-label" data-i18n="dash.truckReco">AI 推荐车型</div><div class="dash-value" id="dashTruckName">—</div></div>
    </div>
    <div id="viewerStack"></div>
  </section>
</main>

<button id="backTop" title="回到顶部" data-i18n-title="title.backTop" data-i18n="btn.backTop">↑ 顶部</button>

<script>
// 全局 AI 指示器
document.addEventListener('DOMContentLoaded',()=>{
  try{
    // 启用 AI 玻璃态主题（可与 light/dark 并存）
    document.body.classList.add('ai');
    const w=document.createElement('div'); w.className='ai-widget'; w.id='aiWidget';
    w.innerHTML=`<span class='ai-icon'>🤖</span><span class='ai-spinner'></span><span class='ai-text'><span id='aiStatus'>就绪</span></span><span class='ai-pulse'></span><span class='ai-progress'></span>`;
    document.body.appendChild(w);
    try{ const h=Math.round(w.getBoundingClientRect().height); document.body.classList.add('has-ai-widget'); document.body.style.setProperty('--ai-widget-h', h+'px'); }catch(e){}
    const top=document.createElement('div'); top.id='aiTopBar'; document.body.appendChild(top);
    // 为重型按钮统一添加AI按钮样式
    const heavyIds=['calc','autoArrange','truckManualBtn','truckRefresh','smartFillRun','parseAndImport'];
    heavyIds.forEach(id=>{const el=document.getElementById(id); if(el){ el.classList.add('btn-ai'); }});

    // AI Dock bottom sheet for DeepSeek Chat
    if(!document.getElementById('aiDock')){
      const dock=document.createElement('div'); dock.id='aiDock'; dock.className='ai-dock';
      dock.innerHTML=`
        <div class="bar">
          <div class="title" data-i18n="ai.dock.title">🧠 AI Chat Dock</div>
          <div class="actions">
          </div>
        </div>
        <iframe id="aiDockFrame" src="" referrerpolicy="no-referrer"></iframe>
        <div id="aiDockFallback" class="dock-fallback">
          <div class="hint" data-i18n="ai.dock.fallbackHint">该站点可能不支持站内嵌入，已在新标签页打开当前地址。</div>
          <div class="row">
            <a id="aiDockLink" href="#" target="_blank" rel="noopener" style="font-size:12px"></a>
          </div>
        </div>
      `;
      document.body.appendChild(dock);
      try{ if(window.__i18n && window.__i18n.apply){ window.__i18n.apply(window.__i18n.getLang()); } }catch(_){}
    }
    try{
      const w=document.getElementById('aiWidget');
      const icon=w? w.querySelector('.ai-icon'): null;
      const dock=document.getElementById('aiDock');
      const frame=document.getElementById('aiDockFrame');
      const fb=document.getElementById('aiDockFallback');
      const fbLink=document.getElementById('aiDockLink');
      const btnExternal=document.getElementById('aiDockExternal');
      const btnSettings=document.getElementById('aiDockSettings');
      let frameInit=false; let frameLoaded=false; let frameTimer=null;

      function getDockUrl(){
        let u = (localStorage.getItem('ai:dockUrl')||'').trim();
        if(!u){ u = 'https://www.doubao.com/chat/'; }
        if(!/^https?:\/\//i.test(u)){ u = 'https://'+u; }
        return u;
      }
      function openInNewTab(u){ try{ window.open(u,'_blank'); }catch(e){} }
      function syncFallbackLink(){ if(fbLink){ const u=getDockUrl(); fbLink.href=u; fbLink.textContent=u; } }

      function openDock(){
        dock.classList.add('open');
        // 默认显示 iframe（若后续加载失败再显示兜底）
        if(fb){ fb.style.display='none'; }
        if(frame){ frame.style.display=''; }
        syncFallbackLink();
      }
      function closeDock(){ dock.classList.remove('open'); }
      function toggleDock(){ if(dock.classList.contains('open')) closeDock(); else openDock(); }

      if(w){ w.addEventListener('click',(e)=>{ e.stopPropagation(); const willOpen = !dock.classList.contains('open'); toggleDock();
        if(willOpen && !frameInit){
          frameInit=true;
          // 先尝试内嵌 iframe，若在限定时间内未加载成功或报错，则显示兜底并在新标签打开
          if(fb){ fb.style.display='none'; }
          if(frame){ frame.style.display=''; }
          const url=getDockUrl();
          frame.src=url;
          clearTimeout(frameTimer);
          frameLoaded=false;
          frameTimer=setTimeout(()=>{
            if(!frameLoaded){ if(fb){ fb.style.display='block'; } if(frame){ frame.style.display='none'; } openInNewTab(url); }
          }, 1600);
          frame.addEventListener('load',()=>{ frameLoaded=true; if(fb){ fb.style.display='none'; } if(frame){ frame.style.display=''; } });
          frame.addEventListener('error',()=>{ if(fb){ fb.style.display='block'; } if(frame){ frame.style.display='none'; } openInNewTab(url); });
        }
      }); }
      if(btnClose){ btnClose.addEventListener('click',(e)=>{ e.stopPropagation(); closeDock(); }); }
      if(btnExternal){ btnExternal.addEventListener('click',(e)=>{ e.stopPropagation(); openInNewTab(getDockUrl()); }); }
      if(btnOpenAgain){ btnOpenAgain.addEventListener('click',(e)=>{ e.stopPropagation(); openInNewTab(getDockUrl()); }); }
      if(btnSettings){ btnSettings.addEventListener('click',(e)=>{ e.stopPropagation(); const cur=getDockUrl(); const input=prompt('输入支持内嵌的地址（建议 https:// 开头）', cur); if(input){ localStorage.setItem('ai:dockUrl', input.trim()); syncFallbackLink(); frameInit=false; frameLoaded=false; if(dock.classList.contains('open')){ // 重新尝试加载
            if(fb){ fb.style.display='block'; } if(frame){ frame.style.display='none'; }
            openInNewTab(getDockUrl());
            frame.src=getDockUrl();
          } } }); }
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ closeDock(); } });
    }catch(e){}
  }catch(e){}
});
function setAIBusy(busy=true,msg){
  try{
    const w=document.getElementById('aiWidget'); if(!w) return;
    w.classList.toggle('busy',!!busy);
    const st=document.getElementById('aiStatus'); if(st){ st.textContent=(msg|| (busy?'计算中…':'就绪')); }
    window.__lastAIMsg=msg|| (busy?'计算中…':'就绪');
    const top=document.getElementById('aiTopBar'); if(top){ top.classList.toggle('active',!!busy); }
    // 更新AI指示器高度，避免与回到顶部重叠
    try{ const h=Math.round(w.getBoundingClientRect().height); document.body.classList.add('has-ai-widget'); document.body.style.setProperty('--ai-widget-h', h+'px'); }catch(e){}
  }catch(e){}
}
// 按真实耗时动态控制忙碌展示（支持同步/异步任务）
async function runWithAIBusy(task, opts){
  const o=Object.assign({msg:'计算中…',minMs:600,btn:null,btnText:null},opts||{});
  const start=Date.now();
  // 标记一次重型AI操作，供渲染完成时触发一次性提示，不影响交互刷新
  window.__aiOpActive = true;
  setAIBusy(true,o.msg);
  // 按钮级忙碌样式与文案
  const btn=o.btn;
  if(btn){
    btn.classList.add('busy');
    btn.disabled=true;
    if(!btn.querySelector('.btn-progress')){btn.insertAdjacentHTML('beforeend',"<span class='btn-progress'></span><span class='btn-spinner'></span>");}
    btn.dataset.origText=btn.textContent;
    if(o.btnText){btn.textContent=o.btnText;}
  }
  try{
    const ret=task();
    await Promise.resolve(ret);
    return ret;
  }finally{
    const elapsed=Date.now()-start;
    const wait=Math.max(0,(o.minMs||0)-elapsed);
    setTimeout(()=>{
      setAIBusy(false,'就绪');
      if(btn){
        btn.classList.remove('busy');
        btn.disabled=false;
        if(btn.dataset && btn.dataset.origText){btn.textContent=btn.dataset.origText;}
      }
    },wait);
  }
}
// 计算按钮涟漪特效
function flashCalcEffect(btn){
  if(!btn) return;
  const ripple=document.createElement('span');
  ripple.className='btn-ripple';
  btn.appendChild(ripple);
  ripple.addEventListener('animationend',()=>{ripple.remove();});
}
// 完成提示Toast
function showCompletionToast(text){
  try{
    const toast=document.createElement('div'); toast.className='ai-toast'; toast.textContent=text||'完成';
    document.body.appendChild(toast);
    requestAnimationFrame(()=>toast.classList.add('show'));
    setTimeout(()=>{toast.classList.remove('show'); setTimeout(()=>toast.remove(),280);},1600);
  }catch(e){}
}
// 针对主要计算/推荐操作的通用钩子（点击即展示忙碌动画，计算结束后恢复）
document.addEventListener('click',(e)=>{
  const t=e.target; const id=t&&t.id;
  const heavyIds=['calc','autoArrange','truckManualBtn','truckRefresh','smartFillRun','parseAndImport'];
  if(heavyIds.includes(id) && !(t && t.dataset && t.dataset.aiManaged==='true')){
    window.__aiOpActive = true;
    setAIBusy(true,'计算中…');
    // 简单兜底：短暂忙碌，随后自动恢复；真正渲染完成时也会恢复
    setTimeout(()=>setAIBusy(false,'就绪'),1200);
  }
});
// 当场景渲染完成时，恢复为就绪（若存在 renderScene 刷新）
try{
  if(typeof renderScene==='function'){
    const _rs=renderScene; window.renderScene=function(){ const r=_rs.apply(this,arguments);
      try{
        if (window.__aiOpActive){
          setAIBusy(false,'就绪');
          document.querySelectorAll('.viewer').forEach(v=>{ v.classList.add('flash'); setTimeout(()=>v.classList.remove('flash'),600); });
          showCompletionToast('AI 计算完成');
          window.__aiOpActive = false;
        }
      }catch(e){}
      return r;
    };
  }
}catch(e){}
function updateTime(){document.getElementById('timeDisplay').textContent=new Date().toLocaleString();}
setInterval(updateTime,1000);updateTime();

function initGroupToggles(){
  const getUILangSafe = ()=> (window.__i18n && window.__i18n.getLang && window.__i18n.getLang()) || (localStorage.getItem('uiLang')||'zh-CN');
  document.querySelectorAll('.group').forEach(g=>{
    const btn=g.querySelector('.group-toggle');
    if(!btn) return;
    // 产品参数分组保留按钮，但默认展开且覆盖初始折叠状态
    if(g.classList.contains('cat-prod')){
      g.classList.remove('collapsed');
      { const t=(window.__i18n && window.__i18n.t)?window.__i18n.t:((k)=>k); btn.textContent=(t('btn.collapse')||'折叠'); }
      try{ localStorage.setItem('collapsed:产品参数','0'); }catch(e){}
    }
    const labelEl=g.querySelector('.group-title .title-left span:last-child');
    const key=(labelEl?labelEl.textContent: (g.querySelector('.group-title')?.textContent||'group')).trim();
    const storageKey='collapsed:'+key;
    if(localStorage.getItem(storageKey)==='1'){ g.classList.add('collapsed'); { const t=(window.__i18n && window.__i18n.t)?window.__i18n.t:((k)=>k); btn.textContent=(t('btn.expand')||'展开'); } }
    btn.addEventListener('click',()=>{
      g.classList.toggle('collapsed');
      { const t=(window.__i18n && window.__i18n.t)?window.__i18n.t:((k)=>k); btn.textContent = g.classList.contains('collapsed') ? (t('btn.expand')||'展开') : (t('btn.collapse')||'折叠'); }
      localStorage.setItem(storageKey, g.classList.contains('collapsed') ? '1' : '0');
    });
  });
}
initGroupToggles();

(function(){const root=document.documentElement;const splitter=document.getElementById('splitter');
  let startX=0,startW=0,drag=false;const saved=localStorage.getItem('leftW');if(saved){root.style.setProperty('--left-w',saved+'px');}
  function onMove(e){if(!drag) return;const dx=e.clientX-startX;const nw=Math.max(320,Math.min(900,startW+dx));root.style.setProperty('--left-w',nw+'px');}
  function onUp(){if(!drag) return;drag=false;document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);const cur=parseInt(getComputedStyle(root).getPropertyValue('--left-w'));localStorage.setItem('leftW',cur);}
  splitter.addEventListener('mousedown',e=>{drag=true;startX=e.clientX;startW=parseInt(getComputedStyle(root).getPropertyValue('--left-w'))||520;document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onUp);e.preventDefault();});
})();

// 回到顶部按钮逻辑
(function(){
  const btn=document.getElementById('backTop'); if(!btn) return;
  function sync(){btn.style.display=(window.scrollY>240)?'block':'none';}
  addEventListener('scroll',sync,{passive:true}); sync();
  btn.addEventListener('click',()=>{window.scrollTo({top:0,behavior:'smooth'});});
})();

// 天气显示（定位/手动城市 + Open-Meteo + 定时刷新/单位切换）
let __WEATHER_TIMER=null;
async function initWeather(){
  const el=document.getElementById('weatherDisplay'); if(!el) return;
  const setTxt=(t)=>{el.textContent=t;};
  const cityInp=document.getElementById('weatherCity');
  const freqInp=document.getElementById('weatherFreq');
  const unitSel=document.getElementById('weatherWindUnit');
  const freqMin=parseInt((freqInp&&freqInp.value)||localStorage.getItem('weather:freq')||'30',10)||30;
  const city=(cityInp&&cityInp.value)||localStorage.getItem('weather:city')||'';
  const unit=(unitSel&&unitSel.value)||localStorage.getItem('weather:unit')||'mps';
  try{localStorage.setItem('weather:freq',String(freqMin));localStorage.setItem('weather:city',city);localStorage.setItem('weather:unit',unit);}catch(e){}
  if(__WEATHER_TIMER){clearInterval(__WEATHER_TIMER); __WEATHER_TIMER=null;}
  setTxt('正在获取天气…');
  function windDirName(deg){const d=((deg%360)+360)%360;const names=['北','东北','东','东南','南','西南','西','西北','北'];const idx=Math.round(d/45);return names[idx]||'未知';}
  function iconByCode(code){const m={0:'☀️',1:'🌤️',2:'⛅',3:'☁️',45:'🌫️',48:'🌫️',51:'🌦️',53:'🌦️',55:'🌧️',61:'🌧️',63:'🌧️',65:'🌧️',66:'🌨️',67:'🌨️',71:'🌨️',73:'🌨️',75:'❄️',77:'❄️',80:'🌧️',81:'🌧️',82:'⛈️',85:'❄️',86:'❄️',95:'⛈️',96:'⛈️',99:'⛈️'};return m[code]||'⛅';}
  function fetchWeather(lat,lon){return fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`).then(r=>r.json());}
  async function geocodeCity(name){
    try{const j=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=zh&format=json`).then(r=>r.json());const r=j&&j.results&&j.results[0];if(r) return {lat:r.latitude,lon:r.longitude,label:`${r.name}${r.admin1?('·'+r.admin1):''}`};}catch(e){}
    return null;
  }
  function windDescByMps(s){if(s<3) return '微风'; if(s<6) return '和风'; if(s<10) return '强风'; return '大风';}
  async function showByLatLon(lat,lon,place){
    try{
      const data=await fetchWeather(lat,lon);
      const cw=data&&data.current_weather; if(!cw){setTxt('天气数据不可用'); return;}
      const spdMps=parseFloat(cw.windspeed)||0; const spd=(unit==='kmh')?(spdMps*3.6):spdMps; const spdTxt=spd.toFixed(1)+(unit==='kmh'?'km/h':'m/s');
      const text=`${iconByCode(cw.weathercode)} ${cw.temperature.toFixed(0)}°C · ${windDirName(cw.winddirection)}风 ${spdTxt}${'（'+windDescByMps(spdMps)+'）'}${place?(' · '+place):''}`;
      setTxt(text);
      try{localStorage.setItem('weather:lastLat',String(lat));localStorage.setItem('weather:lastLon',String(lon));}catch(e){}
    }catch(e){setTxt('天气加载失败');}
  }
  try{
    if(city && city.trim()){
      const g=await geocodeCity(city.trim()); if(g){ await showByLatLon(g.lat,g.lon,g.label); } else { setTxt('城市解析失败，尝试定位…'); }
    }
    if(!el.textContent || /失败|不可用|解析/.test(el.textContent)){
      await new Promise((resolve)=>{
        if(!navigator.geolocation){resolve('NO_GEO');return;}
        navigator.geolocation.getCurrentPosition(async(pos)=>{ const {latitude:lat,longitude:lon}=pos.coords||{}; await showByLatLon(lat,lon); resolve(); },
          async(err)=>{ const lastLat=parseFloat(localStorage.getItem('weather:lastLat')); const lastLon=parseFloat(localStorage.getItem('weather:lastLon'));
            if(!isNaN(lastLat)&&!isNaN(lastLon)){ await showByLatLon(lastLat,lastLon,'上次定位'); resolve('CACHED'); return; }
            const g=await geocodeCity('上海'); if(g){ await showByLatLon(g.lat,g.lon,g.label); } else { setTxt('天气不可用'); }
            resolve('NO_GEO'); },{enableHighAccuracy:false,timeout:8000,maximumAge:600000});
      });
    }
  }catch(e){ setTxt('天气模块异常'); }
  __WEATHER_TIMER=setInterval(()=>{ initWeather(); }, Math.max(1,freqMin)*60000);
}

function initWeatherSettingsUI(){
  const freqInp=document.getElementById('weatherFreq'); const cityInp=document.getElementById('weatherCity'); const unitSel=document.getElementById('weatherWindUnit'); const btn=document.getElementById('weatherRefresh');
  if(freqInp){const v=localStorage.getItem('weather:freq'); if(v) freqInp.value=v; freqInp.addEventListener('input',()=>{try{localStorage.setItem('weather:freq',freqInp.value||'30');}catch(e){}});} 
  if(cityInp){const v=localStorage.getItem('weather:city'); if(v) cityInp.value=v; cityInp.addEventListener('change',()=>{try{localStorage.setItem('weather:city',cityInp.value||'');}catch(e){} initWeather();});}
  if(unitSel){const v=localStorage.getItem('weather:unit'); if(v) unitSel.value=v; unitSel.addEventListener('change',()=>{try{localStorage.setItem('weather:unit',unitSel.value||'mps');}catch(e){} initWeather();});}
  if(btn){btn.addEventListener('click',()=>initWeather());}
}

/************** 色板 **************/
// 扩展调色板：提供更多高区分度颜色（含亮/暗/冷/暖），白色不参与自动分配
const PALETTE=[
  '#1a73e8','#34a853','#fbbc05','#ea4335','#8e67f0','#00acc1','#ff6d00','#795548','#607d8b','#111111','#ffffff',
  // 进一步扩展（Material/常用可视化色系的近邻色，统一小写）
  '#3f51b5','#9c27b0','#673ab7','#2196f3','#03a9f4','#00bcd4','#009688','#4caf50','#8bc34a','#cddc39',
  '#ffeb3b','#ffc107','#ff9800','#ff5722','#9e9e9e','#e91e63','#f06292','#ba68c8','#9575cd','#7986cb',
  '#64b5f6','#4db6ac','#81c784','#aed581','#dce775','#fff176','#ffd54f','#ffb74d','#ff8a65','#a1887f',
  '#eeeeee','#455a64','#2e7d32','#c62828','#ad1457','#283593','#1565c0','#00838f','#00695c','#558b2f',
  '#f9a825','#ef6c00','#8d6e63','#37474f'
];
const COLOR_POOL=PALETTE.filter(c=>c!=='#ffffff');
function buildPalette(grid,input){
  grid.innerHTML='';
  const cur=(input.value||'').toLowerCase();
  PALETTE.forEach(col=>{const sw=document.createElement('button');sw.type='button';sw.className='swatch';sw.style.background=col;if(col.toLowerCase()===cur) sw.classList.add('selected');sw.onclick=()=>{input.value=col;grid.querySelectorAll('.swatch').forEach(s=>s.classList.remove('selected'));sw.classList.add('selected');input.dispatchEvent(new Event('input'));renderScene();};grid.appendChild(sw);});
  const plus=document.createElement('button');plus.type='button';plus.className='swatch plus';plus.title='自定义颜色';
  plus.onclick=(ev)=>{
    ev.stopPropagation();
    // 若已存在弹窗，先移除
    grid.querySelectorAll('.color-popover').forEach(p=>p.remove());
    const pop=document.createElement('div'); pop.className='color-popover';
    const initHex=(input.value||'#1a73e8');
    // 初始 HSL 值（若可解析则用当前颜色）
    let initH=0,initS=65,initL=55;
    try{ const {r,g,b}=hexToRgb(initHex); const hsl=rgbToHsl(r,g,b); initH=hsl.h; initS=hsl.s; initL=hsl.l; }catch(e){}
    pop.innerHTML=`
      <div class="preview"></div>
      <div class="ctrl"><label>色相</label><input class="h" type="range" min="0" max="360" value="${initH}"></div>
      <div class="ctrl"><label>饱和</label><input class="s" type="range" min="0" max="100" value="${initS}"></div>
      <div class="ctrl"><label>亮度</label><input class="l" type="range" min="0" max="100" value="${initL}"></div>
      <div class="hex"></div>
      <div class="row"><button class="btn-apply">确定</button><button class="btn-cancel ghost">取消</button></div>
    `;
    const prev=pop.querySelector('.preview'); const hexEl=pop.querySelector('.hex');
    const hInp=pop.querySelector('.h'), sInp=pop.querySelector('.s'), lInp=pop.querySelector('.l');
    const update=()=>{ const hex=hslToHex(hInp.value,sInp.value,lInp.value); prev.style.background=hex; hexEl.textContent=hex; };
    hInp.addEventListener('input',update); sInp.addEventListener('input',update); lInp.addEventListener('input',update); update();
    pop.querySelector('.btn-apply').onclick=()=>{ const hex=hslToHex(hInp.value,sInp.value,lInp.value); input.value=hex; input.dispatchEvent(new Event('input')); grid.querySelectorAll('.color-popover').forEach(p=>p.remove()); };
    pop.querySelector('.btn-cancel').onclick=()=>{ grid.querySelectorAll('.color-popover').forEach(p=>p.remove()); };
    // 定位到加号按钮下方
    const gb=grid.getBoundingClientRect(); const pb=plus.getBoundingClientRect();
    const left=Math.max(0,pb.left-gb.left); const top=Math.max(0,pb.top-gb.top+plus.offsetHeight+6);
    pop.style.left=`${left}px`; pop.style.top=`${top}px`;
    grid.appendChild(pop);
    // 外部点击关闭
    const onDocClick=(e)=>{ if(!pop.contains(e.target) && e.target!==plus){ pop.remove(); document.removeEventListener('mousedown',onDocClick,true); } };
    setTimeout(()=>document.addEventListener('mousedown',onDocClick,true),0);
  };
  grid.appendChild(plus);
  // 仅在产品颜色面板中添加“原生颜色选择器”兜底按钮
  try{
    if(grid.dataset && grid.dataset.for==='pcolor'){
      const native=document.createElement('input');
      native.type='color'; native.className='color-native'; native.title='系统颜色选择器';
      native.value=(input.value||'#1a73e8');
      native.addEventListener('input',()=>{ input.value=native.value; input.dispatchEvent(new Event('input')); });
      native.addEventListener('change',()=>{ input.value=native.value; input.dispatchEvent(new Event('input')); });
      grid.appendChild(native);
    }
  }catch(e){}
  input.addEventListener('input',()=>{let matched=false;grid.querySelectorAll('.swatch').forEach(s=>{if(s.classList.contains('plus')) return;const c=s.style.background.toLowerCase();if(c===input.value.toLowerCase()){s.classList.add('selected');matched=true;}else{s.classList.remove('selected');}});if(!matched){grid.querySelectorAll('.swatch').forEach(s=>s.classList.remove('selected'));}
    // 同步“展开/收起”按钮的提示文案或样式（可选：此处仅保持文案）
    const field=grid.closest('.field')||grid.parentElement; const btn=field?.querySelector('.color-toggle'); if(btn){ btn.title=`当前色：${input.value}`; const dot=field.querySelector('.color-dot'); if(dot){ dot.style.background=input.value; } }
    renderScene();
  });
}
function initGlobalColorPalettes(){
  const grid=document.querySelector('.swatch-grid[data-for="boxColor"]'); const input=document.getElementById('boxColor');
  if(grid&&input){ buildPalette(grid,input); attachColorToggleForGrid(grid,input); grid.classList.add('collapsed'); }
}
function initPalletColorPalette(){
  const grid=document.querySelector('.swatch-grid[data-for="palletColor"]'); const input=document.getElementById('palletColor');
  if(grid&&input){ buildPalette(grid,input); attachColorToggleForGrid(grid,input); grid.classList.add('collapsed'); }
} 
function randomPaletteColor(){return COLOR_POOL[Math.floor(Math.random()*COLOR_POOL.length)]||'#1a73e8'}
// 生成不重复的产品颜色：优先从 COLOR_POOL 中找未使用色；耗尽后按黄金角生成新色
function getUsedProductColors(){
  try{ return [...document.querySelectorAll('.product-row .pcolor')]
    .map(i=> (i.value||'').toLowerCase())
    .filter(c=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/.test(c)); }catch(e){ return []; }
}
function hslToHex(h,s,l){
  h=((parseFloat(h)||0)%360+360)%360; s=Math.max(0,Math.min(100,parseFloat(s)||0)); l=Math.max(0,Math.min(100,parseFloat(l)||0));
  s/=100; l/=100;
  const c=(1-Math.abs(2*l-1))*s; const x=c*(1-Math.abs(((h/60)%2)-1)); const m=l-c/2; let r=0,g=0,b=0;
  if(h<60){r=c;g=x;b=0;} else if(h<120){r=x;g=c;b=0;} else if(h<180){r=0;g=c;b=x;} else if(h<240){r=0;g=x;b=c;} else if(h<300){r=x;g=0;b=c;} else {r=c;g=0;b=x;}
  const toHex=v=>('0'+Math.round((v+m)*255).toString(16)).slice(-2);
  return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
}
function randomPaletteColorUnique(){
  const used=new Set(getUsedProductColors());
  for(const c of COLOR_POOL){ const lc=c.toLowerCase(); if(!used.has(lc)) return c; }
  // 若内置色已用尽，用黄金角步进按 HSL 生成新色并加入色板
  const idx=used.size; const hue=(idx*137.508)%360; const sat=65; const light=55;
  let candidate=hslToHex(hue,sat,light).toLowerCase();
  let tries=0;
  while(used.has(candidate) && tries<10){ candidate=hslToHex((hue+(tries+1)*23)%360,sat,light).toLowerCase(); tries++; }
  const final=candidate;
  try{ if(!PALETTE.includes(final)) PALETTE.push(final); if(final!=='#ffffff' && !COLOR_POOL.includes(final)) COLOR_POOL.push(final); }catch(e){}
  return final;
}

function hexToRgb(hex){try{let h=hex.replace('#','');if(h.length===3){h=h.split('').map(x=>x+x).join('');}const r=parseInt(h.slice(0,2),16),g=parseInt(h.slice(2,4),16),b=parseInt(h.slice(4,6),16);return{r,g,b};}catch{return{r:26,g:115,b:232}}}
function rgbToHsl(r,g,b){
  r=(r/255); g=(g/255); b=(b/255);
  const max=Math.max(r,g,b),min=Math.min(r,g,b); let h=0,s=0; const l=(max+min)/2; const d=max-min;
  if(d===0){ h=0; s=0; }
  else{
    s=l>0.5? d/(2-max-min) : d/(max+min);
    switch(max){
      case r: h=((g-b)/d + (g<b?6:0)); break;
      case g: h=((b-r)/d + 2); break;
      case b: h=((r-g)/d + 4); break;
    }
    h*=60;
  }
  return {h:Math.round(h%360), s:Math.round(s*100), l:Math.round(l*100)};
}
function hexToHsl(hex){const {r,g,b}=hexToRgb(hex);return rgbToHsl(r,g,b);}
function applyAccentColor(col){
  const rgb=hexToRgb(col);
  const root=document.documentElement;
  const body=document.body;
  // 覆盖全局变量（根节点 + body），确保不受主题类覆盖
  root.style.setProperty('--accent',col);
  root.style.setProperty('--accent-rgb',`${rgb.r},${rgb.g},${rgb.b}`);
  if(body){
    body.style.setProperty('--accent',col);
    body.style.setProperty('--accent-rgb',`${rgb.r},${rgb.g},${rgb.b}`);
    // Google 主题主色同步，保证按钮等组件受自定义颜色影响
    if(body.classList.contains('google')){
      body.style.setProperty('--md-primary',col);
      body.style.setProperty('--md-primary-rgb',`${rgb.r},${rgb.g},${rgb.b}`);
    }
  }
}
function attachColorToggleForGrid(grid,input){
  try{
    if(!grid || !input) return;
    // 如果已存在按钮，跳过
    const container=grid.closest('.field')||grid.parentElement;
    if(!container) return;
    if(container.querySelector('.color-toggle')) return;
    const btn=document.createElement('button'); btn.type='button'; btn.className='color-toggle'; { const lang=getUILang(); const dict=translations[lang]||translations['zh-CN']; btn.textContent=(dict['btn.expand']||'展开'); }
    const dot=document.createElement('span'); dot.className='color-dot'; dot.style.background=input.value||'#1a73e8';
    btn.prepend(dot);
    btn.title=`当前色：${input.value||''}`;
    btn.addEventListener('click',()=>{
      const isCollapsed=grid.classList.toggle('collapsed');
      { const lang=getUILang(); const dict=translations[lang]||translations['zh-CN']; btn.textContent=isCollapsed ? (dict['btn.expand']||'展开') : (dict['btn.collapse']||'折叠'); }
      // 保留色块在按钮中（重新插入避免文本覆盖）
      btn.prepend(dot);
      if(isCollapsed){ grid.querySelectorAll('.color-popover').forEach(p=>p.remove()); }
    });
    container.insertBefore(btn, grid);
  }catch(e){}
}
/* 自定义主题主色功能已移除 */

const CSV_TEMPLATE=`name,L,W,H,qty,weight,weightUnit,type,color\nA001,600,450,330,10,0.5,kg,normal,#34a853\nA002,500,400,280,8,0.4,kg,paste,#1a73e8`;
function buildXlsXmlFromTemplate(){
  const rows=CSV_TEMPLATE.split(/\r?\n/).map(l=>l.split(','));
  const esc=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const cells=(r)=>r.map(v=>`<Cell><Data ss:Type="String">${esc(v)}</Data></Cell>`).join('');
  const table=rows.map(r=>`<Row>${cells(r)}</Row>`).join('');
  const xml=`<?xml version="1.0"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40"><Worksheet ss:Name="Products"><Table>${table}</Table></Worksheet></Workbook>`;
  return xml;
}
function downloadFile(name,blob){const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=name;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0);}
// ====== XLSX 生成（最小化结构，无需外部库） ======
function toColName(n){let s='';while(n>0){const m=(n-1)%26;s=String.fromCharCode(65+m)+s;n=Math.floor((n-1)/26);}return s;}
function escXml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function buildSheetXMLFromRows(rows){
  // rows: array of arrays (strings/numbers)
  let xml=['<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"><sheetData>'];
  for(let r=0;r<rows.length;r++){
    const row=rows[r];xml.push(`<row r="${r+1}">`);
    for(let c=0;c<row.length;c++){
      const v=row[c];const ref=toColName(c+1)+(r+1);
      if(v===''||v==null){xml.push(`<c r="${ref}"/>`);continue;}
      const num=typeof v==='number' || (typeof v==='string' && v.trim()!=='' && !isNaN(Number(v)));
      if(num){xml.push(`<c r="${ref}" t="n"><v>${Number(v)}</v></c>`);}else{xml.push(`<c r="${ref}" t="inlineStr"><is><t>${escXml(String(v))}</t></is></c>`);} 
    }
    xml.push('</row>');
  }
  xml.push('</sheetData></worksheet>');
  return xml.join('');
}
function strToUint8(str){const enc=new TextEncoder();return enc.encode(str);} 
function writeUint16LE(arr,val){arr.push(val&0xff,(val>>8)&0xff);} 
function writeUint32LE(arr,val){arr.push(val&0xff,(val>>8)&0xff,(val>>16)&0xff,(val>>24)&0xff);} 
// CRC32
function crc32(buf){const table=(function(){let t=[];for(let i=0;i<256;i++){let c=i;for(let j=0;j<8;j++){c=((c&1)?(0xEDB88320^(c>>>1)):(c>>>1));}t[i]=c>>>0;}return t;})();let crc=0xFFFFFFFF;for(let i=0;i<buf.length;i++){crc=table[(crc^buf[i])&0xFF]^(crc>>>8);}return (crc^0xFFFFFFFF)>>>0;}
function getDosDateTime(){const d=new Date();const dosTime=(d.getSeconds()>>1) | (d.getMinutes()<<5) | (d.getHours()<<11);const dosDate=(d.getDate()) | ((d.getMonth()+1)<<5) | ((d.getFullYear()-1980)<<9);return{dosTime,dosDate};}
function makeZip(files){
  // files: [{path:string, data:string|Uint8Array}]
  const localParts=[];const centralParts=[];let offset=0;const {dosTime,dosDate}=getDosDateTime();
  files.forEach(f=>{
    const nameBytes=strToUint8(f.path);const dataBytes=(f.data instanceof Uint8Array)?f.data:strToUint8(f.data);
    const crc=crc32(dataBytes);const size=dataBytes.length;const compMethod=0; // store
    // Local file header
    const local=[];writeUint32LE(local,0x04034b50);writeUint16LE(local,20);writeUint16LE(local,0);writeUint16LE(local,compMethod);writeUint16LE(local,dosTime);writeUint16LE(local,dosDate);writeUint32LE(local,crc);writeUint32LE(local,size);writeUint32LE(local,size);writeUint16LE(local,nameBytes.length);writeUint16LE(local,0);
    const localHeader=new Uint8Array(local.length+nameBytes.length+dataBytes.length);localHeader.set(local,0);localHeader.set(nameBytes,local.length);localHeader.set(dataBytes,local.length+nameBytes.length);
    localParts.push(localHeader);
    // Central directory header
    const central=[];writeUint32LE(central,0x02014b50);writeUint16LE(central,20);writeUint16LE(central,20);writeUint16LE(central,0);writeUint16LE(central,compMethod);writeUint16LE(central,dosTime);writeUint16LE(central,dosDate);writeUint32LE(central,crc);writeUint32LE(central,size);writeUint32LE(central,size);writeUint16LE(central,nameBytes.length);writeUint16LE(central,0);writeUint16LE(central,0);writeUint16LE(central,0);writeUint16LE(central,0);writeUint32LE(central,0);writeUint32LE(central,offset);
    const centralHeader=new Uint8Array(central.length+nameBytes.length);centralHeader.set(central,0);centralHeader.set(nameBytes,central.length);
    centralParts.push(centralHeader);
    offset+=localHeader.length;
  });
  // End of central directory
  const centralSize=centralParts.reduce((s,b)=>s+b.length,0);const centralOffset=offset;const end=[];writeUint32LE(end,0x06054b50);writeUint16LE(end,0);writeUint16LE(end,0);writeUint16LE(end,files.length);writeUint16LE(end,files.length);writeUint32LE(end,centralSize);writeUint32LE(end,centralOffset);writeUint16LE(end,0);
  const outSize=offset+centralSize+end.length;const out=new Uint8Array(outSize);let p=0;localParts.forEach(a=>{out.set(a,p);p+=a.length;});centralParts.forEach(a=>{out.set(a,p);p+=a.length;});out.set(end,p);
  return new Blob([out],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
}
function buildXlsxFromTemplate(){
  const rows=CSV_TEMPLATE.split(/\r?\n/).map(l=>l.split(','));
  const sheetXML=buildSheetXMLFromRows(rows);
  const files=[
    {path:'[Content_Types].xml',data:'<?xml version="1.0" encoding="UTF-8"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/><Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/></Types>'},
    {path:'_rels/.rels',data:'<?xml version="1.0" encoding="UTF-8"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/></Relationships>'},
    {path:'xl/workbook.xml',data:'<?xml version="1.0" encoding="UTF-8"?><workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"><sheets><sheet name="Products" sheetId="1" r:id="rId1"/></sheets></workbook>'},
    {path:'xl/_rels/workbook.xml.rels',data:'<?xml version="1.0" encoding="UTF-8"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/></Relationships>'},
    {path:'xl/worksheets/sheet1.xml',data:sheetXML}
  ];
  return makeZip(files);
}
function detectDelimiter(text){return text.includes('\t')?'\t':','}
function splitRow(line,delim){const out=[];let cur='';let inQ=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"'){if(inQ&&line[i+1]==='"'){cur+='"';i++;}else{inQ=!inQ;}}else if(ch===delim&&!inQ){out.push(cur.trim());cur='';}else{cur+=ch;}}out.push(cur.trim());return out;}
function normalizeKey(k){const s=(k||'').trim().toLowerCase();if(['name','产品名','名称','产品'].includes(s))return'name';if(['l','length','长'].includes(s))return'L';if(['w','width','宽'].includes(s))return'W';if(['h','height','高'].includes(s))return'H';if(['qty','数量','件数'].includes(s))return'qty';if(['weight','重量'].includes(s))return'weight';if(['weightunit','单位','重量单位'].includes(s))return'weightUnit';if(['type','类型','分类'].includes(s))return'type';if(['color','颜色'].includes(s))return'color';return s;}
function normalizeType(t){const s=(t||'normal').toString().toLowerCase();if(['paste','膏体'].includes(s))return'paste';if(['haz','带电','带磁','hazard'].includes(s))return'haz';return'normal';}
function parseCSV(text){const lines=(text||'').trim().split(/\r?\n/).filter(l=>l.trim().length>0);if(!lines.length)return[];const delim=detectDelimiter(text);const header=splitRow(lines[0],delim).map(normalizeKey);const rows=[];for(let i=1;i<lines.length;i++){const cols=splitRow(lines[i],delim);const obj={};for(let j=0;j<header.length;j++){obj[header[j]]=cols[j]||'';}rows.push({name:obj.name,L:parseFloat(obj.L)||'',W:parseFloat(obj.W)||'',H:parseFloat(obj.H)||'',qty:parseFloat(obj.qty)||'',weight:parseFloat(obj.weight)||'',weightUnit:(obj.weightUnit||'kg'),type:normalizeType(obj.type),color:obj.color||''});}return rows;}
function importRows(rows){if(!Array.isArray(rows)||!rows.length)return;rows.forEach(r=>addProductRow(r));}
// 智能自由文本解析（每行一个产品）
function parseSmartText(text){
  const lines=(text||'').split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
  const rows=[]; let skipped=0;
  lines.forEach(line=>{const r=parseSmartLine(line); if(r) rows.push(r); else skipped++;});
  return {rows,total:lines.length,skipped};
}
function parseSmartLine(line){
  // 如果包含逗号或制表符，当作无表头的CSV/TSV行，按顺序映射
  if(line.includes(',')||line.includes('\t')){
    const delim=line.includes('\t')?'\t':',';const cols=line.split(delim).map(s=>s.trim());
    const mapOrder=['name','L','W','H','qty','weight','weightUnit','type','color'];
    const obj={};for(let i=0;i<Math.min(cols.length,mapOrder.length);i++){obj[mapOrder[i]]=cols[i];}
    return normalizeSmartObject(obj);
  }
  // 关键字/中文标签识别 + 位置推断
  const obj={};
  // 颜色
  const colorMatch=line.match(/#([0-9a-fA-F]{3,8})/); if(colorMatch) obj.color='#'+colorMatch[1];
  // 名称
  const nameKV=line.match(/(?:name|名称|产品名|产品)\s*[:=]\s*([^\s]+)/i); if(nameKV) obj.name=nameKV[1];
  // L/W/H（支持单位后缀，并按页面当前单位转换）
  const selUnit=(document.getElementById('unitSelect')?.value)||'mm';
  const Lm=line.match(/(?:L|长|length)\s*[:=]?\s*(\d+(?:\.\d+)?)(mm|cm|m)?/i); if(Lm){const v=parseFloat(Lm[1]);const u=(Lm[2]||'').toLowerCase();obj.L=u?convLinear(v,u,selUnit):Lm[1];}
  const Wm=line.match(/(?:W|宽|width)\s*[:=]?\s*(\d+(?:\.\d+)?)(mm|cm|m)?/i); if(Wm){const v=parseFloat(Wm[1]);const u=(Wm[2]||'').toLowerCase();obj.W=u?convLinear(v,u,selUnit):Wm[1];}
  const Hm=line.match(/(?:H|高|height)\s*[:=]?\s*(\d+(?:\.\d+)?)(mm|cm|m)?/i); if(Hm){const v=parseFloat(Hm[1]);const u=(Hm[2]||'').toLowerCase();obj.H=u?convLinear(v,u,selUnit):Hm[1];}
  // 维度星号/乘号分隔模式：如 10*10*5 / 10x10x5 / 10×10×5，支持单位
  if(!(obj.L&&obj.W&&obj.H)){
    const dmu=line.match(/(\d+(?:\.\d+)?)(mm|cm|m)?[\*xX×](\d+(?:\.\d+)?)(mm|cm|m)?[\*xX×](\d+(?:\.\d+)?)(mm|cm|m)?/);
    if(dmu){
      const v1=convLinear(parseFloat(dmu[1]),(dmu[2]||'mm').toLowerCase(),selUnit);
      const v2=convLinear(parseFloat(dmu[3]),(dmu[4]||'mm').toLowerCase(),selUnit);
      const v3=convLinear(parseFloat(dmu[5]),(dmu[6]||'mm').toLowerCase(),selUnit);
      obj.L=obj.L??v1; obj.W=obj.W??v2; obj.H=obj.H??v3;
    } else {
      const dm=line.match(/(\d+(?:\.\d+)?)[\*xX×](\d+(?:\.\d+)?)[\*xX×](\d+(?:\.\d+)?)/);
      if(dm){ obj.L=obj.L??dm[1]; obj.W=obj.W??dm[2]; obj.H=obj.H??dm[3]; }
    }
  }
  // 维度斜杠分隔模式：如 10/10/5 或 10／10／5，支持单位
  if(!(obj.L&&obj.W&&obj.H)){
    const dsu=line.match(/(\d+(?:\.\d+)?)(mm|cm|m)?[\/／](\d+(?:\.\d+)?)(mm|cm|m)?[\/／](\d+(?:\.\d+)?)(mm|cm|m)?/);
    if(dsu){
      const v1=convLinear(parseFloat(dsu[1]),(dsu[2]||'mm').toLowerCase(),selUnit);
      const v2=convLinear(parseFloat(dsu[3]),(dsu[4]||'mm').toLowerCase(),selUnit);
      const v3=convLinear(parseFloat(dsu[5]),(dsu[6]||'mm').toLowerCase(),selUnit);
      obj.L=obj.L??v1; obj.W=obj.W??v2; obj.H=obj.H??v3;
    } else {
      const ds=line.match(/(\d+(?:\.\d+)?)[\/／](\d+(?:\.\d+)?)[\/／](\d+(?:\.\d+)?)/);
      if(ds){ obj.L=obj.L??ds[1]; obj.W=obj.W??ds[2]; obj.H=obj.H??ds[3]; }
    }
  }
  // 数量
  const Qm=line.match(/(?:qty|数量|件数)\s*[:=]?\s*(\d+)/i); if(Qm) obj.qty=Qm[1];
  // 重量与单位
  const Wtm=line.match(/(?:weight|重量)\s*[:=]?\s*(\d+(?:\.\d+)?)/i); if(Wtm) obj.weight=Wtm[1];
  const Um=line.match(/\b(kg|g|斤)\b/i); if(Um) obj.weightUnit=Um[1].toLowerCase();
  // 类型
  const Tm=line.match(/(?:type|类型|分类)\s*[:=]?\s*([\w\u4e00-\u9fa5]+)/i); if(Tm) obj.type=Tm[1];
  // 剩余位置推断
  const tokens=line.split(/\s+/).filter(t=>t.length>0);
  const nums=tokens.filter(t=>/^\d+(?:\.\d+)?$/.test(t));
  const unitTok=tokens.find(t=>/^(kg|g|斤)$/i.test(t)); if(!obj.weightUnit&&unitTok) obj.weightUnit=unitTok.toLowerCase();
  // 给未填的 L/W/H/qty/weight 赋值（按序）
  const order=['L','W','H','qty','weight']; let idx=0;
  order.forEach(k=>{ if(obj[k]==null && nums[idx]!=null){ obj[k]=nums[idx++]; } });
  // 名称：第一个非数字、非#颜色、非标签、非单位的词
  if(!obj.name){
    const nameTok=tokens.find(t=>!/^\d+(?:\.\d+)?$/.test(t) && !/^#/.test(t) && !/^(kg|g|斤)$/i.test(t) && !/[=:]/.test(t));
    if(nameTok) obj.name=nameTok;
  }
  return normalizeSmartObject(obj);
}
function normalizeSmartObject(obj){
  const out={
    name: obj.name||'',
    L: obj.L?parseFloat(obj.L):'',
    W: obj.W?parseFloat(obj.W):'',
    H: obj.H?parseFloat(obj.H):'',
    qty: obj.qty?parseFloat(obj.qty):'',
    weight: obj.weight?parseFloat(obj.weight):'',
    weightUnit: (obj.weightUnit||'kg'),
    type: normalizeType(obj.type||'normal'),
    color: obj.color||''
  };
  // 至少应有 L/W/H/qty 其中之一，否则忽略
  if(!(out.L||out.W||out.H||out.qty||out.name)) return null;
  return out;
}
function initSmartFillUI(){
  const ta=document.getElementById('smartFillInput');
  const run=document.getElementById('smartFillRun');
  const st=document.getElementById('smartFillStatus');
  const s1=document.getElementById('smartFillSample1');
  const s2=document.getElementById('smartFillSample2');
  const clr=document.getElementById('smartFillClear');
  if(run&&ta){
    run.dataset.aiManaged='true';
    run.onclick=()=>runWithAIBusy(()=>{
      const res=parseSmartText(ta.value||'');
      importRows(res.rows);
      if(st){st.textContent=`共 ${res.total} 行，成功 ${res.rows.length}，跳过 ${res.skipped}`;}
    },{msg:'文本识别解析中',minMs:700,btn:run,btnText:'AI 识别中…'});
    ta.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){run.click();}});
    ta.addEventListener('paste',()=>{setTimeout(()=>run.click(),0);});
  }
  if(s1&&ta){
    s1.onclick=()=>{
      ta.value=`A001 600 450 330 10 0.5 kg normal #34a853\nA002 500 400 280 8 0.4 kg paste #1a73e8`;
      ta.focus();
    };
  }
  if(s2&&ta){
    s2.onclick=()=>{
      ta.value=`name:护手霜 L:600 W:450 H:330 qty:10 weight:0.5kg type:膏体 color:#34a853\nname:洗面奶 L:500 W:400 H:280 qty:8 weight:0.4kg type:液体 color:#1a73e8`;
      ta.focus();
    };
  }
  if(clr&&ta){clr.onclick=()=>{ta.value='';ta.focus();if(st) st.textContent='';};}
}
function initImportUI(){
  const tpl=document.getElementById('csvTemplateBlock');
  if(tpl) tpl.textContent=CSV_TEMPLATE;

  const copyBtn=document.getElementById('copyCSVTemplate');
  if(copyBtn) copyBtn.onclick=async()=>{try{await navigator.clipboard.writeText(CSV_TEMPLATE);}catch{}};

  const fillBtn=document.getElementById('fillSampleTable');
  const paste=document.getElementById('importPaste');
  if(fillBtn&&paste){fillBtn.onclick=()=>{paste.value=CSV_TEMPLATE;paste.focus();}} 

  const parseBtn=document.getElementById('parseAndImport');
  if(parseBtn&&paste){
    parseBtn.dataset.aiManaged='true';
    parseBtn.onclick=()=>runWithAIBusy(()=>{const rows=parseCSV(paste.value||'');importRows(rows);},{msg:'CSV 解析导入中',minMs:600,btn:parseBtn,btnText:'AI 导入中…'});
  }

  const fileBtn=document.getElementById('importFileBtn');
  const fileInput=document.getElementById('importFile');
  if(fileBtn&&fileInput){
    fileBtn.onclick=()=>fileInput.click();
    fileInput.onchange=()=>{
      const f=fileInput.files&&fileInput.files[0];
      if(!f) return;
      const r=new FileReader();
      runWithAIBusy(()=>new Promise((resolve)=>{
        r.onload=()=>{const text=r.result.toString();const rows=parseCSV(text);importRows(rows);resolve();};
        r.readAsText(f);
      }),{msg:'文件解析导入中',minMs:800});
    };
  }

  // 下载模板（Excel .xls 与 CSV）
  const dlXlsBtn=document.getElementById('downloadXlsTemplate');
  if(dlXlsBtn){
    dlXlsBtn.onclick=()=>{
      const xml=buildXlsXmlFromTemplate();
      const blob=new Blob([xml],{type:'application/vnd.ms-excel'});
      downloadFile('产品导入模板.xls',blob);
    };
  }
  const dlXlsxBtn=document.getElementById('downloadXlsxTemplate');
  if(dlXlsxBtn){
    dlXlsxBtn.onclick=()=>{
      const blob=buildXlsxFromTemplate();
      downloadFile('产品导入模板.xlsx',blob);
    };
  }
  const dlCsvBtn=document.getElementById('downloadCsvTemplate');
  if(dlCsvBtn){
    dlCsvBtn.onclick=()=>{
      const blob=new Blob([CSV_TEMPLATE],{type:'text/csv;charset=utf-8'});
      downloadFile('产品导入模板.csv',blob);
    };
  }
}

/************** 产品行 **************/
const productList=document.getElementById('productList');
let activePasteRow=null;let productRowCounter=1;
function addProductRow(data){
  const div=document.createElement('div');div.className='product-row';
  const ptypeName=`ptype-${productRowCounter++}`;div.dataset.ptname=ptypeName;
  div.innerHTML=`
    <div class='thumb-hint-out' data-i18n='thumb.pasteHint'>按 CTRL+V 添加图片</div>
    <div class='thumb' data-role='thumb' title='Ctrl/⌘+V 粘贴图片' data-i18n-title='thumb.title'>
      <button class='thumb-upload btn' type='button' title='上传图片' data-i18n='btn.uploadImage' data-i18n-title='btn.uploadImage'>上传</button>
      <input type='file' accept='image/*' class='thumb-file' aria-hidden='true' style='display:none'>
    </div>
    <label class='field'><span class='label' data-i18n='label.prodName'>产品名</span><input class='pname' placeholder='如：A001' data-i18n-ph='ph.prodName'></label>
    <label class='field'><span class='label' data-i18n='label.prodL'>L</span><input class='pL' placeholder='长' data-i18n-ph='ph.prodL'></label>
    <label class='field'><span class='label' data-i18n='label.prodW'>W</span><input class='pW' placeholder='宽' data-i18n-ph='ph.prodW'></label>
    <label class='field'><span class='label' data-i18n='label.prodH'>H</span><input class='pH' placeholder='高' data-i18n-ph='ph.prodH'></label>
    <label class='field'><span class='label' data-i18n='label.prodQty'>数量</span><input class='pqty' placeholder='件数' data-i18n-ph='ph.prodQty'></label>
    <label class='field'><span class='label' data-i18n='label.prodWeight'>重量</span><input class='pweight' placeholder='如：0.5' data-i18n-ph='ph.prodWeight'></label>
    <label class='field'><span class='label' data-i18n='label.prodUnit'>单位</span>
      <select class='pweightunit'><option value='kg' data-i18n='unit.kg'>kg</option><option value='g' data-i18n='unit.g'>g</option><option value='jin' data-i18n='unit.jin'>斤</option></select>
    </label>
    <label class='field' style='flex:0 0 200px'><span class='label' data-i18n='label.prodColor'>颜色</span><button class='color-toggle' type='button' data-i18n-title='btn.expand'>展开</button><div class='swatch-grid' data-for='pcolor'></div><input type='color' class='pcolor hidden-color' value='#34a853'></label>
    <label class='field' style='flex:1 1 220px'>
      <span class='label' data-i18n='label.prodType'>类型</span>
      <div class='row' style='gap:6px'>
        <label class='small'><input type='radio' name='${ptypeName}' value='normal' checked> <span data-i18n='prod.type.normal'>普货</span></label>
        <label class='small'><input type='radio' name='${ptypeName}' value='paste'> <span data-i18n='prod.type.paste'>膏体</span></label>
        <label class='small'><input type='radio' name='${ptypeName}' value='haz'> <span data-i18n='prod.type.haz'>带电/带磁</span></label>
      </div>
    </label>
    <button class='remove' title='删除' data-i18n-title='btn.deleteRow'>❌</button>`;
  div.querySelector('.remove').onclick=()=>div.remove();
  div.onclick=()=>activePasteRow=div;
  // 绑定缩略图上传与提示隐藏逻辑
  try{
    const thumb=div.querySelector('.thumb');
    const tf=div.querySelector('.thumb-file');
    const tu=div.querySelector('.thumb-upload');
    if(thumb && tf && tu){
      tu.onclick=(e)=>{ e.stopPropagation(); activePasteRow=div; tf.click(); };
      tf.onchange=()=>{
        const f=tf.files && tf.files[0]; if(!f) return;
        const r=new FileReader();
        r.onload=()=>{ thumb.style.backgroundImage=`url('${r.result}')`; thumb.classList.add('has-image'); div.classList.add('thumb-has-image'); };
        r.readAsDataURL(f);
      };
    }
  }catch(e){}
  // 添加前确保产品分组展开，避免需要手动下滑
  try{
    const prodGroup=document.querySelector('.group.cat-prod');
    if(prodGroup){
      prodGroup.classList.remove('collapsed');
      const btn=prodGroup.querySelector('.group-toggle'); if(btn){ const lang=getUILang(); const dict=translations[lang]||translations['zh-CN']; btn.textContent=(dict['btn.collapse']||'折叠'); }
      try{ localStorage.setItem('collapsed:产品参数','0'); }catch(e){}
    }
  }catch(e){}
  // 将新产品行追加到列表底部，符合“从下添加”的习惯
  try{ productList.appendChild(div); }catch(e){ productList.insertBefore(div, productList.firstChild||null); }
  // 应用当前语言到新插入的元素
  try{ if(window.__i18n && window.__i18n.apply){ window.__i18n.apply(window.__i18n.getLang()); } }catch(e){}
  // 聚焦首个输入但不触发滚动，然后将新行快速定位到视窗
  try{
    const firstInput=div.querySelector('input,select,textarea');
    if(firstInput){ firstInput.focus({preventScroll:true}); }
    div.classList.add('flash'); setTimeout(()=>div.classList.remove('flash'),1200);
    div.scrollIntoView({behavior:'auto', block:'center'});
  }catch(e){}
  const grid=div.querySelector('.swatch-grid[data-for="pcolor"]');const input=div.querySelector('.pcolor');
  // 先设置颜色，再构建调色板
  input.value=(data&&data.color)||randomPaletteColorUnique();buildPalette(grid,input);
  // 默认折叠颜色面板，点击按钮展开/收起
  try{
    grid.classList.add('collapsed');
    const btn=div.querySelector('.color-toggle');
    if(btn){
      // 在折叠按钮中加入当前色指示小块
      const dot=document.createElement('span'); dot.className='color-dot'; dot.style.background=input.value||'#1a73e8';
      btn.prepend(dot);
      btn.title=`当前色：${input.value||''}`;
      btn.onclick=()=>{
        const isCollapsed=grid.classList.toggle('collapsed');
        { const lang=getUILang(); const dict=translations[lang]||translations['zh-CN']; btn.textContent=isCollapsed ? (dict['btn.expand']||'展开') : (dict['btn.collapse']||'折叠'); }
        btn.prepend(dot);
        if(isCollapsed){ grid.querySelectorAll('.color-popover').forEach(p=>p.remove()); }
      };
    }
  }catch(e){}
  // 如果提供了数据，填入各字段
  if(data){
    div.querySelector('.pname').value=data.name||'';
    div.querySelector('.pL').value=(data.L!=null?data.L:'');
    div.querySelector('.pW').value=(data.W!=null?data.W:'');
    div.querySelector('.pH').value=(data.H!=null?data.H:'');
    div.querySelector('.pqty').value = (data.qty!=null?data.qty:'');
    div.querySelector('.pweight').value = (data.weight!=null?data.weight:'');
    const wu=div.querySelector('.pweightunit'); if(wu && data.weightUnit){wu.value=data.weightUnit;}
    const t=(data.type||'normal');
    div.querySelectorAll(`input[name='${ptypeName}']`).forEach(r=>{r.checked=(r.value===t)});
  }
  // 聚焦并滚动到新行，避免手动下滑（居中对齐）
  try{ const nameInput=div.querySelector('.pname'); if(nameInput) nameInput.focus(); div.scrollIntoView({behavior:'smooth',block:'center'}); }catch(e){}
}
(function initDefaults(){
  document.getElementById('unitSelect').value='mm';
  document.getElementById('cL').value='600';
  document.getElementById('cW').value='450';
  document.getElementById('cH').value='330';
  // Pallet defaults
  const pL=document.getElementById('pL'); if(pL) pL.value='1200';
  const pW=document.getElementById('pW'); if(pW) pW.value='1000';
  const pH=document.getElementById('pH'); if(pH) pH.value='1500';
  const pPattern=document.getElementById('pPattern'); if(pPattern) pPattern.value='auto';
  const pMarginX=document.getElementById('pMarginX'); if(pMarginX) pMarginX.value='0';
  const pMarginY=document.getElementById('pMarginY'); if(pMarginY) pMarginY.value='0';
  const pGap=document.getElementById('pGap'); if(pGap) pGap.value='0';
  const pColor=document.getElementById('palletColor'); if(pColor) pColor.value='#8d6e63';
  try{
    const paramTgl=document.getElementById('paramTextToggle');
    const prodTgl=document.getElementById('product3DTextToggle');
    const sp=localStorage.getItem('viewer:showParams');
    const st=localStorage.getItem('viewer:showProdText');
    if(paramTgl && (sp==='0' || sp==='1')) paramTgl.checked = sp==='1';
    if(prodTgl && (st==='0' || st==='1')) prodTgl.checked = st==='1';
  }catch(e){}
  addProductRow();
})();
document.getElementById('addProduct').onclick=addProductRow;
initGlobalColorPalettes();initPalletColorPalette();
/* 自定义配色已移除：不再初始化主题调色板 */
initSmartFillUI();
addEventListener('paste',e=>{if(!activePasteRow)return;for(const it of e.clipboardData.items){if(it.type.indexOf('image')===0){const f=it.getAsFile();const r=new FileReader();r.onload=()=>{activePasteRow.querySelector('[data-role=\"thumb\"]').style.backgroundImage=`url('${r.result}')`};r.readAsDataURL(f);break;}}});
// 托板常见尺寸预设联动
(function initPalletPresets(){
  try{
    const sel=document.getElementById('pPreset'); if(!sel) return;
    // 加载本地自定义托板预设
    try{
      const raw=localStorage.getItem('preset:pallet')||'[]';
      const list=JSON.parse(raw);
      if(Array.isArray(list)){
        list.forEach(it=>{
          if(!it) return; const Lmm=Math.round(it.Lmm||0), Wmm=Math.round(it.Wmm||0);
          if(!(Lmm&&Wmm)) return; const opt=document.createElement('option');
          opt.value=`${Lmm}x${Wmm}`; opt.textContent=(it.label||`${Lmm}×${Wmm}（自定义）`);
          sel.appendChild(opt);
        });
      }
    }catch(e){}
    const fmtByUnit=(mm,unit)=>{
      const v=convLinear(mm,'mm',unit);
      if(unit==='m') return (Math.round(v*1000)/1000).toString();
      if(unit==='cm') return (Math.round(v*10)/10).toString();
      return Math.round(v).toString();
    };
    sel.addEventListener('change',()=>{
      const val=(sel.value||'').trim(); if(!val) return;
      const m=/^(\d+)x(\d+)$/.exec(val); if(!m) return;
      const Lmm=parseFloat(m[1])||0; const Wmm=parseFloat(m[2])||0;
      const unit=(document.getElementById('unitSelect')?.value)||'mm';
      const pL=document.getElementById('pL'); const pW=document.getElementById('pW');
      if(pL) pL.value=fmtByUnit(Lmm,unit);
      if(pW) pW.value=fmtByUnit(Wmm,unit);
      try{ renderScene(); }catch(e){}
      try{
        const pv=document.querySelector('.viewer[data-bi="pallet-1"]')||document.querySelector('.viewer[data-bi="pallet"]');
        if(pv) setViewerAspectByLW(pv,Lmm,Wmm);
      }catch(e){}
    });
    // 保存当前托板尺寸为自定义预设
    const addBtn=document.getElementById('addPalletPreset');
    if(addBtn){
      addBtn.addEventListener('click',()=>{
        try{
          const unit=(document.getElementById('unitSelect')?.value)||'mm';
          const Lmm=toMM(document.getElementById('pL').value||0,unit);
          const Wmm=toMM(document.getElementById('pW').value||0,unit);
          if(!(Lmm&&Wmm)){ alert('请先填写托板长宽'); return; }
          const label=prompt('输入预设名称（如：自定义托板）','自定义托板');
          const raw=localStorage.getItem('preset:pallet')||'[]'; const list=JSON.parse(raw||'[]');
          list.push({label:label||`自定义 ${Math.round(Lmm)}×${Math.round(Wmm)}`, Lmm:Math.round(Lmm), Wmm:Math.round(Wmm)});
          localStorage.setItem('preset:pallet', JSON.stringify(list));
          const opt=document.createElement('option'); opt.value=`${Math.round(Lmm)}x${Math.round(Wmm)}`; opt.textContent=(label||`自定义 ${Math.round(Lmm)}×${Math.round(Wmm)}`);
          sel.appendChild(opt); sel.value=opt.value; sel.dispatchEvent(new Event('change'));
        }catch(e){ alert('保存失败：'+(e.message||e)); }
      });
    }
  }catch(e){}
})();

// 外箱常见尺寸预设与保存
(function initBoxPresets(){
  try{
    const sel=document.getElementById('boxPreset'); if(!sel) return;
    // 加载自定义外箱预设
    try{
      const raw=localStorage.getItem('preset:box')||'[]'; const list=JSON.parse(raw||'[]');
      if(Array.isArray(list)){
        list.forEach(it=>{
          const Lmm=Math.round(it.Lmm||0), Wmm=Math.round(it.Wmm||0), Hmm=Math.round(it.Hmm||0);
          if(!(Lmm&&Wmm&&Hmm)) return; const opt=document.createElement('option');
          opt.value=`${Lmm}x${Wmm}x${Hmm}`; opt.textContent=(it.label||`${Lmm}×${Wmm}×${Hmm}（自定义）`);
          sel.appendChild(opt);
        });
      }
    }catch(e){}
    const fmtByUnit=(mm,unit)=>{
      const v=convLinear(mm,'mm',unit);
      if(unit==='m') return (Math.round(v*1000)/1000).toString();
      if(unit==='cm') return (Math.round(v*10)/10).toString();
      return Math.round(v).toString();
    };
    sel.addEventListener('change',()=>{
      const val=(sel.value||'').trim(); if(!val) return;
      const m=/^(\d+)x(\d+)x(\d+)$/.exec(val); if(!m) return;
      const Lmm=parseFloat(m[1])||0; const Wmm=parseFloat(m[2])||0; const Hmm=parseFloat(m[3])||0;
      const unit=(document.getElementById('unitSelect')?.value)||'mm';
      const cL=document.getElementById('cL'), cW=document.getElementById('cW'), cH=document.getElementById('cH');
      if(cL) cL.value=fmtByUnit(Lmm,unit);
      if(cW) cW.value=fmtByUnit(Wmm,unit);
      if(cH) cH.value=fmtByUnit(Hmm,unit);
      try{ renderScene(); }catch(e){}
    });
    const addBtn=document.getElementById('addBoxPreset');
    if(addBtn){
      addBtn.addEventListener('click',()=>{
        try{
          const unit=(document.getElementById('unitSelect')?.value)||'mm';
          const Lmm=toMM(document.getElementById('cL').value||0,unit);
          const Wmm=toMM(document.getElementById('cW').value||0,unit);
          const Hmm=toMM(document.getElementById('cH').value||0,unit);
          if(!(Lmm&&Wmm&&Hmm)){ alert('请先填写外箱长宽高'); return; }
          const label=prompt('输入预设名称（如：自定义外箱）','自定义外箱');
          const raw=localStorage.getItem('preset:box')||'[]'; const list=JSON.parse(raw||'[]');
          list.push({label:label||`自定义 ${Math.round(Lmm)}×${Math.round(Wmm)}×${Math.round(Hmm)}`, Lmm:Math.round(Lmm), Wmm:Math.round(Wmm), Hmm:Math.round(Hmm)});
          localStorage.setItem('preset:box', JSON.stringify(list));
          const opt=document.createElement('option'); opt.value=`${Math.round(Lmm)}x${Math.round(Wmm)}x${Math.round(Hmm)}`; opt.textContent=(label||`自定义 ${Math.round(Lmm)}×${Math.round(Wmm)}×${Math.round(Hmm)}`);
          sel.appendChild(opt); sel.value=opt.value; sel.dispatchEvent(new Event('change'));
        }catch(e){ alert('保存失败：'+(e.message||e)); }
      });
    }
  }catch(e){}
})();

/************** 单位换算 **************/
function toMM(v,unit){v=parseFloat(v)||0;return unit==='cm'?v*10:unit==='m'?v*1000:v}
// 将线性尺寸从给定单位转换到目标单位（mm/cm/m）
function convLinear(v,fromUnit,toUnit){
  fromUnit=(fromUnit||'mm').toLowerCase();
  toUnit=(toUnit||'mm').toLowerCase();
  const mm=toMM(v,fromUnit);
  return toUnit==='cm'?mm/10:(toUnit==='m'?mm/1000:mm);
}
// 规范化数字字符串（处理全角数字/点/负号与杂字符）
function normalizeNumStr(s){
  if(s==null) return '';
  s=String(s).trim();
  const map={'０':'0','１':'1','２':'2','３':'3','４':'4','５':'5','６':'6','７':'7','８':'8','９':'9','．':'.','－':'-','，':'','、':''};
  s=[...s].map(ch=>map[ch]??ch).join('');
  // 去除除数字/点/负号外的字符
  s=s.replace(/[^0-9.\-]/g,'');
  // 多个点时保留第一个
  const firstDot=s.indexOf('.'); if(firstDot!==-1){ s=s.slice(0,firstDot+1)+s.slice(firstDot+1).replace(/\./g,''); }
  return s;
}
// 单位识别：支持中文单位后缀优先，其次使用页面单位选择
function detectUnitSuffix(raw){
  const s=String(raw||'').toLowerCase();
  if(/mm|毫米/.test(s)) return 'mm';
  if(/cm|厘米/.test(s)) return 'cm';
  if(/\bm\b|米/.test(s)) return 'm';
  return null;
}
function toMM(v,unit){
  const raw=v;
  const suf=detectUnitSuffix(raw);
  const base=normalizeNumStr(raw);
  const num=parseFloat(base)||0;
  const u=(suf||unit||'mm').toLowerCase();
  return u==='cm'?num*10:(u==='m'?num*1000:num);
}
function weightToKG(v,u){
  const num=parseFloat(normalizeNumStr(v))||0;
  const unit=(u||'kg').toLowerCase();
  // 扩展中文单位
  if(unit==='g'||unit==='克') return num/1000;
  if(unit==='jin'||unit==='斤') return num*0.5;
  return num;
}

/************** 3D Canvas 工具 **************/
let canvas=null,ctx=null;function resizeCanvasFor(cv){const r=cv.getBoundingClientRect();const dpr=Math.max(1,devicePixelRatio||1);const w=Math.max(200,Math.floor(r.width));const h=Math.max(200,Math.floor(r.height));if(cv.width!==Math.floor(w*dpr)||cv.height!==Math.floor(h*dpr)){cv.width=Math.floor(w*dpr);cv.height=Math.floor(h*dpr);cv.style.width=w+'px';cv.style.height=h+'px';const c=cv.getContext('2d');c.setTransform(dpr,0,0,dpr,0,0);}}
function resizeAllCanvases(){document.querySelectorAll('.viewer canvas').forEach(resizeCanvasFor);} addEventListener('resize',resizeAllCanvases);
function attachResizer(viewerEl){const handle=viewerEl.querySelector('.resizer');if(!handle) return;let startY=0,startH=0,drag=false;const minH=260,maxH=1600;
  function onMove(e){if(!drag) return;const dy=e.clientY-startY;const nh=Math.min(maxH,Math.max(minH,startH+dy));viewerEl.style.height=nh+'px';resizeCanvasFor(viewerEl.querySelector('canvas'));}
  function onUp(){if(!drag) return;drag=false;removeEventListener('mousemove',onMove);removeEventListener('mouseup',onUp);} 
  handle.addEventListener('mousedown',e=>{drag=true;startY=e.clientY;startH=viewerEl.getBoundingClientRect().height;addEventListener('mousemove',onMove);addEventListener('mouseup',onUp);e.preventDefault();});
  handle.addEventListener('dblclick',()=>{viewerEl.style.height='540px';resizeCanvasFor(viewerEl.querySelector('canvas'));});
}
// 根据场景L×W自动设定视窗高度，使初始比例接近三维内容
function setViewerAspectByLW(viewerEl,Lmm,Wmm){
  try{
    const rect=viewerEl.getBoundingClientRect();
    const ratio=(Math.max(1,parseFloat(Wmm)))/(Math.max(1,parseFloat(Lmm)));
    const targetH=Math.min(900,Math.max(260,Math.round(rect.width*ratio)));
    viewerEl.style.height=targetH+'px';
    const cv=viewerEl.querySelector('canvas'); if(cv) resizeCanvasFor(cv);
  }catch(e){}
}
function adaptViewerHeightByBI(viewerEl){
  try{
    const bi=(viewerEl.dataset.bi||'').toString();
    // 任何以 "pallet" 开头的标识（含缩略视图 pallet-1, pallet-2…）均按托板尺寸适配
    if(bi==='pallet' || bi.startsWith('pallet')){
      const pL=parseFloat(document.getElementById('pL').value)||1200;
      const pW=parseFloat(document.getElementById('pW').value)||1000;
      setViewerAspectByLW(viewerEl,pL,pW); return;
    }
    // （已移除）产品视图适配
    if(bi==='overview'){ setViewerAspectByLW(viewerEl,sceneBoxSize.L,sceneBoxSize.W); return; }
    if(bi==='truck-best'){
      const best=(window.__TRUCK_SUGGEST__&&window.__TRUCK_SUGGEST__.best)||null;
      if(best){ setViewerAspectByLW(viewerEl,best.L*1000,best.W*1000); return; }
    }
    // 默认使用外箱尺寸
    setViewerAspectByLW(viewerEl,sceneBoxSize.L,sceneBoxSize.W);
  }catch(e){}
}
function attachAdaptHeightBtn(viewerEl){ try{ const leg=viewerEl.querySelector('.legend'); if(!leg) return; const btn=document.createElement('button'); btn.type='button'; btn.className='ghost small'; btn.style.marginLeft='8px'; btn.textContent='自适配高度'; btn.title='根据内容长宽比重新设定视窗高度'; btn.addEventListener('click',()=>adaptViewerHeightByBI(viewerEl)); leg.appendChild(btn); }catch(e){} }
// 基于当前相机视角估算合适高度：用 yaw/pitch 投影估算占比
function adaptViewerHeightByCam(viewerEl){
  try{
    const cam=viewerCams.get(viewerEl)||makeDefaultCam();
    const yawAbs=Math.abs(cam.yaw%Math.PI); const pitchAbs=Math.abs(cam.pitch);
    // 估算投影后高度比例：pitch越大高度占比越高，yaw靠90°时宽度收缩
    const yawFactor=0.6 + 0.4*Math.abs(Math.sin(yawAbs));
    const pitchFactor=0.7 + 0.3*Math.min(1,Math.abs(pitchAbs)/1.2);
    const contentRatio=(sceneBoxSize.W/Math.max(1,sceneBoxSize.L))*pitchFactor/yawFactor;
    const rect=viewerEl.getBoundingClientRect();
    const targetH=Math.min(1000,Math.max(240,Math.round(rect.width*contentRatio)));
    viewerEl.style.height=targetH+'px';
    const cv=viewerEl.querySelector('canvas'); if(cv) resizeCanvasFor(cv);
  }catch(e){}
}
function attachAdaptByCamBtn(viewerEl){ try{ const leg=viewerEl.querySelector('.legend'); if(!leg) return; const btn=document.createElement('button'); btn.type='button'; btn.className='ghost small'; btn.style.marginLeft='8px'; btn.textContent='按视角自适配'; btn.title='根据当前相机角度估算最佳高度'; btn.addEventListener('click',()=>adaptViewerHeightByCam(viewerEl)); leg.appendChild(btn); }catch(e){} }
// 精准：投影包围盒角点，按屏幕占比计算高度
function adaptViewerHeightByCamPrecise(viewerEl){
  try{
    const cv=viewerEl.querySelector('canvas'); if(!cv) return; setRenderTarget(cv);
    const cam=viewerCams.get(viewerEl)||makeDefaultCam(); useCam(cam);
    let L=sceneBoxSize.L, W=sceneBoxSize.W; const bi=viewerEl.dataset.bi||'';
    if(bi==='pallet'){ const pL=parseFloat(document.getElementById('pL').value)||1200; const pW=parseFloat(document.getElementById('pW').value)||1000; L=pL; W=pW; }
    if(bi==='truck-best'){ const best=(window.__TRUCK_SUGGEST__&&window.__TRUCK_SUGGEST__.best)||null; if(best){ L=best.L*1000; W=best.W*1000; } }
    const pts=[
      {x:-L/2,y:0,z:-W/2}, {x:L/2,y:0,z:-W/2}, {x:L/2,y:0,z:W/2}, {x:-L/2,y:0,z:W/2},
      {x:-L/2,y:L*0.02,z:-W/2}, {x:L/2,y:L*0.02,z:-W/2}, {x:L/2,y:L*0.02,z:W/2}, {x:-L/2,y:L*0.02,z:W/2},
    ].map(p=>rotX(rotY(p,yaw),pitch)).map(project);
    const xs=pts.map(p=>p.x), ys=pts.map(p=>p.y);
    const minX=Math.min(...xs), maxX=Math.max(...xs), minY=Math.min(...ys), maxY=Math.max(...ys);
    const boxW=Math.max(1, maxX-minX), boxH=Math.max(1, maxY-minY);
    const rect=viewerEl.getBoundingClientRect();
    const targetH=Math.min(1200,Math.max(240,Math.round(rect.width * (boxH/boxW))));
    viewerEl.style.height=targetH+'px'; resizeCanvasFor(cv);
  }catch(e){}
}
function attachAdaptByCamPreciseBtn(viewerEl){ try{ const leg=viewerEl.querySelector('.legend'); if(!leg) return; const btn=document.createElement('button'); btn.type='button'; btn.className='ghost small'; btn.style.marginLeft='8px'; btn.textContent='精准按视角'; btn.title='投影包围盒计算最佳高度'; btn.addEventListener('click',()=>adaptViewerHeightByCamPrecise(viewerEl)); leg.appendChild(btn); }catch(e){} }
// 相机自动适配按钮：依据最大内容包围盒拟合距离
function attachFitCameraBtn(viewerEl){ try{ const leg=viewerEl.querySelector('.legend'); if(!leg) return; const btn=document.createElement('button'); btn.type='button'; btn.className='ghost small'; btn.style.marginLeft='8px'; btn.textContent='相机适配'; btn.title='按内容包围盒拟合相机距离'; btn.addEventListener('click',()=>fitCameraToContent(viewerEl,{tight:0.92})); leg.appendChild(btn); }catch(e){} }
// —— 按最大内容包围盒精确缩放相机距离 ——
function projectWithDistLocal(p,camDist,pan){ const f=800/Math.max(1,(p.z+camDist)); return { x: (canvas.width/2) + p.x*f + (pan?.x||0), y: (canvas.height/2) - p.y*f + (pan?.y||0) }; }
function computeContentPointsForBI(bi){
  try{
    const unit=document.getElementById('unitSelect')?.value||'mm';
    if(/^pallet(?:-\d+)?$/.test(bi||'')){
      const CL=toMM(document.getElementById('cL').value,unit);
      const CW=toMM(document.getElementById('cW').value,unit);
      const CHRaw=toMM(document.getElementById('cH').value,unit);
      const pL=toMM(document.getElementById('pL').value||0,unit);
      const pW=toMM(document.getElementById('pW').value||0,unit);
      const pH=toMM(document.getElementById('pH').value||0,unit);
      if(!(CL&&CW&&pL&&pW)) return null;
      const CH= (CHRaw && CHRaw>0) ? CHRaw : Math.max(60, sceneBoxSize.H||60);
      const layers = (pH>0 && CH>0) ? Math.max(1, Math.floor(pH/CH)) : 1;
      const L=pL, W=pW, H=Math.max(120, 120 + layers*CH);
      const off={x:-L/2, y:-60, z:-W/2};
      return [
        {x:off.x,y:off.y,z:off.z}, {x:off.x+L,y:off.y,z:off.z}, {x:off.x+L,y:off.y+H,z:off.z}, {x:off.x,y:off.y+H,z:off.z},
        {x:off.x,y:off.y,z:off.z+W}, {x:off.x+L,y:off.y,z:off.z+W}, {x:off.x+L,y:off.y+H,z:off.z+W}, {x:off.x,y:off.y+H,z:off.z+W}
      ];
    }
    // （已移除）产品视图包围盒
    if((bi||'')==='truck-best'){
      const best=(window.__TRUCK_SUGGEST__&&window.__TRUCK_SUGGEST__.best)||null; if(!best) return null;
      const L=best.L*1000, W=best.W*1000, H=best.H*1000;
      const off={x:-L/2, y:-H/2, z:-W/2};
      return [
        {x:off.x,y:off.y,z:off.z}, {x:off.x+L,y:off.y,z:off.z}, {x:off.x+L,y:off.y+H,z:off.z}, {x:off.x,y:off.y+H,z:off.z},
        {x:off.x,y:off.y,z:off.z+W}, {x:off.x+L,y:off.y,z:off.z+W}, {x:off.x+L,y:off.y+H,z:off.z+W}, {x:off.x,y:off.y+H,z:off.z+W}
      ];
    }
    // 默认：外箱包围盒
    const L=sceneBoxSize.L, W=sceneBoxSize.W, H=sceneBoxSize.H;
    const off={x:-L/2, y:-H/2, z:-W/2};
    return [
      {x:off.x,y:off.y,z:off.z}, {x:off.x+L,y:off.y,z:off.z}, {x:off.x+L,y:off.y+H,z:off.z}, {x:off.x,y:off.y+H,z:off.z},
      {x:off.x,y:off.y,z:off.z+W}, {x:off.x+L,y:off.y,z:off.z+W}, {x:off.x+L,y:off.y+H,z:off.z+W}, {x:off.x,y:off.y+H,z:off.z+W}
    ];
  }catch(e){ return null; }
}
function fitCameraToContent(viewerEl,opts){
  const o=Object.assign({tight:0.92,minDist:300,maxDist:8000},opts||{});
  try{
    const cv=viewerEl.querySelector('canvas'); if(!cv) return; setRenderTarget(cv); resizeCanvasFor(cv);
    const cam=viewerCams.get(viewerEl)||makeDefaultCam();
    // 使用当前相机 yaw/pitch，但重置平移以居中
    const curYaw=cam.yaw, curPitch=cam.pitch; const pan={x:0,y:0};
    // 构造内容包围盒角点，并进行旋转
    const bi=viewerEl.dataset.bi||''; const pts=computeContentPointsForBI(bi); if(!pts) return;
    const rotPts=pts.map(p=> rotX(rotY(p,curYaw),curPitch));
    const targetW=cv.width * o.tight, targetH=cv.height * o.tight;
    let lo=o.minDist, hi=o.maxDist;
    for(let it=0; it<22; it++){
      const mid=Math.floor((lo+hi)/2);
      const screenPts=rotPts.map(p=> projectWithDistLocal(p,mid,pan));
      const xs=screenPts.map(p=>p.x), ys=screenPts.map(p=>p.y);
      const w=Math.max(1,Math.max(...xs)-Math.min(...xs));
      const h=Math.max(1,Math.max(...ys)-Math.min(...ys));
      if(w>targetW || h>targetH){ lo=mid; } else { hi=mid; }
    }
    cam.dist=Math.max(o.minDist, Math.min(o.maxDist, hi));
    cam.pan=pan; viewerCams.set(viewerEl,cam);
  }catch(e){}
}
// 默认视角：正视 15°（pitch 15°，yaw 0）
function makeDefaultCam(){return{yaw:0,pitch:Math.PI/12,dist:1500,pan:{x:0,y:0},isDrag:false,lastX:0,lastY:0};}
let panHotkey=false;addEventListener('keydown',e=>{if(e.key===' '||e.key==='Shift'){panHotkey=true;}});addEventListener('keyup',e=>{if(e.key===' '||e.key==='Shift'){panHotkey=false;}});
function attachViewerInteractions(viewerEl,cam){const cv=viewerEl.querySelector('canvas');cv.addEventListener('contextmenu',e=>e.preventDefault());
  cv.addEventListener('mousedown',e=>{if(e.button!==0)return;cam.isDrag=true;cam.lastX=e.clientX;cam.lastY=e.clientY;});
  addEventListener('mouseup',()=>{cam.isDrag=false;});
  addEventListener('mousemove',e=>{if(!cam.isDrag)return;const dx=e.clientX-cam.lastX,dy=e.clientY-cam.lastY;cam.lastX=e.clientX;cam.lastY=e.clientY;if(panHotkey){cam.pan.x+=dx;cam.pan.y+=dy;}else{cam.yaw+=dx*0.005;cam.pitch+=dy*0.005;cam.pitch=Math.max(-1.4,Math.min(1.4,cam.pitch));}renderScene();});
  cv.addEventListener('wheel',e=>{cam.dist*=(1+Math.sign(e.deltaY)*0.1);cam.dist=Math.max(300,Math.min(5000,cam.dist));renderScene();});
}
function setRenderTarget(cv){canvas=cv;ctx=cv.getContext('2d');}
let yaw=0.6,pitch=0.4,dist=1500;let screenPan={x:0,y:0};function useCam(cam){yaw=cam.yaw;pitch=cam.pitch;dist=cam.dist;screenPan=cam.pan;}
function rotY(p,a){const c=Math.cos(a),s=Math.sin(a);return{x:c*p.x+s*p.z,y:p.y,z:-s*p.x+c*p.z}}
function rotX(p,a){const c=Math.cos(a),s=Math.sin(a);return{x:p.x,y:c*p.y-s*p.z,z:s*p.y+c*p.z}}
function project(p){const f=800/Math.max(1,(p.z+dist));return{x:canvas.width/2+p.x*f+screenPan.x,y:canvas.height/2-p.y*f+screenPan.y};}
function drawLine(a,b,color='#111',w=1){const A=project(a),B=project(b);ctx.strokeStyle=color;ctx.lineWidth=w;ctx.beginPath();ctx.moveTo(A.x,A.y);ctx.lineTo(B.x,B.y);ctx.stroke()}
function drawText3D(text,p,color='#111',bg='rgba(255,255,255,.7)'){const s=project(p);ctx.font='12px system-ui,Arial';ctx.textBaseline='top';const w=ctx.measureText(text).width+6,h=16;ctx.fillStyle=bg;ctx.fillRect(s.x-3,s.y-2,w,h);ctx.strokeStyle='rgba(0,0,0,.2)';ctx.strokeRect(s.x-3,s.y-2,w,h);ctx.fillStyle=color;ctx.fillText(text,s.x,s.y);}
function darkenColor(hex,f=0.7){try{let h=hex.replace('#','');if(h.length===3){h=h.split('').map(x=>x+x).join('');}const r=parseInt(h.slice(0,2),16),g=parseInt(h.slice(2,4),16),b=parseInt(h.slice(4,6),16);const rd=Math.max(0,Math.min(255,Math.floor(r*f))),gd=Math.max(0,Math.min(255,Math.floor(g*f))),bd=Math.max(0,Math.min(255,Math.floor(b*f)));return '#'+rd.toString(16).padStart(2,'0')+gd.toString(16).padStart(2,'0')+bd.toString(16).padStart(2,'0');}catch(e){return hex;}}
function lightenColor(hex,f=1.15){try{let h=hex.replace('#','');if(h.length===3){h=h.split('').map(x=>x+x).join('');}const r=parseInt(h.slice(0,2),16),g=parseInt(h.slice(2,4),16),b=parseInt(h.slice(4,6),16);const rl=Math.max(0,Math.min(255,Math.floor(r*f))),gl=Math.max(0,Math.min(255,Math.floor(g*f))),bl=Math.max(0,Math.min(255,Math.floor(b*f)));return '#'+rl.toString(16).padStart(2,'0')+gl.toString(16).padStart(2,'0')+bl.toString(16).padStart(2,'0');}catch(e){return hex;}}
function hexToRgb(hex){try{let h=hex.replace('#','');if(h.length===3){h=h.split('').map(x=>x+x).join('');}return {r:parseInt(h.slice(0,2),16),g:parseInt(h.slice(2,4),16),b:parseInt(h.slice(4,6),16)};}catch(e){return null;}}
// 透明度强度参数（顶部/中部/底部会按比例分配）
let GRADIENT_ALPHA=0.15;
// 全局渲染队列：按面深度统一排序，避免多实体之间的穿模
let __RENDER_QUEUE__=[];
function enqueuePolygon(poly3d, fill, stroke){
  const d=poly3d.reduce((s,p)=>s+p.z,0)/Math.max(1,poly3d.length);
  __RENDER_QUEUE__.push({poly3d,fill,stroke,d});
}
function flushRenderQueue(){
  if(!__RENDER_QUEUE__.length) return;
  __RENDER_QUEUE__.sort((a,b)=>a.d-b.d);
  __RENDER_QUEUE__.forEach(({poly3d,fill,stroke})=>{
    const poly=poly3d.map(project);
    ctx.beginPath(); ctx.moveTo(poly[0].x,poly[0].y);
    for(let i=1;i<poly.length;i++){ ctx.lineTo(poly[i].x,poly[i].y); }
    ctx.closePath();
    let fs=fill;
    if(typeof fill==='string' && /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(fill)){
      const ys=poly.map(p=>p.y); const minY=Math.min(...ys), maxY=Math.max(...ys);
      const y0=minY, y1=(maxY-minY<1?minY+1:maxY);
      const grad=ctx.createLinearGradient(0,y0,0,y1);
      const cTop=hexToRgb(lightenColor(fill,1.12));
      const cMid=hexToRgb(fill);
      const cBot=hexToRgb(darkenColor(fill,0.88));
      const base=GRADIENT_ALPHA;
      const aTop=Math.max(0,Math.min(1, base*0.60));
      const aMid=Math.max(0,Math.min(1, base*1.00));
      const aBot=Math.max(0,Math.min(1, base*1.40));
      if(cTop&&cMid&&cBot){
        grad.addColorStop(0, `rgba(${cTop.r},${cTop.g},${cTop.b},${aTop})`);
        grad.addColorStop(0.5, `rgba(${cMid.r},${cMid.g},${cMid.b},${aMid})`);
        grad.addColorStop(1, `rgba(${cBot.r},${cBot.g},${cBot.b},${aBot})`);
        fs=grad;
      }
    }
    ctx.fillStyle=fs; ctx.fill(); ctx.strokeStyle=stroke; ctx.lineWidth=1; ctx.stroke();
  });
  __RENDER_QUEUE__=[];
}
function drawPrismSolid(origin,L,H,W,fill='#4a90e2',stroke='#222'){const pts=[];const P=(x,y,z)=>({x:origin.x+x,y:origin.y+y,z:origin.z+z});
  pts.push(P(0,0,0),P(L,0,0),P(L,H,0),P(0,H,0),P(0,0,W),P(L,0,W),P(L,H,W),P(0,H,W));
  for(let i=0;i<pts.length;i++){pts[i]=rotX(rotY(pts[i],yaw),pitch)}
  const faces=[[0,1,2,3],[4,5,6,7],[0,3,7,4],[1,5,6,2],[0,1,5,4],[3,2,6,7]]; // front, back, left, right, bottom, top
  faces.forEach((f)=>{ const poly3d=f.map(i=>pts[i]); enqueuePolygon(poly3d, fill, stroke); });
}
// 楔形（用于驾驶室斜面前脸）：在X方向存在前脸斜切
function drawWedgeSolid(origin,L,H,W,chamfer=0.3,fill='#d9c5a8',stroke='#8e6a44'){
  // chamfer 表示前脸斜切比例 [0..0.9]，越大越尖
  chamfer=Math.max(0,Math.min(0.9,parseFloat(chamfer)||0));
  const cut=L*chamfer;
  const P=(x,y,z)=>({x:origin.x+x,y:origin.y+y,z:origin.z+z});
  const pts=[
    P(0,0,0),            // 0 后-左-内
    P(L,0,0),            // 1 前-左-内（将被斜切）
    P(L,H,0),            // 2 前-左-外
    P(0,H,0),            // 3 后-左-外
    P(0,0,W),            // 4 后-右-内
    P(L,0,W),            // 5 前-右-内（将被斜切）
    P(L,H,W),            // 6 前-右-外
    P(0,H,W),            // 7 后-右-外
    // 斜切面顶点（靠近前脸，向后退 cut）
    P(L-cut,0,0),        // 8 斜面-左-下
    P(L-cut,H,0),        // 9 斜面-左-上
    P(L-cut,0,W),        // 10 斜面-右-下
    P(L-cut,H,W),        // 11 斜面-右-上
  ];
  // 应用旋转
  for(let i=0;i<pts.length;i++){pts[i]=rotX(rotY(pts[i],yaw),pitch)}
  // 面定义：后面、顶部、底部、左侧、右侧、斜面
  const faces=[
    [0,4,7,3],        // 后面
    [3,7,11,9],       // 顶部（后顶到斜面顶）
    [0,8,10,4],       // 底部（后底到斜面底）
    [0,3,9,8],        // 左侧（后左到斜面左）
    [4,10,11,7],      // 右侧（后右到斜面右）
    [8,9,11,10],      // 斜面
  ];
  faces.forEach((f)=>{ const poly3d=f.map(i=>pts[i]); enqueuePolygon(poly3d, fill, stroke); });
}
// 圆柱（薄轮胎）实心：轴向为Z（厚度方向），半径在XY平面
function drawCylinderSolid(center, radius=100, thickness=80, fill='#333', stroke='#151515', sides=24){
  const ptsFront=[]; const ptsBack=[];
  for(let i=0;i<sides;i++){const ang=i*2*Math.PI/sides; const x=center.x+radius*Math.cos(ang); const y=center.y+radius*Math.sin(ang); ptsFront.push({x,y,z:center.z}); ptsBack.push({x,y,z:center.z+thickness});}
  for(let i=0;i<sides;i++){ptsFront[i]=rotX(rotY(ptsFront[i],yaw),pitch); ptsBack[i]=rotX(rotY(ptsBack[i],yaw),pitch);} 
  const faces=[]; faces.push({poly:ptsFront}); faces.push({poly:ptsBack});
  for(let i=0;i<sides;i++){const j=(i+1)%sides; faces.push({poly:[ptsFront[i],ptsFront[j],ptsBack[j],ptsBack[i]]}); }
  faces.forEach(({poly})=>{ enqueuePolygon(poly, fill, stroke); });
}
function drawBoxWire(origin,L,H,W,color='#111'){const pts=[];const P=(x,y,z)=>({x:origin.x+x,y:origin.y+y,z:origin.z+z});
  pts.push(P(0,0,0),P(L,0,0),P(L,H,0),P(0,H,0),P(0,0,W),P(L,0,W),P(L,H,W),P(0,H,W));
  for(let i=0;i<pts.length;i++){pts[i]=rotX(rotY(pts[i],yaw),pitch)}
  const e=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];e.forEach(([i,j])=>drawLine(pts[i],pts[j],color,1));
}

/************** 视图栈（托板→总览→每箱） **************/
let scenePacks=[],sceneBoxSize={L:600,W:450,H:330},sceneTotalProductMM3=0,sceneBoxCount=0,scenePalletInfo=null;
const viewerCams=new WeakMap();
function renderDashboardBar(){
  try{
    const totalBoxes=(Array.isArray(scenePacks)&&scenePacks.length)?scenePacks.length:(sceneBoxCount||0);
    const perPallet=(scenePalletInfo&&scenePalletInfo.perLayer>0)?(scenePalletInfo.perLayer*Math.max(1,scenePalletInfo.layers||1)):0;
    const totalVolM3=(typeof computeTotalBoxVolumeM3==='function')?computeTotalBoxVolumeM3():0;
    let truckName='—';
    if(totalVolM3>0 && Array.isArray(HUOLALA_TRUCKS)){
      const trucks=[...HUOLALA_TRUCKS].sort((a,b)=>a.vol-b.vol);
      const best=trucks.find(t=>t.vol>=totalVolM3)||trucks[trucks.length-1];
      truckName=best&&best.name?best.name:'—';
    }
    const elBoxes=document.getElementById('dashTotalBoxes'); if(elBoxes) elBoxes.textContent=String(totalBoxes);
    const elPer=document.getElementById('dashPerPallet'); if(elPer) elPer.textContent=perPallet?String(perPallet):'—';
    const elVol=document.getElementById('dashTotalVol'); if(elVol) elVol.textContent=totalVolM3? (totalVolM3.toFixed(2)+' m³') : '—';
    const elTruck=document.getElementById('dashTruckName'); if(elTruck) elTruck.textContent=truckName;
  }catch(e){ /* no-op */ }
}
function buildViewerStack(){
  const stack=document.getElementById('viewerStack');stack.innerHTML='';
  const grid=document.createElement('div');grid.className='viewer-grid';stack.appendChild(grid);
  // 更新右侧仪表盘数据（构建前刷新一次，保证空栈时也正确显示）
  renderDashboardBar();
  // 0) 车辆装载预览（优先显示）
  (function(){
    const count=(scenePacks.length||sceneBoxCount||0);
    if(!count) return;
    const trucks=[...HUOLALA_TRUCKS].sort((a,b)=>a.vol-b.vol);
    const totalM3=computeTotalBoxVolumeM3();
    if(!totalM3||totalM3<=0) return;
    const best=trucks.find(t=>t.vol>=totalM3)||trucks[trucks.length-1];
    const card=document.createElement('div');card.className='viewer-card span-2';
    const tt=document.createElement('h4');tt.className='h title';tt.textContent=`车辆装载预览（推荐：${best.name}）`;
    const tv=document.createElement('div');tv.className='viewer';tv.dataset.bi='truck-best';
    tv.innerHTML=`<div class="legend" data-i18n="viewer.controls"></div><canvas></canvas><div class="resizer" data-i18n-title="viewer.resizerTip"></div>`;
    card.appendChild(tt);card.appendChild(tv);grid.appendChild(card);
    const camT=makeDefaultCam();viewerCams.set(tv,camT);attachResizer(tv);attachViewerInteractions(tv,camT);
    // 保存用于渲染
    window.__TRUCK_SUGGEST__={best, totalM3};
    // 初始按车厢L×W设定视窗高度
    try{setViewerAspectByLW(tv,best.L*1000,best.W*1000);}catch(e){}
    attachAdaptHeightBtn(tv);
    attachAdaptByCamBtn(tv);
    attachAdaptByCamPreciseBtn(tv);
    attachFitCameraBtn(tv);
    adaptViewerHeightByBI(tv);
    // 相机距离拟合到内容包围盒
    fitCameraToContent(tv,{tight:0.92});
  })();
  // 1) 托板首行固定
  const pal=document.createElement('div');pal.className='viewer-card span-2';
  const pt=document.createElement('h4');pt.className='h title';pt.textContent='托板预览（首行固定）';
  const pv=document.createElement('div');pv.className='viewer';pv.dataset.bi='pallet';
  pv.innerHTML=`<div class="legend" data-i18n="viewer.controls"></div><canvas></canvas><div class="resizer" data-i18n-title="viewer.resizerTip"></div>`;
  pal.appendChild(pt);pal.appendChild(pv);grid.appendChild(pal);
  const camP=makeDefaultCam();viewerCams.set(pv,camP);attachResizer(pv);attachViewerInteractions(pv,camP);
  // 初始按托板L×W设定视窗高度
  try{const pL=parseFloat(document.getElementById('pL').value)||1200; const pW=parseFloat(document.getElementById('pW').value)||1000; setViewerAspectByLW(pv,pL,pW);}catch(e){}
  attachAdaptHeightBtn(pv);
  attachAdaptByCamBtn(pv);
  attachAdaptByCamPreciseBtn(pv);
  attachFitCameraBtn(pv);
  // 相机距离拟合到内容包围盒（更贴近视窗）
  fitCameraToContent(pv,{tight:0.96});

  // 每托板视图：与“每箱”统一为标准卡片布局，独立并列展示
  const hasPacks=scenePacks.length>0;
  if(hasPacks && scenePalletInfo && scenePalletInfo.perLayer>0){
    const perPallet=scenePalletInfo.perLayer*Math.max(1,scenePalletInfo.layers||1);
    const totalBoxes=scenePacks.length||sceneBoxCount||0;
    const need=perPallet>0?Math.ceil(totalBoxes/perPallet):0;
    if(need>0){
      for(let i=1;i<=need;i++){
        const w=document.createElement('div');w.className='viewer-card';
        const t=document.createElement('h4');t.className='h title';t.textContent=`托板 ${i}`;
        const v=document.createElement('div');v.className='viewer';v.dataset.bi=`pallet-${i}`;
        v.innerHTML=`<div class=\"legend\" data-i18n=\"viewer.controls\"></div><canvas></canvas><div class=\"resizer\" data-i18n-title=\"viewer.resizerTip\"></div>`;
        w.appendChild(t);w.appendChild(v);grid.appendChild(w);
        const camX=makeDefaultCam();viewerCams.set(v,camX);attachResizer(v);attachViewerInteractions(v,camX);
        // 视图默认按托板尺寸自适配高度
        adaptViewerHeightByBI(v);
        attachFitCameraBtn(v);
        // 相机距离拟合到内容包围盒，与每箱视图一致
        fitCameraToContent(v,{tight:0.92});
      }
    }
  }
  // 2) 总览（跨两列）
  const wrap=document.createElement('div');wrap.className='viewer-card span-2';
  const title=document.createElement('h4');title.className='h title';title.textContent='总览';
  const viewer=document.createElement('div');viewer.className='viewer';viewer.dataset.bi='overview';
  viewer.innerHTML=`<div class="legend" data-i18n="viewer.controls"></div><canvas></canvas><div class="resizer" data-i18n-title="viewer.resizerTip"></div>`;
  wrap.appendChild(title);wrap.appendChild(viewer);grid.appendChild(wrap);
  const cam=makeDefaultCam();viewerCams.set(viewer,cam);attachResizer(viewer);attachViewerInteractions(viewer,cam);
  // 按外箱L×W设定总览视窗高度（近似）
  try{setViewerAspectByLW(viewer,sceneBoxSize.L,sceneBoxSize.W);}catch(e){}
  attachAdaptHeightBtn(viewer);
  attachAdaptByCamBtn(viewer);
  attachAdaptByCamPreciseBtn(viewer);
  attachFitCameraBtn(viewer);
  // 总览视图也执行一次通用自适配，保持与其他视图一致
  adaptViewerHeightByBI(viewer);
  // 相机距离拟合到内容包围盒
  fitCameraToContent(viewer,{tight:0.92});

  // （已移除）产品3D视图

  // 2.5) 车辆装载预览（已置顶显示，避免重复创建）

  // 3) 每箱
  if(hasPacks){
    for(let i=0;i<scenePacks.length;i++){
      const w=document.createElement('div');w.className='viewer-card';
      const t=document.createElement('h4');t.className='h title';t.textContent=`箱号 ${i+1}`;
      const v=document.createElement('div');v.className='viewer';v.dataset.bi=String(i+1);
      v.innerHTML=`<div class="legend" data-i18n="viewer.controls"></div><canvas></canvas><div class="resizer" data-i18n-title="viewer.resizerTip"></div>`;
      w.appendChild(t);w.appendChild(v);grid.appendChild(w);
      const cam2=makeDefaultCam();viewerCams.set(v,cam2);attachResizer(v);attachViewerInteractions(v,cam2);
      // 每箱视图默认按外箱尺寸自适配高度
      adaptViewerHeightByBI(v);
      attachFitCameraBtn(v);
      // 相机距离拟合到内容包围盒
      fitCameraToContent(v,{tight:0.92});
    }
  }
  resizeAllCanvases();
  // 构建完成后，兜底执行一次对所有视图的高度自适配
  try{ document.querySelectorAll('.viewer').forEach(adaptViewerHeightByBI); }catch(e){}
  // 若处于自由摆放模式，初始化拖拽位置
  try{ const free = !!(localStorage.getItem('viewer:free')==='1'); if(free){ enableViewerFreeLayout(); } }catch(e){}
}

// 自由摆放模式：启用
function enableViewerFreeLayout(){
  const stack=document.getElementById('viewerStack'); const grid=stack.querySelector('.viewer-grid'); if(!grid) return;
  stack.classList.add('free');
  const gr=grid.getBoundingClientRect();
  const cards=[...grid.children].filter(el=>el.classList && el.classList.contains('viewer-card'));
  cards.forEach((card,idx)=>{
    const r=card.getBoundingClientRect();
    card.style.position='absolute';
    card.style.left=Math.max(0,r.left-gr.left)+"px";
    card.style.top=Math.max(0,r.top-gr.top)+"px";
    card.style.width=r.width+"px";
    if(!card.dataset.vid) card.dataset.vid='vc'+idx;
    attachCardDrag(card,grid);
  });
  updateGridHeight(grid);
  try{localStorage.setItem('viewer:free','1');}catch(e){}
}
// 退出自由摆放：重建为网格
function disableViewerFreeLayout(){
  const stack=document.getElementById('viewerStack'); if(!stack) return; stack.classList.remove('free');
  try{localStorage.setItem('viewer:free','0');}catch(e){}
  buildViewerStack(); renderScene();
}
function attachCardDrag(card,grid){
  const handle=card.querySelector('.title')||card; let dragging=false,sx=0,sy=0,sl=0,st=0; let lastSafeLeft=0,lastSafeTop=0;
  const MARGIN=8; const GRID=16;
  try{ card.style.transition='left 120ms ease-out, top 120ms ease-out, outline-color 120ms ease-out'; }catch(e){}
  function rectsOverlap(a,b){ return a.left < b.left + b.width && a.left + a.width > b.left && a.top < b.top + b.height && a.top + a.height > b.top; }
  function findCollision(left,top){
    const gr=grid.getBoundingClientRect();
    const w=card.getBoundingClientRect().width; const h=card.getBoundingClientRect().height;
    const cur={left,top,width:w,height:h};
    const cards=[...grid.querySelectorAll('.viewer-card')].filter(c=>c!==card);
    for(const c of cards){ const rc=c.getBoundingClientRect(); const ob={left:rc.left-gr.left, top:rc.top-gr.top, width:rc.width, height:rc.height}; if(rectsOverlap(cur,ob)) return ob; }
    return null;
  }
  function clamp(left,top){ const gr=grid.getBoundingClientRect(); const w=card.getBoundingClientRect().width; const h=card.getBoundingClientRect().height; return { left: Math.max(0,Math.min(left,gr.width-w)), top: Math.max(0,Math.min(top,gr.height-h)) }; }
  function snap(left,top){ return { left: Math.round(left/GRID)*GRID, top: Math.round(top/GRID)*GRID }; }
  function nearestFree(left,top){
    const gr=grid.getBoundingClientRect(); const w=card.getBoundingClientRect().width; const h=card.getBoundingClientRect().height;
    const MAX_R=8; // 搜索8圈，足够在密集布局中找到空位
    const base=clamp(left,top);
    const s0=snap(base.left, base.top);
    if(!findCollision(s0.left,s0.top)) return s0;
    for(let r=1;r<=MAX_R;r++){
      for(let dx=-r; dx<=r; dx++){
        for(let dy=-r; dy<=r; dy++){
          if(dx===0 && dy===0) continue;
          let cand={ left: s0.left + dx*GRID, top: s0.top + dy*GRID };
          cand=clamp(cand.left, cand.top);
          cand=snap(cand.left, cand.top);
          if(!findCollision(cand.left, cand.top)) return cand;
        }
      }
    }
    return s0; // 找不到更好位置则返回原始吸附点
  }
  function onMove(e){
    if(!dragging) return;
    const dx=(e.clientX-sx), dy=(e.clientY-sy);
    let nx=sl+dx, ny=st+dy;
    let {left,top}=clamp(nx,ny);
    ({left,top}=snap(left,top));
    let hit=findCollision(left,top);
    if(hit){
      // 优先按照移动方向避让：水平移动向右贴边，垂直移动向下贴边
      const preferHoriz = Math.abs(dx) >= Math.abs(dy);
      const candidates=[];
      if(preferHoriz){
        candidates.push(clamp(hit.left+hit.width+MARGIN, top)); // 右
        candidates.push(clamp(hit.left - card.getBoundingClientRect().width - MARGIN, top)); // 左
        candidates.push(clamp(left, hit.top+hit.height+MARGIN)); // 下
        candidates.push(clamp(left, hit.top - card.getBoundingClientRect().height - MARGIN)); // 上
      }else{
        candidates.push(clamp(left, hit.top+hit.height+MARGIN)); // 下
        candidates.push(clamp(left, hit.top - card.getBoundingClientRect().height - MARGIN)); // 上
        candidates.push(clamp(hit.left+hit.width+MARGIN, top)); // 右
        candidates.push(clamp(hit.left - card.getBoundingClientRect().width - MARGIN, top)); // 左
      }
      let placed=null;
      for(let cand of candidates){ const s=snap(cand.left,cand.top); if(!findCollision(s.left,s.top)){ placed=s; break; } }
      if(!placed){ placed=nearestFree(left,top); }
      if(placed && !findCollision(placed.left,placed.top)){
        card.style.outline='';
        left=placed.left; top=placed.top;
        lastSafeLeft=left; lastSafeTop=top;
      }else{
        // 仍无法摆放到非重叠位置，回退到上一个安全位置
        left=lastSafeLeft; top=lastSafeTop;
        card.style.outline='2px solid #e53935';
      }
    }else{
      card.style.outline='';
      lastSafeLeft=left; lastSafeTop=top;
    }
    card.style.left=left+'px'; card.style.top=top+'px';
  }
  function onUp(){ if(!dragging) return; dragging=false; card.style.outline=''; document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp); updateGridHeight(grid); }
  handle.addEventListener('mousedown',e=>{ dragging=true; const cs=getComputedStyle(card); sx=e.clientX; sy=e.clientY; sl=parseInt(cs.left)||0; st=parseInt(cs.top)||0; lastSafeLeft=sl; lastSafeTop=st; document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp); e.preventDefault(); });
}
function updateGridHeight(grid){ let maxB=0; grid.querySelectorAll('.viewer-card').forEach(card=>{ const ct=parseInt(card.style.top)||0; const ch=card.getBoundingClientRect().height; maxB=Math.max(maxB, ct+ch); }); grid.style.height=(maxB+20)+'px'; }

// 工具栏事件绑定
document.addEventListener('DOMContentLoaded',()=>{
  try{
    const tgl=document.getElementById('freeLayoutToggle'); const rst=document.getElementById('freeLayoutReset');
    function sync(){
      const on = !!(localStorage.getItem('viewer:free')==='1');
      if(tgl){
        const t = (window.__i18n && typeof window.__i18n.t==='function') ? window.__i18n.t : (k=>k);
        tgl.textContent = on ? t('viewer.free.disable') : t('viewer.free.enable');
      }
    }
    tgl && tgl.addEventListener('click',()=>{ const on = !!(localStorage.getItem('viewer:free')==='1'); if(on){ disableViewerFreeLayout(); } else { enableViewerFreeLayout(); } sync(); });
    rst && rst.addEventListener('click',()=>{ disableViewerFreeLayout(); sync(); });
    sync();

    const paramTgl=document.getElementById('paramTextToggle');
    const prodTgl=document.getElementById('product3DTextToggle');
    if(paramTgl){ paramTgl.addEventListener('change',()=>{ try{localStorage.setItem('viewer:showParams', paramTgl.checked?'1':'0');}catch(e){} renderScene(); }); }
    if(prodTgl){ prodTgl.addEventListener('change',()=>{ try{localStorage.setItem('viewer:showProdText', prodTgl.checked?'1':'0');}catch(e){} renderScene(); }); }
  }catch(e){}
});

function renderScene(){
  const stack=document.getElementById('viewerStack');const viewers=[...stack.querySelectorAll('.viewer')];if(viewers.length===0) return;
const boxColor=(document.getElementById('boxColor')&&document.getElementById('boxColor').value)||'#fff';
  const packs=scenePacks.length?scenePacks:[{items:[]}];
  const unitSel=(document.getElementById('volUnit')&&document.getElementById('volUnit').value)||'m3';
  const boxVolMM3=sceneBoxSize.L*sceneBoxSize.W*sceneBoxSize.H;
  const fmtVol=(mm3)=>unitSel==='cm3'?(mm3/1000).toFixed(0)+'cm³':(mm3/1e9).toFixed(3)+'m³';

  viewers.forEach((v)=>{
    const cv=v.querySelector('canvas');setRenderTarget(cv);resizeCanvasFor(cv);
    const cam=viewerCams.get(v)||makeDefaultCam();useCam(cam);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const bi=v.dataset.bi;
    const weightEnabled=!!(document.getElementById('weightFeatureToggle')&&document.getElementById('weightFeatureToggle').checked);
    const showParams=!!(document.getElementById('paramTextToggle')&&document.getElementById('paramTextToggle').checked);
    const showProdText=!!(document.getElementById('product3DTextToggle')&&document.getElementById('product3DTextToggle').checked);

    const palletMatch = /^pallet(?:-(\d+))?$/.exec(bi||'');
    if(palletMatch){
      const palletIndex = Math.max(1, parseInt(palletMatch[1]||'1',10));
      // 托板预览：绘制托板与单层外箱铺设（避免穿模：使用实心面渲染）
      const unit=document.getElementById('unitSelect').value;
      const CL=toMM(document.getElementById('cL').value,unit);
      const CW=toMM(document.getElementById('cW').value,unit);
      const CH=toMM(document.getElementById('cH').value,unit);
      const pL=toMM(document.getElementById('pL').value||0,unit);
      const pW=toMM(document.getElementById('pW').value||0,unit);
      const pH=toMM(document.getElementById('pH').value||0,unit);
      if(!(CL&&CW&&pL&&pW)){
        const t=(window.__i18n&&window.__i18n.t)?window.__i18n.t:(k=>k);
        drawText3D(t('viewer.require.boxPallet'),rotX(rotY({x:0,y:0,z:0},yaw),pitch));
        return;
      }
      const settings=getPalletSettings(unit);
      const layout=calcPalletLayerLayout({pL,pW},{CL,CW,CH},settings);
      const layers=pH>0?Math.max(1,Math.floor(pH/CH)):1;
      const perLayer=layout.count; const perPallet=perLayer*layers;
      // 居中放置
      const off={x:-pL/2,y:0,z:-pW/2};
      // 托板厚度固定 120mm 可视化
      const palletFill=(document.getElementById('palletColor')&&document.getElementById('palletColor').value)||'#8d6e63';
      const palletStroke=darkenColor(palletFill,0.6);
      drawPrismSolid({x:off.x,y:-60,z:off.z},pL,120,pW,palletFill,palletStroke);
      // 按限高分层绘制外箱（实心面），并根据总箱数分批显示
      const totalBoxes=sceneBoxCount||0;
      const start=(palletIndex-1)*perPallet;
      const remain=Math.max(0,totalBoxes-start);
      const drawCount=Math.min(remain, perPallet);
      const boxFill=(document.getElementById('boxColor')&&document.getElementById('boxColor').value)||'#4a90e2';
      let n=0; for(let l=0;l<layers;l++){ for(let i=0;i<layout.positions.length;i++){ if(n>=drawCount) break; const pos=layout.positions[i]; drawPrismSolid({x:off.x+pos.x,y:l*CH,z:off.z+pos.z},pos.L,CH,pos.W,boxFill,'#1a1a1a'); n++; } }
      flushRenderQueue();
      // 文案
      const leg=v.querySelector('.legend');
      const t=(window.__i18n&&window.__i18n.t)?window.__i18n.t:(k=>k);
      if(showParams){
        const unitMM = 'mm';
        const perTruckUnit = (window.__i18n&&window.__i18n.t)?window.__i18n.t('viewer.unit.boxes'):'箱';
        leg.textContent=`${t('viewer.controls')}
${t('viewer.legend.pallet.size')}: ${pL}×${pW} (${unitMM})
${t('viewer.legend.box.size')}: ${CL}×${CW}×${CH} (${unitMM})
${t('viewer.legend.pattern')}: ${(settings.pattern||'auto')}
${t('viewer.legend.perLayer')}: ${perLayer} ${perTruckUnit}（${t('viewer.legend.orientation')}: ${layout.orientation}）
${t('viewer.legend.layers')}: ${layers}
${t('viewer.legend.perPallet')}: ${perPallet} ${perTruckUnit}
${t('viewer.legend.viewBoxesWithTotal')}: ${drawCount} ${perTruckUnit}（${t('viewer.legend.totalBoxes')}: ${totalBoxes}，${t('viewer.legend.palletIndexPrefix')} ${palletIndex} ${t('viewer.legend.palletIndexSuffix')}）`;
      }else{
        leg.textContent=t('viewer.controls');
      }
      // 标注
      if(showParams){
        const t=(window.__i18n&&window.__i18n.t)?window.__i18n.t:(k=>k);
        drawText3D(`${t('viewer.palletLabel')} ${palletIndex}`,rotX(rotY({x:0,y:80,z:0},yaw),pitch));
      }
      return;
    }

    // 车辆装载预览：根据推荐车型内尺寸，按地面网格 + 层数堆叠绘制外箱
    if(bi==='truck-best'){
      const sug=window.__TRUCK_SUGGEST__||{}; const best=sug.best; if(!best){ const t=(window.__i18n&&window.__i18n.t)?window.__i18n.t:(k=>k); drawText3D(t('viewer.noTruck'),rotX(rotY({x:0,y:0,z:0},yaw),pitch)); return; }
      const unit=document.getElementById('unitSelect').value;
      const CL=toMM(document.getElementById('cL').value,unit);
      const CW=toMM(document.getElementById('cW').value,unit);
      const CH=toMM(document.getElementById('cH').value,unit);
      if(!(CL&&CW&&CH)){
        const t=(window.__i18n&&window.__i18n.t)?window.__i18n.t:(k=>k);
        drawText3D(t('viewer.require.box'),rotX(rotY({x:0,y:0,z:0},yaw),pitch));
        return;
      }
      const tL=best.L*1000, tW=best.W*1000, tH=best.H*1000; // m → mm
      const marginX=200, marginY=150, gap=20; // 留出边距与通道
      const effL=tL-2*marginX, effW=tW-2*marginY;
      const nx=Math.max(0,Math.floor((effL+gap)/(CL+gap)));
      const ny=Math.max(0,Math.floor((effW+gap)/(CW+gap)));
      const layers=Math.max(1,Math.floor(tH/CH));
      const perLayer=nx*ny; const perTruck=perLayer*layers; const totalBoxes=sceneBoxCount||0; const drawCount=Math.min(perTruck,totalBoxes);
      const ox=marginX + (effL - nx*CL - (nx-1)*gap)/2; const oz=marginY + (effW - ny*CW - (ny-1)*gap)/2;
      const off={x:-tL/2,y:-tH/2,z:-tW/2};
      // 绘制车厢实体（半透明）
      const bodyFill='#d7e3fc'; const bodyStroke='#648fde';
      drawPrismSolid({x:off.x,y:off.y,z:off.z},tL,tH,tW,bodyFill,bodyStroke);
      // 驾驶室斜面：默认启用，按车型尺寸自动匹配斜率
      const cabL=Math.max(400,Math.floor(tL*0.22)), cabH=Math.floor(tH*0.75), cabW=Math.floor(tW*0.9);
      const cabFill='#f2d7b6', cabStroke='#b28756';
      const ar=tH/(tL||1); const cabChamferRatio=Math.min(0.45,Math.max(0.25,0.3+0.2*(ar-0.15)));
      drawWedgeSolid({x:off.x+tL+120,y:off.y,z:off.z+(tW-cabW)/2},cabL,cabH,cabW,cabChamferRatio,cabFill,cabStroke);
      // 简化挡风玻璃（保留）
      const winL=Math.floor(cabL*0.6), winH=Math.floor(cabH*0.45), winW=Math.floor(cabW*0.1);
      drawPrismSolid({x:off.x+tL+120+Math.floor(cabL*0.2),y:off.y+Math.floor(cabH*0.45),z:off.z+(tW-winW)/2},winL,winH,winW,'#aee7ff','#5aa6cc');
      // 圆形车轮（默认参数）
      const wheelCount=6, wheelDist='even', wheelR=180, wheelT=120;
      const axleCount=Math.max(1,Math.floor(wheelCount/2));
      let xStart=off.x+tL*0.18, xEnd=off.x+tL*0.82;
      const positions=[]; for(let i=0;i<axleCount;i++){ const t=axleCount>1? i/(axleCount-1) : 0.5; positions.push(xStart + (xEnd-xStart)*t); }
      const r=wheelR, thick=wheelT; const zLeft=off.z - thick/2 - 30, zRight=off.z + tW + thick/2 + 30; const yCenter=off.y - 80;
      positions.forEach(x=>{ drawCylinderSolid({x,y:yCenter,z:zLeft},r,thick,'#333','#151515'); drawCylinderSolid({x,y:yCenter,z:zRight},r,thick,'#333','#151515'); });
      
      // 绘制外箱
      const boxFill=(document.getElementById('boxColor')&&document.getElementById('boxColor').value)||'#4a90e2';
      let n=0; for(let l=0;l<layers;l++){ for(let iy=0;iy<ny;iy++){ for(let ix=0;ix<nx;ix++){ if(n>=drawCount) break; const x=off.x+ox+ix*(CL+gap), z=off.z+oz+iy*(CW+gap), y=off.y + l*CH; drawPrismSolid({x,y,z},CL,CH,CW,boxFill,'#1a1a1a'); n++; } } }
      flushRenderQueue();
      const leg=v.querySelector('.legend');
      const t=(window.__i18n&&window.__i18n.t)?window.__i18n.t:(k=>k);
      if(showParams){
        const unitM = 'm';
        const boxesUnit = t('viewer.unit.boxes');
        const boxPerTruckUnit = t('viewer.unit.boxPerTruck');
        leg.textContent=`${t('viewer.controls')}
${t('viewer.legend.truck.model')}: ${best.name}（≈ ${best.L}×${best.W}×${best.H} ${unitM}）
${t('viewer.legend.truck.layout')}: ${t('viewer.legend.perLayer')} ${perLayer}（${nx}×${ny}）× ${layers} ${t('viewer.legend.layers')} = ${perTruck}${boxPerTruckUnit}
${t('viewer.legend.truck.style')}: ${t('viewer.legend.truck.cabStyle')}
${t('viewer.legend.viewBoxesWithTotal')}: ${drawCount} ${boxesUnit}（${t('viewer.legend.totalBoxes')}: ${totalBoxes}）`;
      }else{
        leg.textContent=t('viewer.controls');
      }
      drawText3D(t('viewer.title.truck'),rotX(rotY({x:0,y:tH/2+20,z:0},yaw),pitch),'#111');
      return;
    }

    // （已移除）产品3D视图分支

    // 其他视图：外箱 + 装箱
    const off={x:-sceneBoxSize.L/2,y:-sceneBoxSize.H/2,z:-sceneBoxSize.W/2};
    drawBoxWire(off,sceneBoxSize.L,sceneBoxSize.H,sceneBoxSize.W,boxColor);

    let boxStats=null;
    if(bi!=='overview'){
      const idx=Math.max(0,parseInt(bi,10)-1);
      const box=packs[Math.min(idx,packs.length-1)]||packs[0];
      if(box&&box.items){
        let usedVol=0; const nameCounts=new Map();
        box.items.forEach(it=>{
          const c=it.color||'#1a73e8';
          const stroke=darkenColor(c,0.65);
          // 改为实体渐变：更直观的箱内产品展示
          drawPrismSolid({x:it.x+off.x,y:it.y+off.y,z:it.z+off.z}, it.L, it.H, it.W, c, stroke);
          usedVol+=(it.L*it.W*it.H);
          const nm=it.name||'未命名';nameCounts.set(nm,(nameCounts.get(nm)||0)+1);
          const lp={x:it.x+it.L/2+off.x,y:it.y+it.H+off.y+8,z:it.z+it.W/2+off.z};
          if(showProdText && (it.name||'').trim().length>0){
            drawText3D(it.name||'',rotX(rotY(lp,yaw),pitch),'#111');
          }
        });
        flushRenderQueue();
        boxStats={usedVol,nameCounts,weight:(typeof box.weight==='number'?box.weight:0)};
      }
    }

    const p=rotX(rotY({x:0,y:sceneBoxSize.H/2+10,z:0},yaw),pitch);
    if(showParams){
      drawText3D(bi==='overview'?'总览':`箱号 ${bi}`,p,'#111');
    }

    const leg=v.querySelector('.legend');
    let base = (window.__i18n && window.__i18n.t) ? window.__i18n.t('viewer.controls') : '操作：左键旋转 | 空格/Shift 平移 | 滚轮缩放';
    const totalBoxes=scenePacks.length||sceneBoxCount||0;
    const totalBoxVol=boxVolMM3*totalBoxes;
    const prodVol=sceneTotalProductMM3||0;
    const util=totalBoxVol>0?(prodVol/totalBoxVol*100):0;
    if(bi==='overview'&&scenePacks.length){
      base+=`\n总体积: ${fmtVol(totalBoxVol)}\n箱数: ${totalBoxes}\n产品总体积: ${fmtVol(prodVol)}\n装箱利用率: ${util.toFixed(1)}%`;
      if(weightEnabled){const totalW=(scenePacks||[]).reduce((s,b)=>s+(b.weight||0),0);base+=`\n所有箱子总重量: ${totalW.toFixed(2)} kg`;}
      if(scenePalletInfo&&scenePalletInfo.perLayer>0){
        const perPallet=scenePalletInfo.perLayer*Math.max(1,scenePalletInfo.layers);
        const need=perPallet>0?Math.ceil(totalBoxes/perPallet):0;
        const last=perPallet>0?(totalBoxes%perPallet||(totalBoxes?perPallet:0)):0;
        base+=`\n托板: 每层 ${scenePalletInfo.perLayer} 箱 × ${scenePalletInfo.layers||1} 层 = ${perPallet} /托\n需托数: ${need} 托（最后一托 ${last} 箱，取向:${scenePalletInfo.orientation}）`;
      }
    }else if(boxStats){
      const utilB=boxVolMM3>0?(boxStats.usedVol/boxVolMM3*100):0;
      const remain=Math.max(0,boxVolMM3-boxStats.usedVol);
      const listStr=[...boxStats.nameCounts.entries()].map(([n,c])=>`- ${n} × ${c}`).join('\n')||'无';
      base+=`\n外箱体积: ${fmtVol(boxVolMM3)}\n利用率: ${utilB.toFixed(1)}%`;
      if(weightEnabled){base+=`\n重量: ${(boxStats.weight||0).toFixed(2)} kg`;}
      base+=`\n剩余体积: ${fmtVol(remain)}\n产品:\n${listStr}`;
    }else{
      base+=`\n外箱体积: ${fmtVol(boxVolMM3)}`;
    }
    leg.textContent = showParams ? base : ((window.__i18n && window.__i18n.t) ? window.__i18n.t('viewer.controls') : '操作：左键旋转 | 空格/Shift 平移 | 滚轮缩放');
  });
}

/************** 计算与摆放（含混装/限重/优化） **************/
function orientations(L,W,H){const o=[{L:L,W:W,H:H},{L:L,W:H,H:W},{L:W,W:L,H:H},{L:W,W:H,H:L},{L:H,W:L,H:W},{L:H,W:W,H:L}];
  const out=[];const seen=new Set();o.forEach(d=>{const k=d.L+'x'+d.W+'x'+d.H;if(!seen.has(k)){seen.add(k);out.push(d);}});return out;}
function bestPerBox(CL,CW,CH,L,W,H){let best={count:0,dim:{L:L,W:W,H:H}};orientations(L,W,H).forEach(d=>{const nx=Math.floor(CL/d.L),ny=Math.floor(CW/d.W),nz=Math.floor(CH/d.H);const c=nx*ny*nz;if(c>best.count){best={count:c,dim:{L:d.L,W:d.W,H:d.H}}}});return best;}
function effectiveType(t){const pasteOn=!!(document.getElementById('classPasteOnly')&&document.getElementById('classPasteOnly').checked);
  const hazOn=!!(document.getElementById('classHazOnly')&&document.getElementById('classHazOnly').checked);
  if(t==='paste'&&!pasteOn)return'normal'; if(t==='haz'&&!hazOn)return'normal'; return t||'normal';}
function calcPalletInfo(CL,CW,CH,unit){const pL=toMM(document.getElementById('pL').value,unit);
  const pW=toMM(document.getElementById('pW').value,unit);const pH=toMM(document.getElementById('pH').value||0,unit);
  if(!(pL&&pW)) return null; const settings=getPalletSettings(unit);
  const layout=calcPalletLayerLayout({pL,pW}, {CL,CW,CH}, settings);
  const perLayer=(layout&&layout.count)||0; const orientation=(layout&&layout.orientation)||'0°'; const layers=pH>0?Math.max(1,Math.floor(pH/CH)):1;return{pL,pW,pH,perLayer,layers,orientation,layout};}

function getPalletSettings(unit){return{
  pattern:(document.getElementById('pPattern')&&document.getElementById('pPattern').value)||'auto',
  marginX:toMM(document.getElementById('pMarginX')?document.getElementById('pMarginX').value:0,unit),
  marginY:toMM(document.getElementById('pMarginY')?document.getElementById('pMarginY').value:0,unit),
  gap:toMM(document.getElementById('pGap')?document.getElementById('pGap').value:0,unit),
};}

function calcPalletLayerLayout(pallet, box, settings){const {pL,pW}=pallet;const {CL,CW,CH}=box;const {pattern,marginX,marginY,gap}=settings; if(!(pL&&pW&&CL&&CW)) return {positions:[],count:0,orientation:'0°'};
  function layoutGrid(aL,aW){const effL=pL-2*marginX, effW=pW-2*marginY; if(effL<=0||effW<=0) return {positions:[],count:0,orientation:'0°'}; const nx=Math.floor((effL+gap)/(aL+gap)); const ny=Math.floor((effW+gap)/(aW+gap));
    const ox=marginX + (effL - nx*aL - (nx-1)*gap)/2; const oz=marginY + (effW - ny*aW - (ny-1)*gap)/2; const pos=[];
    for(let iy=0;iy<ny;iy++){for(let ix=0;ix<nx;ix++){const x=ox+ix*(aL+gap);const z=oz+iy*(aW+gap);pos.push({x,z,L:aL,W:aW});}}
    return {positions:pos,count:nx*ny,orientation:(aL===CW&&aW===CL)?'90°':'0°'};}
  function layoutStagger(aL,aW){const effL=pL-2*marginX, effW=pW-2*marginY; if(effL<=0||effW<=0) return {positions:[],count:0,orientation:'0°'}; const baseNx=Math.floor((effL+gap)/(aL+gap)); const ny=Math.floor((effW+gap)/(aW+gap)); const pos=[]; let count=0;
    const centerX=marginX + (effL - baseNx*aL - (baseNx-1)*gap)/2; const centerZ=marginY + (effW - ny*aW - (ny-1)*gap)/2;
    for(let iy=0;iy<ny;iy++){const rowOffset=((iy%2)===1)?Math.floor((aL+gap)/2):0; let xStart=centerX + rowOffset; let placed=0; for(let x=xStart; x + aL <= marginX+effL + 1e-6; x += (aL+gap)){pos.push({x,z:centerZ + iy*(aW+gap),L:aL,W:aW}); placed++;} count+=placed;}
    return {positions:pos,count,orientation:(aL===CW&&aW===CL)?'90°':'0°'};}
  function layoutAltRotate(){const effL=pL-2*marginX, effW=pW-2*marginY; if(effL<=0||effW<=0) return {positions:[],count:0,orientation:'交错'}; const pos=[]; let count=0; // alternate by row
    function minDim(a,b){return Math.min(a,b);} const rowH=minDim(CW,CL); const estNy=Math.floor((effW+gap)/(rowH+gap)); const rowStartZ=marginY + (effW - estNy*rowH - (estNy-1)*gap)/2;
    for(let iy=0;iy<estNy;iy++){const rotate=(iy%2)===1; const aL=rotate?CW:CL; const aW=rotate?CL:CW; const nx=Math.floor((effL+gap)/(aL+gap)); const startX=marginX + (effL - nx*aL - (nx-1)*gap)/2; const z=rowStartZ + iy*(rowH+gap); for(let ix=0;ix<nx;ix++){pos.push({x:startX+ix*(aL+gap),z, L:aL, W:aW}); count++;}}
    return {positions:pos,count,orientation:'交错'};}
  const opt0=layoutGrid(CL,CW); const opt90=layoutGrid(CW,CL); const s0=layoutStagger(CL,CW); const s90=layoutStagger(CW,CL); const ar=layoutAltRotate();
  const cands=[opt0,opt90,s0,s90,ar]; let best=opt0; if(pattern==='grid'){best=(opt0.count>=opt90.count)?opt0:opt90;} else if(pattern==='stagger'){best=(s0.count>=s90.count)?s0:s90;} else if(pattern==='altRotate'){best=ar;} else {best=cands.reduce((b,c)=>c.count>b.count?c:b,best);} return best;
}

function calcAndRender(optimize=false){
  const unit=document.getElementById('unitSelect').value;
  const CL=toMM(document.getElementById('cL').value,unit);
  const CW=toMM(document.getElementById('cW').value,unit);
  const CH=toMM(document.getElementById('cH').value,unit);
  const weightEnabled=document.getElementById('weightFeatureToggle').checked;
  const maxWkg=weightToKG(parseFloat(document.getElementById('maxWeight').value)||30,(document.getElementById('maxWeightUnit')||{value:'kg'}).value);
  const volUnit=document.getElementById('volUnit').value;
  const allowMix=document.getElementById('mixToggle')?document.getElementById('mixToggle').checked:false;

  if(!(CL&&CW&&CH)){alert('请填写外箱尺寸');return}
  const rows=[...document.querySelectorAll('.product-row')];
  let totalVolM3=0,log=[],packs=[];

  function newBox(){return{items:[],weight:0,free:[{x:0,y:0,z:0,L:CL,W:CW,H:CH}],type:null};}
  function fits(it,s){return it.L<=s.L&&it.W<=s.W&&it.H<=s.H;}
  function prune(b){b.free=b.free.filter(s=>s.L>0&&s.W>0&&s.H>0);
    for(let i=0;i<b.free.length;i++){for(let j=0;j<b.free.length;j++){if(i===j)continue;const a=b.free[i],c=b.free[j];
      if(a&&c&&a.x>=c.x&&a.y>=c.y&&a.z>=c.z&&a.x+a.L<=c.x+c.L&&a.y+a.H<=c.y+c.H&&a.z+a.W<=c.z+c.W){b.free.splice(i,1);i--;break;}}}}
  function placeInBox(b,it){
    const et=effectiveType(it.type); if(b.type==null){b.type=et;}else if(b.type!==et){return false;}
  if(weightEnabled&&b.weight+it.weight>maxWkg) return false;
    let pick=null;
    if(optimize){
      for(let i=0;i<b.free.length;i++){const s=b.free[i];
        orientations(it.L,it.W,it.H).forEach(d=>{if(fits(d,s)){const waste=s.L*s.W*s.H-d.L*d.W*d.H;if(!pick||waste<pick.waste){pick={idx:i,dim:d,waste};}}});}
      if(!pick) return false;
    }else{
      for(let i=0;i<b.free.length;i++){const s=b.free[i];if(fits(it,s)){pick={idx:i,dim:{L:it.L,W:it.W,H:it.H},waste:0};break;}} if(!pick) return false;
    }
    const s=b.free.splice(pick.idx,1)[0];const d=pick.dim;const pos={x:s.x,y:s.y,z:s.z};
    b.items.push({x:pos.x,y:pos.y,z:pos.z,L:d.L,W:d.W,H:d.H,color:it.color,name:it.name}); b.weight+=(weightEnabled?it.weight:0);
    const right={x:s.x+d.L,y:s.y,z:s.z,L:s.L-d.L,W:s.W,H:s.H},front={x:s.x,y:s.y,z:s.z+d.W,L:d.L,W:s.W-d.W,H:s.H},top={x:s.x,y:s.y+d.H,z:s.z,L:d.L,W:d.W,H:s.H-d.H};
    [right,front,top].forEach(ns=>{if(ns.L>0&&ns.W>0&&ns.H>0)b.free.push(ns)});prune(b);return true;
  }
  function placeAcrossBoxes(it){
    for(const b of packs){if(placeInBox(b,it)) return true;}
  if(weightEnabled&&it.weight>maxWkg) return 'TOO_HEAVY';
    const nb=newBox();packs.push(nb);if(!placeInBox(nb,it)) return 'TOO_LARGE';return true;
  }

  const products=[];try{
    rows.forEach((r,i)=>{
      const name=r.querySelector('.pname').value||`产品${i+1}`;
      const L=toMM(r.querySelector('.pL').value,unit);
      const W=toMM(r.querySelector('.pW').value,unit);
      const H=toMM(r.querySelector('.pH').value,unit);
      let qty=parseInt(normalizeNumStr(r.querySelector('.pqty').value)||0,10);
      const weight=weightEnabled?weightToKG(r.querySelector('.pweight').value,r.querySelector('.pweightunit').value):0;
      const pColor=(r.querySelector('.pcolor')&&r.querySelector('.pcolor').value)||randomPaletteColor();
      const ptname=r.dataset.ptname||'';const ptypeInput=ptname?r.querySelector(`input[name=\"${ptname}\"]:checked`):null;const ptype=(ptypeInput&&ptypeInput.value)||'normal';
      if(!(L&&W&&H&&qty)) return;
      if(weightEnabled&&!(r.querySelector('.pweight').value)){throw new Error(`已启用重量功能：请填写【${name}】的重量`);}
      const per=optimize?bestPerBox(CL,CW,CH,L,W,H):{count:Math.floor(CL/L)*Math.floor(CW/W)*Math.floor(CH/H),dim:{L,W,H}};
      if(per.count<=0){log.push(`${name}: 尺寸超过外箱，无法装箱`);return;}
      totalVolM3+=(L*W*H*qty)/1e9;products.push({name,L,W,H,qty,weight,color:pColor,perBox:per.count,bestDim:per.dim,type:ptype});
    });
  }catch(err){alert(err.message||err);return;}
  if(!products.length){alert('请填写至少一个有效产品');return;}
  
  if(!allowMix){
    products.forEach((p)=>{
      let qty=p.qty;const start=packs.length;const dim=optimize?p.bestDim:{L:p.L,W:p.W,H:p.H};
      while(qty>0){
        let items=[],w=0;const nx=Math.floor(CL/dim.L),ny=Math.floor(CW/dim.W),nz=Math.floor(CH/dim.H);let stop=false;
        for(let ix=0;ix<nx&&!stop;ix++){for(let iy=0;iy<ny&&!stop;iy++){for(let iz=0;iz<nz&&!stop;iz++){
  if(qty<=0){stop=true;break} if(weightEnabled&&(w+p.weight>maxWkg)){stop=true;break}
          items.push({x:ix*dim.L,y:iz*dim.H,z:iy*dim.W,L:dim.L,W:dim.W,H:dim.H,name:p.name,color:p.color});qty--;w+=p.weight;}}}
  if(items.length===0){log.push(`${p.name}: 单件${p.weight.toFixed(2)}kg 超过限重 ${maxWkg}kg，已跳过`);break}
        packs.push({items,weight:w,free:[],type:effectiveType(p.type)});
      }
  const added=packs.length-start;log.push(`${p.name}: ${p.qty}件，每箱≤${p.perBox}件${weightEnabled?`/限重${maxWkg}kg`:''}，共${added}箱`);
    });
  }else{
    products.forEach((p)=>{
      let qty=p.qty;let heavySkip=false;const item={L:p.L,W:p.W,H:p.H,weight:p.weight,color:p.color,name:p.name,type:p.type};
      while(qty>0){const res=placeAcrossBoxes(item);if(res===true){qty--;}else if(res==='TOO_HEAVY'){heavySkip=true;break;}else if(res==='TOO_LARGE'){log.push(`${p.name}: 尺寸超过外箱，无法装箱`);break;}else{break;}}
  if(heavySkip){log.push(`${p.name}: 单件${p.weight.toFixed(2)}kg 超过限重 ${maxWkg}kg，已跳过`);}
  log.push(`${p.name}: ${p.qty}件，每箱≤${p.perBox}件${weightEnabled?`/限重${maxWkg}kg`:''}，累计箱数 ${packs.length}`);
    });
  }

  const volShown=volUnit==='cm3'?(totalVolM3*1e6).toFixed(0)+'cm³':totalVolM3.toFixed(3)+'m³';
  const totalPackedWeight=(packs||[]).reduce((s,b)=>s+(b.weight||0),0);
  if(weightEnabled){
  log.push(`所有箱子总重量: ${totalPackedWeight.toFixed(2)} kg（限重: ${maxWkg} kg/箱${allowMix?'，已启用混装':'，未混装'}）`);
    if(packs.length){log.push('每箱重量明细:');packs.forEach((b,i)=>log.push(` - 箱${i+1}: ${(b.weight||0).toFixed(2)} kg`));}
  }else{log.push('重量功能未启用：本次不计算重量/限重');}
  log.push(`总体积: ${volShown}`);

  scenePalletInfo=calcPalletInfo(CL,CW,CH,unit);
  if(scenePalletInfo){
    if(scenePalletInfo.perLayer>0){
      const totalBoxes=packs.length;const perPallet=scenePalletInfo.perLayer*Math.max(1,scenePalletInfo.layers);
      const need=perPallet>0?Math.ceil(totalBoxes/perPallet):0;
      const last=perPallet>0?(totalBoxes%perPallet||(totalBoxes?perPallet:0)):0;
      log.push(`托板: 每层 ${scenePalletInfo.perLayer} 箱 × ${scenePalletInfo.layers||1} 层 = ${perPallet} /托；需托数 ${need} 托（最后一托 ${last} 箱，取向:${scenePalletInfo.orientation}，策略:${(getPalletSettings(unit).pattern||'auto')}）`);
    }else{log.push('托板过小：无法放入任一外箱（请检查托板尺寸或箱体尺寸）');}
  }

  const resText=`客户: ${document.getElementById('customerName').value||'未命名'}\n`+log.join('\n');
  document.getElementById('result').textContent=resText;
  saveRecord({customer:document.getElementById('customerName').value||'未命名',time:new Date().toLocaleString(),result:resText});

  scenePacks=packs;sceneBoxSize={L:CL,W:CW,H:CH};sceneTotalProductMM3=totalVolM3*1e9;sceneBoxCount=packs.length;
  buildViewerStack();renderScene();
  updateTruckRecommend();
}
const calcBtn=document.getElementById('calc'); if(calcBtn){ calcBtn.dataset.aiManaged='true'; calcBtn.onclick=()=>{ flashCalcEffect(calcBtn); return runWithAIBusy(()=>calcAndRender(false),{msg:'装箱计算中',minMs:900,btn:calcBtn,btnText:'AI 计算中…'}); }; }
const autoBtn=document.getElementById('autoArrange'); if(autoBtn){ autoBtn.dataset.aiManaged='true'; autoBtn.onclick=()=>runWithAIBusy(()=>calcAndRender(true),{msg:'自动摆放优化中',minMs:900}); }

/************** 清空/导出/历史 **************/
function clearAll(){document.getElementById('customerName').value='';document.getElementById('unitSelect').value='mm';
  document.getElementById('cL').value='600';document.getElementById('cW').value='450';document.getElementById('cH').value='330';
  document.getElementById('pL').value='1200';document.getElementById('pW').value='1000';document.getElementById('pH').value='1500';
  document.getElementById('weightFeatureToggle').checked=false;document.getElementById('maxWeight').value='30';document.getElementById('volUnit').value='m3';
  const mix=document.getElementById('mixToggle');if(mix)mix.checked=false;document.getElementById('classPasteOnly').checked=true;document.getElementById('classHazOnly').checked=true;
  document.getElementById('result').textContent='';productList.innerHTML='';addProductRow();scenePacks=[];sceneBoxSize={L:600,W:450,H:330};scenePalletInfo=null;buildViewerStack();renderScene();}
document.getElementById('clearAll').onclick=clearAll;
function download(filename,text){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([text],{type:'text/plain;charset=utf-8'}));a.download=filename;a.click();URL.revokeObjectURL(a.href)}
function toCSV(rows){if(!rows.length) return '';const headers=Object.keys(rows[0]);const esc=v=>`"${String(v==null?'':v).replace(/"/g,'""')}"`;const lines=[headers.map(esc).join(',')];rows.forEach(r=>lines.push(headers.map(h=>esc(r[h])).join(',')));return lines.join('\n')}
// 货车尺寸（近似内仓尺寸，单位 m）与体积
const HUOLALA_TRUCKS=[
  {name:'面包车', L:2.3, W:1.35, H:1.2},
  {name:'小型货车(2.7m)', L:2.7, W:1.6, H:1.6},
  {name:'厢货(3.8m)', L:3.8, W:1.8, H:1.8},
  {name:'厢货(4.2m)', L:4.2, W:2.0, H:2.0},
  {name:'厢货(6.8m)', L:6.8, W:2.3, H:2.4},
  {name:'厢货(7.6m)', L:7.6, W:2.4, H:2.4},
  {name:'厢货(9.6m)', L:9.6, W:2.4, H:2.6},
  {name:'厢货(13m)', L:13.0, W:2.4, H:2.6},
].map(t=>({...t, vol: +(t.L*t.W*t.H).toFixed(1)}));


function computeTotalBoxVolumeM3(){
  const count=(scenePacks.length||sceneBoxCount||0);
  const mm3=sceneBoxSize.L*sceneBoxSize.W*sceneBoxSize.H*count;
  return mm3/1e9;
}
function updateTruckRecommend(){
  const sumEl=document.getElementById('truckRecoSummary');
  const listEl=document.getElementById('truckRecoList');
  if(!sumEl||!listEl) return;
  const count=(scenePacks.length||sceneBoxCount||0);
  const totalM3=computeTotalBoxVolumeM3();
  if(!count||!totalM3||totalM3<=0){
    sumEl.textContent='请先填写产品并点击“计算装箱”';
    listEl.innerHTML='';
    return;
  }
  const trucks=[...HUOLALA_TRUCKS].sort((a,b)=>a.vol-b.vol);
  const firstFit=trucks.find(t=>t.vol>=totalM3);
  const best=firstFit||trucks[trucks.length-1];
  const need=Math.ceil(totalM3/best.vol);
  sumEl.textContent=`总外箱体积约 ${totalM3.toFixed(2)} m³；推荐：${best.name} × ${need}`;
  const top=[...trucks].filter(t=>t.vol>=totalM3).slice(0,3);
  const alts=(top.length?top:[best]).filter(t=>t.name!==best.name).slice(0,3);
  const bestHtml=(()=>{
    const n=Math.ceil(totalM3/best.vol);
    return `<div class="truck-item recommended">
      <div>
        <span class="truck-tag">推荐</span>
        <span>${best.name}</span>
      </div>
      <span class="meta small">内尺寸约 ${best.L}×${best.W}×${best.H} m（${best.vol} m³）｜建议 ${n} 辆</span>
    </div>`;
  })();
  const altHtml=alts.map(t=>{
    const n=Math.ceil(totalM3/t.vol);
    return `<div class="truck-item">
      <span>${t.name}</span>
      <span class="meta small">内尺寸约 ${t.L}×${t.W}×${t.H} m（${t.vol} m³）｜建议 ${n} 辆</span>
    </div>`;
  }).join('');
  listEl.innerHTML=bestHtml+altHtml;
  const tip=document.createElement('div'); tip.className='small'; tip.style.color='var(--muted)';
  tip.textContent='说明：车型尺寸为常见近似值，仅供参考，实际以平台车型规格为准。若需更精细匹配可接入实时车型数据。';
  listEl.appendChild(tip);
}

function updateTruckRecommendManual(){
  const sumEl=document.getElementById('truckManualSummary');
  const listEl=document.getElementById('truckManualList');
  const inputEl=document.getElementById('truckManualVol');
  if(!sumEl||!listEl||!inputEl) return;
  const totalM3=parseFloat((inputEl.value||'').trim());
  if(!totalM3||totalM3<=0){
    sumEl.textContent='请填写有效的体积（m³），例如 12.5';
    listEl.innerHTML='';
    return;
  }
  const trucks=[...HUOLALA_TRUCKS].sort((a,b)=>a.vol-b.vol);
  const firstFit=trucks.find(t=>t.vol>=totalM3);
  const best=firstFit||trucks[trucks.length-1];
  const need=Math.ceil(totalM3/best.vol);
  sumEl.textContent=`手动体积约 ${totalM3.toFixed(2)} m³；推荐：${best.name} × ${need}`;
  const top=[...trucks].filter(t=>t.vol>=totalM3).slice(0,3);
  const alts=(top.length?top:[best]).filter(t=>t.name!==best.name).slice(0,3);
  const bestHtml=(()=>{
    const n=Math.ceil(totalM3/best.vol);
    return `<div class="truck-item recommended">
      <div>
        <span class="truck-tag">推荐</span>
        <span>${best.name}</span>
      </div>
      <span class="meta small">内尺寸约 ${best.L}×${best.W}×${best.H} m（${best.vol} m³）｜建议 ${n} 辆</span>
    </div>`;
  })();
  const altHtml=alts.map(t=>{
    const n=Math.ceil(totalM3/t.vol);
    return `<div class="truck-item">
      <span>${t.name}</span>
      <span class="meta small">内尺寸约 ${t.L}×${t.W}×${t.H} m（${t.vol} m³）｜建议 ${n} 辆</span>
    </div>`;
  }).join('');
  listEl.innerHTML=bestHtml+altHtml;
}

/*** 壁纸设置 ***/
function applyWallpaper(url){
  if(!url){return;}
  try{
    localStorage.setItem('wallpaper:url',url);
  }catch(e){}
  refreshWallpaperOverlay();
}
function refreshWallpaperOverlay(){
  const url=localStorage.getItem('wallpaper:url')||'';
  const has=url && url.length>3;
  if(has){
    const isDark=document.body.classList.contains('dark');
    const overlay=isDark? 'linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.45))' : 'linear-gradient(180deg, rgba(255,255,255,.45), rgba(255,255,255,.55))';
    document.body.style.backgroundImage=`${overlay}, url("${url}")`;
    document.body.style.backgroundSize='cover';
    document.body.style.backgroundPosition='center';
    document.body.style.backgroundAttachment='fixed';
  }else{
    document.body.style.backgroundImage='';
    document.body.style.backgroundAttachment='';
  }
}
function clearWallpaper(){
  try{localStorage.removeItem('wallpaper:url');}catch(e){}
  refreshWallpaperOverlay();
}
function initWallpaper(){
  refreshWallpaperOverlay();
  const btnApply=document.getElementById('wallpaperApply');
  const btnClear=document.getElementById('wallpaperClear');
  const inpUrl=document.getElementById('wallpaperUrl');
  const inpFile=document.getElementById('wallpaperFile');
  const btnFile=document.getElementById('wallpaperFileBtn');
  const nameSpan=document.getElementById('wallpaperFileName');
  if(btnApply&&inpUrl){
    btnApply.addEventListener('click',()=>{
      const u=(inpUrl.value||'').trim();
      if(u){applyWallpaper(u);} else {applyWallpaper('');}
    });
  }
  if(btnClear){btnClear.addEventListener('click',clearWallpaper);} 
  if(btnFile && inpFile){ btnFile.addEventListener('click',()=>{ inpFile.click(); }); }
  if(inpFile){
    if(nameSpan){ nameSpan.textContent = (window.__i18n&&window.__i18n.t)?window.__i18n.t('file.none'):'未选择任何文件'; }
    inpFile.addEventListener('change',()=>{
      const f=inpFile.files&&inpFile.files[0];
      if(!f){ if(nameSpan){ nameSpan.textContent = (window.__i18n&&window.__i18n.t)?window.__i18n.t('file.none'):'未选择任何文件'; } return; }
      if(nameSpan){ nameSpan.textContent = f.name; }
      const url=URL.createObjectURL(f);
      try{localStorage.setItem('wallpaper:url',url);}catch(e){}
      refreshWallpaperOverlay();
    });
  }
}
document.addEventListener('DOMContentLoaded',initWallpaper);
document.addEventListener('DOMContentLoaded',initWeatherSettingsUI);
document.getElementById('exportCSV').onclick=()=>{const rows=[...document.querySelectorAll('.product-row')].map((r,i)=>({
  产品:r.querySelector('.pname').value||`产品${i+1}`,L:r.querySelector('.pL').value,W:r.querySelector('.pW').value,H:r.querySelector('.pH').value,数量:r.querySelector('.pqty').value,
  重量:(r.querySelector('.pweight').value||'')+(r.querySelector('.pweightunit').value||'kg'),颜色:(r.querySelector('.pcolor')&&r.querySelector('.pcolor').value)||''}));
  const summary=document.getElementById('result').textContent.split('\n').map(t=>({内容:t}));download('产品清单.csv',toCSV(rows));download('计算结果.csv',toCSV(summary));};
document.getElementById('exportHistoryCSV').onclick=()=>{const list=JSON.parse(localStorage.getItem('cbmRecords')||'[]');if(!list.length){alert('暂无记录');return}download('客户装箱记录.csv',toCSV(list));};
document.getElementById('wipeHistoryAll').onclick=()=>{ clearHistoryAll(); };
function saveRecord(d){let list=JSON.parse(localStorage.getItem('cbmRecords')||'[]');list.unshift(d);if(list.length>50)list=list.slice(0,50);localStorage.setItem('cbmRecords',JSON.stringify(list));loadHistory();}
function loadHistory(){const listEl=document.getElementById('historyList');listEl.innerHTML='';const list=JSON.parse(localStorage.getItem('cbmRecords')||'[]');
  list.forEach((r,idx)=>{const el=document.createElement('div');el.className='history-item';const txt=document.createElement('div');txt.className='txt';txt.textContent=`${(r.customer||'未命名')} - ${(r.time||'')}`;
    const del=document.createElement('button');del.className='del';del.textContent='删除';del.onclick=(e)=>{e.stopPropagation();deleteHistory(idx);};
    el.onclick=()=>{ if(r && r.snapshot){ applyAppState(r.snapshot); } else if(r && r.result){ document.getElementById('result').textContent=r.result; } };
    el.appendChild(txt);el.appendChild(del);listEl.appendChild(el);
  });}
// 货车推荐事件绑定
const truckBtn=document.getElementById('truckRefresh'); if(truckBtn){ truckBtn.dataset.aiManaged='true'; truckBtn.onclick=()=>runWithAIBusy(()=>updateTruckRecommend(),{msg:'车型匹配中',minMs:600,btn:truckBtn,btnText:'AI 推荐中…'}); }
const truckManualBtn=document.getElementById('truckManualBtn');
const truckManualVol=document.getElementById('truckManualVol');
if(truckManualBtn){ truckManualBtn.dataset.aiManaged='true'; truckManualBtn.onclick=()=>runWithAIBusy(()=>updateTruckRecommendManual(),{msg:'车型匹配中',minMs:600,btn:truckManualBtn,btnText:'AI 推荐中…'}); }
if(truckManualVol){
  truckManualVol.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); updateTruckRecommendManual(); }});
}
function deleteHistory(idx){let list=JSON.parse(localStorage.getItem('cbmRecords')||'[]');if(idx<0||idx>=list.length)return;if(!confirm('确定删除这条历史记录吗？'))return;list.splice(idx,1);localStorage.setItem('cbmRecords',JSON.stringify(list));loadHistory();}
function clearHistoryAll(){if(!confirm('确认清空所有历史记录？'))return;localStorage.removeItem('cbmRecords');loadHistory();}
loadHistory();document.getElementById('clearHistoryAll').onclick=clearHistoryAll;
function saveCurrentToHistory(){const res=document.getElementById('result').textContent.trim();if(!res){alert('当前没有可保存的结果');return;}saveRecord({customer:document.getElementById('customerName').value||'未命名',time:new Date().toLocaleString(),result:res});}
function deleteLatestHistoryRecord(){let list=JSON.parse(localStorage.getItem('cbmRecords')||'[]');if(!list.length){alert('暂无历史记录');return;}if(!confirm('确定删除最新一条历史记录吗？'))return;list.shift();localStorage.setItem('cbmRecords',JSON.stringify(list));loadHistory();}

// 刷新货车推荐按钮
const truckRefresh=document.getElementById('truckRefresh'); if(truckRefresh){ truckRefresh.dataset.aiManaged='true'; truckRefresh.onclick=()=>runWithAIBusy(()=>updateTruckRecommend(),{msg:'车型匹配中',minMs:600,btn:truckRefresh,btnText:'AI 推荐中…'}); }
const saveBtn=document.getElementById('saveHistoryBtn');if(saveBtn)saveBtn.onclick=saveCurrentToHistory;const delLatestBtn=document.getElementById('deleteLatestHistory');if(delLatestBtn)delLatestBtn.onclick=deleteLatestHistoryRecord;

/*** 页面快照：捕获与恢复 ***/
function captureAppState(){
  const q=(id)=>document.getElementById(id);
  const val=(id)=>{const el=q(id); return el?el.value:''};
  const chk=(id)=>{const el=q(id); return !!(el&&el.checked)};
  const theme= document.body.classList.contains('dark') ? 'dark' : 'light';
  const products=[...document.querySelectorAll('.product-row')].map(r=>{
    const ptname=r.dataset.ptname||'';
    const typeEl=ptname ? r.querySelector(`input[name="${ptname}"]:checked`) : null;
    return {
      name: r.querySelector('.pname')?.value||'',
      L: r.querySelector('.pL')?.value||'',
      W: r.querySelector('.pW')?.value||'',
      H: r.querySelector('.pH')?.value||'',
      qty: r.querySelector('.pqty')?.value||'',
      weight: r.querySelector('.pweight')?.value||'',
      weightUnit: r.querySelector('.pweightunit')?.value||'kg',
      color: r.querySelector('.pcolor')?.value||'#34a853',
      type: typeEl? typeEl.value : 'normal'
    };
  });
  const snapshot={
    theme,
    // 客户与联系
    customerName: val('customerName'), customerContact: val('customerContact'), customerPhone: val('customerPhone'), customerEmail: val('customerEmail'), customerWechat: val('customerWechat'),
    // 外箱/单位/颜色/开关
    unitSelect: val('unitSelect'), cL: val('cL'), cW: val('cW'), cH: val('cH'),
    weightFeatureToggle: chk('weightFeatureToggle'), maxWeight: val('maxWeight'), volUnit: val('volUnit'),
    boxColor: val('boxColor'), mixToggle: chk('mixToggle'), classPasteOnly: chk('classPasteOnly'), classHazOnly: chk('classHazOnly'),
    // 托板
    pL: val('pL'), pW: val('pW'), pH: val('pH'), pPattern: val('pPattern'), pMarginX: val('pMarginX'), pMarginY: val('pMarginY'), pGap: val('pGap'), palletColor: val('palletColor'),
    // 主题与壁纸（移除自定义配色，仅保留壁纸）
    wallpaperUrl: (localStorage.getItem('wallpaper:url')||''),
    // 产品
    products
  };
  return snapshot;
}
function applyAppState(s){ if(!s) return; 
  const setVal=(id,v)=>{const el=document.getElementById(id); if(el!=null) el.value=v};
  const setChk=(id,b)=>{const el=document.getElementById(id); if(el!=null) el.checked=!!b};
  // 主题
  const isDark=(s.theme||'light')==='dark';
  document.body.classList.toggle('dark',isDark); document.body.classList.toggle('light',!isDark); refreshWallpaperOverlay();
  // 客户与联系
  setVal('customerName',s.customerName||''); setVal('customerContact',s.customerContact||''); setVal('customerPhone',s.customerPhone||''); setVal('customerEmail',s.customerEmail||''); setVal('customerWechat',s.customerWechat||'');
  // 外箱/单位
  setVal('unitSelect',s.unitSelect||'mm'); setVal('cL',s.cL||''); setVal('cW',s.cW||''); setVal('cH',s.cH||'');
  setChk('weightFeatureToggle',!!s.weightFeatureToggle); setVal('maxWeight',s.maxWeight||''); setVal('volUnit',s.volUnit||'m3');
  // 颜色与开关
  setVal('boxColor',s.boxColor||'#222'); setChk('mixToggle',!!s.mixToggle); setChk('classPasteOnly',!!s.classPasteOnly); setChk('classHazOnly',!!s.classHazOnly);
  // 托板
  setVal('pL',s.pL||''); setVal('pW',s.pW||''); setVal('pH',s.pH||''); setVal('pPattern',s.pPattern||'auto');
  setVal('pMarginX',s.pMarginX||''); setVal('pMarginY',s.pMarginY||''); setVal('pGap',s.pGap||''); setVal('palletColor',s.palletColor||'#8d6e63');
  // 主题与壁纸（移除自定义配色逻辑）
  if(s.wallpaperUrl!=null){ try{ localStorage.setItem('wallpaper:url', s.wallpaperUrl||'' ); }catch(e){} refreshWallpaperOverlay(); }
  // 产品列表
  productList.innerHTML=''; const rows=s.products||[]; if(rows.length){ rows.forEach(data=>addProductRow(data)); } else { addProductRow(); }
  // 渲染
  buildViewerStack(); renderScene(); updateTruckRecommend();
}

// 扩展：保存时附加快照
const _origSaveRecord=saveRecord; saveRecord=function(d){ if(d && !d.snapshot){ try{ d.snapshot=captureAppState(); }catch(e){} } _origSaveRecord(d); };

/************** 初始渲染 **************/
buildViewerStack();renderScene();
updateTruckRecommend();
initWeather();

/************** 自检 **************/
(function selfTests(){
  const ok=[];try{ok.push(['按钮存在(calc)',!!document.getElementById('calc')]);}catch(e){ok.push(['按钮存在(calc)',false]);}
  try{const a=orientations(1,2,3);ok.push(['朝向组合6种',a.length===6]);}catch(e){ok.push(['朝向组合6种',false]);}
  try{const bp=bestPerBox(10,10,10,5,5,5);ok.push(['最优装箱数(8)',bp.count===8]);}catch(e){ok.push(['最优装箱数(8)',false]);}
  try{buildViewerStack();renderScene();ok.push(['渲染不报错',true]);}catch(e){ok.push(['渲染不报错',false]);}
  try{const pi=calcPalletInfo(600,450,330,'mm');ok.push(['托板每层>=4',!!pi&&pi.perLayer>=4]);}catch(e){ok.push(['托板计算',false]);}
  console.log('[SMOKE TEST]',ok.map(x=>`${x[0]}=${x[1]?'OK':'FAIL'}`).join(' | '));
})();
</script>
  <style id="ai-dynamic-theme">
    :root{--ai-blur:16px;--ai-shadow-alpha:.12;--accent2:#32f08c}
    :root{--container-stroke-start:#32f08c;--container-stroke-end:rgba(255,255,255,.28)}
    body.ai header{backdrop-filter: blur(var(--ai-blur, 16px)) saturate(160%); -webkit-backdrop-filter: blur(var(--ai-blur, 16px)) saturate(160%)}
    body.ai .panel{backdrop-filter: blur(var(--ai-blur, 18px)) saturate(115%); -webkit-backdrop-filter: blur(var(--ai-blur, 18px)) saturate(115%); box-shadow: 0 12px 40px rgba(0,0,0, var(--ai-shadow-alpha, .12))}
    body.ai .group{backdrop-filter: blur(var(--ai-blur, 18px)) saturate(115%); -webkit-backdrop-filter: blur(var(--ai-blur, 18px)) saturate(115%); box-shadow: 0 8px 28px rgba(0,0,0, var(--ai-shadow-alpha, .12))}
    body.ai .viewer{backdrop-filter: blur(var(--ai-blur, 16px)) saturate(110%); -webkit-backdrop-filter: blur(var(--ai-blur, 16px)) saturate(110%); box-shadow: 0 6px 22px rgba(0,0,0, var(--ai-shadow-alpha, .12))}
    body.ai.skeu .panel, body.ai.skeu .group, body.ai.skeu .viewer{background-image: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35), inset 0 -1px 0 rgba(0,0,0,.08), 0 12px 40px rgba(0,0,0, var(--ai-shadow-alpha, .12))}
    /* —— 大型容器描边：仅应用于左右外层面板 —— */
    .panel.left, .panel.right{
      border:1px solid transparent !important;
      border-image: linear-gradient(135deg, var(--container-stroke-start), var(--container-stroke-end)) 1 !important;
    }
  </style>
  <style id="aurora-style">
    body{ position: relative; }
    @keyframes auroraShift {
      0%{ transform: translate(-4%, -2%) scale(1.03); filter: hue-rotate(0deg);
          background-position: 0% 0%, 100% 100%, 40% 80%; }
      50%{ transform: translate(4%, 2%) scale(1.05); filter: hue-rotate(18deg);
          background-position: 50% 20%, 50% 80%, 60% 30%; }
      100%{ transform: translate(-3%, 3%) scale(1.02); filter: hue-rotate(36deg);
          background-position: 100% 0%, 0% 100%, 20% 60%; }
    }
    body::after{
      content:''; position: fixed; inset:0; pointer-events:none; z-index:0;
      opacity:.26; mix-blend-mode: soft-light;
      background:
        radial-gradient(120% 90% at 20% 30%, rgba(64,232,255,.22) 0%, rgba(64,232,255,.10) 35%, rgba(64,232,255,0) 70%),
        radial-gradient(110% 95% at 80% 70%, rgba(255,94,247,.20) 0%, rgba(255,94,247,.08) 38%, rgba(255,94,247,0) 72%),
        radial-gradient(115% 85% at 40% 80%, rgba(120,255,155,.18) 0%, rgba(120,255,155,.08) 32%, rgba(120,255,155,0) 68%);
      filter: blur(68px) saturate(110%);
      animation: auroraShift 26s ease-in-out infinite alternate;
    }
    body.dark::after{ opacity:.34; filter: blur(78px) saturate(118%); }
  </style>
<style id="form-unify-final">
  /* 统一输入控件颜色规范（优先级最高，覆盖所有主题） */
  :root{
    --form-bg:#333; /* 深灰背景 */
    --form-fg:#fff; /* 文字白色 */
    --form-border:#555; /* 边框深灰 */
    --form-placeholder:rgba(255,255,255,.75); /* 占位符白色半透明 */
    --form-focus:#1e88e5; /* 聚焦主色 */
    --form-disabled-bg:#4a4a4a; /* 禁用灰背景 */
    --form-disabled-border:#666; /* 禁用边框灰 */
  }
  /* 输入控件底色/文字/边框统一 */
  input[type="text"],
  input[type="number"],
  input[type="email"],
  input[type="tel"],
  input[type="url"],
  input[type="search"],
  input[type="password"],
  input[type="file"],
  input:not([type]),
  select,
  textarea{
    background: var(--form-bg) !important;
    color: var(--form-fg) !important;
    border: 1px solid var(--form-border) !important;
  }
  /* 占位符颜色统一 */
  input::placeholder, textarea::placeholder{ color: var(--form-placeholder) !important; opacity:1; }
  /* 聚焦态统一：主色描边 + 柔和外发光 */
  input:focus, select:focus, textarea:focus{
    outline: none !important;
    border-color: var(--form-focus) !important;
    box-shadow: 0 0 0 3px rgba(var(--accent-rgb, 30,136,229), .18) !important;
  }
  /* 禁用态统一：更浅灰 + 不可点击 */
  input:disabled, select:disabled, textarea:disabled,
  input[disabled], select[disabled], textarea[disabled]{
    background: var(--form-disabled-bg) !important;
    color: var(--muted, #666) !important;
    border-color: var(--form-disabled-border) !important;
    cursor: not-allowed;
  }
  /* 自定义下拉展示统一灰底 */
  .ui-select-display{
    background: var(--form-bg) !important;
    color: var(--form-fg) !important;
    border-color: var(--form-border) !important;
  }
</style>
  <script id="ai-controls-script">
  document.addEventListener('DOMContentLoaded', () => {
    try{
      const root = document.documentElement;
      const pref = localStorage.getItem('ai:minimal');
      const enableMinimal = pref === null ? true : pref === '1';
      document.body.classList.toggle('ai', enableMinimal);
      if (!getComputedStyle(root).getPropertyValue('--accent2').trim()) {
        root.style.setProperty('--accent2','#32f08c');
      }
      root.style.setProperty('--ai-blur','16px');
      root.style.setProperty('--ai-shadow-alpha','.12');
      const themeGroupBody = document.querySelector('.group.cat-theme .group-body');
      // 移除自定义配色预设入口，不再插入 AI 主题行
      // if (themeGroupBody && !document.getElementById('aiThemeRow')) {
      //   themeGroupBody.insertAdjacentHTML('beforeend', `
      //     <div class="row" id="aiThemeRow" style="gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap;">
      //       <button id="aiMinimalToggle" class="chip">关闭极简模式</button>
      //       <span class="small">AI霓虹主题</span>
      //       <button id="aiPresetBP" class="chip">蓝紫</button>
      //       <button id="aiPresetCB" class="chip">青蓝</button>
      //       <button id="aiPresetOP" class="chip">橙粉</button>
      //       <button id="skeuToggle" class="chip">轻拟物开关</button>
      //     </div>
      //   `);
      // }
      const minimalBtn = document.getElementById('aiMinimalToggle');
      function syncMinimalBtn(){
        if (!minimalBtn) return;
        const on = document.body.classList.contains('ai');
        minimalBtn.textContent = on ? '关闭极简模式' : '打开极简模式';
      }
      minimalBtn && minimalBtn.addEventListener('click', () => {
        document.body.classList.toggle('ai');
        const on = document.body.classList.contains('ai');
        localStorage.setItem('ai:minimal', on ? '1' : '0');
        syncMinimalBtn();
      });
      syncMinimalBtn();
      function setPreset(accent, accent2, shadowAlpha){
        try{ applyAccentColor(accent); }catch(e){}
        root.style.setProperty('--accent2', accent2);
        root.style.setProperty('--ai-shadow-alpha', String(shadowAlpha));
        if (typeof flashCalcEffect === 'function') try{ flashCalcEffect(); }catch(e){}
      }
      const bp = document.getElementById('aiPresetBP');
      const cb = document.getElementById('aiPresetCB');
      const op = document.getElementById('aiPresetOP');
      bp && bp.addEventListener('click', () => setPreset('#32f08c','#32f08c', .14));
      cb && cb.addEventListener('click', () => setPreset('#00acc1','#1a73e8', .13));
      op && op.addEventListener('click', () => setPreset('#ff6d00','#e91e63', .15));
      const skeuBtn = document.getElementById('skeuToggle');
      skeuBtn && skeuBtn.addEventListener('click', () => {
        document.body.classList.toggle('skeu');
      });
      function updateDynamic(){
        const y = window.scrollY || 0;
        const t = Math.max(0, Math.min(1, y / 800));
        const blur = 14 + t * 10;
        root.style.setProperty('--ai-blur', `${Math.round(blur)}px`);
        root.style.setProperty('--ai-shadow-alpha', `${(0.10 + t * 0.08).toFixed(3)}`);
      }
      window.addEventListener('scroll', updateDynamic, {passive:true});
      let boostTimer;
  window.addEventListener('pointermove', () => {
        // 避免在3D视图内交互时触发AI模糊增强
        try{ const t=(window.event && window.event.target) || null; if(t && (t.closest && t.closest('.viewer'))) return; }catch(e){}
        const cur = parseFloat((getComputedStyle(root).getPropertyValue('--ai-blur')||'16px').replace('px',''))||16;
        root.style.setProperty('--ai-blur', `${Math.min(cur + 1, 28)}px`);
        clearTimeout(boostTimer);
        boostTimer = setTimeout(updateDynamic, 140);
      }, {passive:true});
      updateDynamic();
      // —— 重量功能启动时显示最大重量与单位 ——
      try{
        const weightToggle = document.getElementById('weightFeatureToggle');
        const weightRow = document.getElementById('weightLimitRow');
        const syncWeightUI = ()=>{ if(weightRow) weightRow.classList.toggle('hidden', !(weightToggle && weightToggle.checked)); };
        weightToggle && weightToggle.addEventListener('change', syncWeightUI);
        syncWeightUI();
      }catch(e){ console.warn('Weight UI init failed', e); }
      // —— AI 空闲“思考”文字引擎：无操作时随机变换指示文字 ——
      try{
        // 最近一次用户活动时间戳
        window.__aiLastActivityTs = Date.now();
        const resetStatusIfIdleSafe = ()=>{
          try{
            const w=document.getElementById('aiWidget');
            const busy= !!(w && w.classList.contains('busy'));
            if(!busy){
              const st=document.getElementById('aiStatus');
              if(st){
                const readyTxt = (window.__i18n && window.__i18n.t) ? window.__i18n.t('ai.ready') : '就绪';
                st.textContent = (window.__lastAIMsg||readyTxt);
              }
            }
          }catch(e){}
        };
        const activity = ()=>{
          window.__aiLastActivityTs = Date.now();
          resetStatusIfIdleSafe();
        };
        ['click','keydown','pointermove','scroll','touchstart'].forEach(ev=>{
          window.addEventListener(ev, activity, {passive:true, capture: (ev==='click')});
        });
        const getUILang = ()=> (window.__i18n && window.__i18n.getLang && window.__i18n.getLang()) || (localStorage.getItem('uiLang')||'zh-CN');
        const phrases = (window.__i18n && window.__i18n.phrases && window.__i18n.phrases(getUILang())) || ['思考中…','检索记忆…','分析场景…','优化摆放…','检查体积…','匹配车型…','评估重量…','涂抹配色…','刷新视图…','准备就绪…'];
        (function idleLoop(){
          const now = Date.now();
          const idleFor = now - (window.__aiLastActivityTs||0);
          const w=document.getElementById('aiWidget');
          const busy= !!(w && w.classList.contains('busy'));
          const st=document.getElementById('aiStatus');
          if(st && !busy && idleFor >= 5000){
            const idx = Math.floor(Math.random()*phrases.length);
            const msg = phrases[idx];
            st.textContent = msg;
            window.__lastAIMsg = msg;
            setTimeout(idleLoop, 1800 + Math.random()*1800);
          }else{
            setTimeout(idleLoop, 800);
          }
        })();
      }catch(e){}
    }catch(err){ console.warn('AI theme controls init error', err); }
});
</script>
<script id="i18n-script">
(function(){
  const translations = {
    'zh-CN':{
      'header.title':'🤖 AI 物流排布引擎 · CBM 智能装箱 & 托板 3D',
      'badge.preview':'AI 视觉预览',
      
      'ct.base':'基础设置',
      'ct.prod':'产品与智能计算',
      'ct.reco':'推荐与历史',
      'ct.theme':'外观',
      'lang.title':'界面语言',
      'lang.choose':'选择语言',
      'dash.totalBoxes':'总箱数',
      'dash.perPallet':'每托板件数',
      'dash.totalVol':'总体积',
      'dash.truckReco':'AI 推荐车型',
      'btn.collapse':'折叠',
      'btn.expand':'展开',
      'group.history':'记录历史',
      'btn.saveHistory':'保存当前为历史',
      'btn.deleteLatestHistory':'删除最新一条',
      'btn.clearHistoryAll':'清空全部历史',
      'btn.wipeHistoryAll':'一键删除所有历史',
      'btn.refreshWeather':'刷新天气',
      'btn.applyWallpaper':'应用壁纸',
      'btn.clearWallpaper':'清除壁纸',
      'hint.wallpaper':'提示：壁纸将以“覆盖+居中”方式铺设，滚动时保持固定。',
      'label.weatherFreq':'天气刷新频率（分钟）',
      'label.weatherCityManual':'备用/手动城市',
      'label.windUnit':'风速单位',
      'ph.truckManualVol':'例如 12.5',
      'ph.wallpaperUrl':'例如：https://.../image.jpg',
      'ph.weatherFreq':'例如：30',
      'ph.weatherCity':'例如：上海 或 Shenzhen',
      'group.truck':'AI 货车推荐',
      'label.manualVol':'手动体积(m³)',
      'btn.aiRecommend':'AI 智能推荐',
      'truck.hint':'AI 根据外箱总体积智能推荐车辆类型（常见车型近似数据）',
      'btn.refreshAIRecommend':'刷新 AI 推荐',
      'group.other':'其他设置',
      'group.customer':'客户信息',
      'group.box':'AI 外箱参数',
      'group.pallet':'托板参数',
      'group.product':'产品参数',
      'btn.addProduct':'添加产品',
      'btn.calc':'AI 计算装箱',
      'btn.autoArrange':'AI 自动整理摆放',
      'btn.clearAll':'清空全部',
      'btn.exportCSV':'导出产品/结果 CSV',
      'btn.exportHistoryCSV':'导出全部记录 CSV',
      'btn.smartFillRun':'识别并填入',
      'btn.smartFillSample1':'填充示例一',
      'btn.smartFillSample2':'填充示例二',
      'btn.smartFillClear':'清空输入',
      'group.history':'记录历史',
      'btn.saveHistory':'保存当前为历史',
      'btn.deleteLatestHistory':'删除最新一条',
      'btn.clearHistoryAll':'清空全部历史',
      'btn.wipeHistoryAll':'一键删除所有历史',
      'btn.applyWallpaper':'应用壁纸',
      'btn.clearWallpaper':'清除壁纸',
      'btn.refreshWeather':'刷新天气',
      'hint.wallpaper':'提示：壁纸将以“覆盖+居中”方式铺设，滚动时保持固定。',
      'label.weatherFreq':'天气刷新频率（分钟）',
      'label.weatherCityManual':'备用/手动城市',
      'label.windUnit':'风速单位',
      'label.themePrimary':'主题主色',
      'label.wallpaperUrl':'壁纸 URL（网络图片）',
      'label.localImage':'本地图片',
      'btn.chooseFile':'选择文件',
      'file.none':'未选择任何文件',
        'ai.ready':'就绪',
      'ai.dock.title':'🧠 AI Chat Dock',
      'ai.dock.close':'关闭',
      'ai.dock.fallbackHint':'该站点可能不支持站内嵌入，已在新标签页打开当前地址。',
      'ai.dock.openAgain':'再次打开',
      'viewer.free.enable':'开启自由摆放',
      'viewer.free.disable':'关闭自由摆放',
      'viewer.controls':'操作：左键旋转 | 空格/Shift 平移 | 滚轮缩放',
'viewer.resizerTip':'拖动可调整视图大小（双击恢复默认）',
      'viewer.require.boxPallet':'请填写外箱与托板尺寸',
      'viewer.require.box':'请填写外箱尺寸',
      'viewer.noTruck':'暂无推荐车型',
      'viewer.title':'AI 3D 排布视图（首行固定托板 + 每托板 + 总览 + 每箱）',
      'viewer.title.truck':'车辆装载预览',
      'viewer.palletLabel':'托板',
      'viewer.legend.pallet.size':'托板尺寸',
      'viewer.legend.box.size':'外箱尺寸',
      'viewer.legend.pattern':'铺设策略',
      'viewer.legend.perLayer':'每层',
      'viewer.legend.orientation':'取向',
      'viewer.legend.layers':'可堆层数',
      'viewer.legend.perPallet':'每托总数',
      'viewer.legend.viewBoxesWithTotal':'本视图显示',
      'viewer.legend.totalBoxes':'总箱数',
      'viewer.legend.palletIndexPrefix':'第',
      'viewer.legend.palletIndexSuffix':'托起',
      'viewer.legend.truck.model':'车型',
      'viewer.legend.truck.layout':'摆放',
      'viewer.legend.truck.style':'造型',
      'viewer.legend.truck.cabStyle':'驾驶室斜面前脸（自动匹配）',
      'viewer.unit.boxes':'箱',
      'viewer.unit.boxPerTruck':' 箱/车',
      'box.dimUnit':'尺寸与单位',
      'ph.boxL':'箱长 L',
      'ph.boxW':'箱宽 W',
      'ph.boxH':'箱高 H',
      'unit.mm':'mm',
      'unit.cm':'cm',
      'unit.m':'m',
      'box.volUnitLabel':'体积单位',
      'option.m3':'立方米 (m³)',
      'option.cm3':'立方厘米 (cm³)',
      'box.commonLabel':'常见外箱',
      'box.commonSelectPlaceholder':'选择常见外箱尺寸…',
      'boxPreset.600x450x330':'600×450×330（标准）',
      'boxPreset.530x430x300':'530×430×300（常用）',
      'boxPreset.500x400x300':'500×400×300（常用）',
      'boxPreset.400x300x250':'400×300×250（常用）',
      'boxPreset.350x250x200':'350×250×200（常用）',
      'btn.addPreset':'添加为预设',
      'box.weightMix':'重量与混装',
      'label.enableWeight':'是否启用重量功能',
      'label.allowMix':'允许不同产品混装',
      'label.maxWeight':'最大重量',
      'ph.maxWeight':'最大重量',
      'unit.kg':'kg',
      'unit.g':'g',
      'unit.jin':'斤',
      'box.visualWireframe':'可视化与线框',
      'label.showParamInViewport':'显示参数（图窗内）',
      'label.showProduct3DText':'显示产品3D文字',
      'label.wireframeColor':'外箱线框颜色',
      'box.packCategory':'分类打包',
      'box.packPasteOnly':'膏体分类打包',
      'box.packHazOnly':'带电/带磁分类打包',
      'ph.palletL':'托板长 L',
      'ph.palletW':'托板宽 W',
      'ph.palletH':'最大堆高 H（可选）',
      'pallet.unitSame':'单位与外箱一致',
      'pallet.commonLabel':'常见尺寸',
      'pallet.commonSelectPlaceholder':'选择常见托板尺寸…',
      'pPreset.1200x1000':'1200×1000（ISO/常用）',
      'pPreset.1200x800':'1200×800（欧标 EUR）',
      'pPreset.1100x1100':'1100×1100（亚洲常用）',
      'pPreset.1140x1140':'1140×1140（亚洲常用）',
      'pPreset.1219x1016':'1219×1016（美标 48×40in）',
      'pPreset.1000x1000':'1000×1000（通用）',
      'label.layoutPattern':'铺设策略',
      'pPattern.auto':'自动选择',
      'pPattern.grid':'标准网格',
      'pPattern.stagger':'错位铺设',
      'pPattern.altRotate':'交错旋转',
      'label.marginX':'边距X',
      'label.marginY':'边距Y',
      'label.gap':'间距',
      'ph.eg10':'如：10',
      'ph.eg0':'如：0',
      'label.palletColor':'托板颜色',
      'smartFill.title':'AI 识别内容自动填入（每行一个产品）',
      'chip.name':'名称',
      'chip.len':'长(L)',
      'chip.width':'宽(W)',
      'chip.height':'高(H)',
      'chip.qty':'数量',
      'chip.weight':'重量',
      'chip.unit':'单位 kg/g',
      'chip.type':'类型',
      'chip.color':'颜色',
      'label.prodName':'产品名',
      'label.prodL':'L',
      'label.prodW':'W',
      'label.prodH':'H',
      'label.prodQty':'数量',
      'label.prodWeight':'重量',
      'label.prodUnit':'单位',
      'label.prodType':'类型',
      'label.prodColor':'颜色',
      'ph.prodName':'如：A001',
      'ph.prodL':'长',
      'ph.prodW':'宽',
      'ph.prodH':'高',
      'ph.prodQty':'件数',
      'ph.prodWeight':'如：0.5',
      'prod.type.normal':'普货',
      'prod.type.paste':'膏体',
      'prod.type.haz':'带电/带磁',
      'thumb.pasteHint':'按 CTRL+V 添加图片',
      'thumb.title':'Ctrl/⌘+V 粘贴图片',
      'btn.uploadImage':'上传',
      'btn.deleteRow':'删除',
      // 新增：通用按钮与标题
      'btn.backTop':'↑ 顶部',
      'title.backTop':'回到顶部',
      'btn.collapse':'折叠',
      'btn.expand':'展开',
      // 新增：占位符翻译
      'ph.truckManualVol':'例如 12.5',
      'ph.wallpaperUrl':'例如：https://.../image.jpg',
      'ph.weatherFreq':'例如：30',
      'ph.weatherCity':'例如：上海 或 Shenzhen',
      'ph.customerName':'客户名称',
      'ph.customerContact':'联系人',
      'ph.customerPhone':'联系电话',
      'ph.customerEmail':'电子邮箱',
      'ph.customerWechat':'微信/QQ（可选）',
      'ph.smartFill':'示例：\nA001 600 450 330 10 0.5 kg normal #34a853\n或 L:600 W:450 H:330 数量:10 重量:0.5kg 类型:膏体 颜色:#1a73e8',
      'phrases':['思考中…','检索记忆…','分析场景…','优化摆放…','检查体积…','匹配车型…','评估重量…','涂抹配色…','刷新视图…','准备就绪…']
    },
    'zh-TW':{
      'header.title':'🤖 AI 物流排佈引擎 · CBM 智能裝箱 & 托板 3D',
      'badge.preview':'AI 視覺預覽',
      
      'ct.base':'基礎設置',
      'ct.prod':'產品與智能計算',
      'ct.reco':'推薦與歷史',
      'ct.theme':'外觀',
      'lang.title':'介面語言',
      'lang.choose':'選擇語言',
      'dash.totalBoxes':'總箱數',
      'dash.perPallet':'每托板件數',
      'dash.totalVol':'總體積',
      'dash.truckReco':'AI 推薦車型',
      'group.truck':'AI 貨車推薦',
      'label.manualVol':'手動體積(m³)',
      'btn.aiRecommend':'AI 智能推薦',
      'truck.hint':'AI 根據外箱總體積智能推薦車輛類型（常見車型近似數據）',
      'btn.refreshAIRecommend':'刷新 AI 推薦',
      'group.other':'其他設置',
      'group.customer':'客戶資訊',
      'group.box':'AI 外箱參數',
      'group.pallet':'托板參數',
      'group.product':'產品參數',
      'btn.addProduct':'添加產品',
      'btn.calc':'AI 計算裝箱',
      'btn.autoArrange':'AI 自動整理擺放',
      'btn.clearAll':'清空全部',
      'btn.exportCSV':'匯出產品/結果 CSV',
      'btn.exportHistoryCSV':'匯出全部記錄 CSV',
      'btn.smartFillRun':'識別並填入',
      'btn.smartFillSample1':'填充示例一',
      'btn.smartFillSample2':'填充示例二',
      'btn.smartFillClear':'清空輸入',
      'group.history':'記錄歷史',
      'btn.saveHistory':'保存當前為歷史',
      'btn.deleteLatestHistory':'刪除最新一條',
      'btn.clearHistoryAll':'清空全部歷史',
      'btn.wipeHistoryAll':'一鍵刪除所有歷史',
      'btn.applyWallpaper':'應用壁紙',
      'btn.clearWallpaper':'清除壁紙',
      'btn.refreshWeather':'刷新天氣',
      'hint.wallpaper':'提示：壁紙將以「覆蓋+居中」方式鋪設，滾動時保持固定。',
      'label.weatherFreq':'天氣刷新頻率（分鐘）',
      'label.weatherCityManual':'備用/手動城市',
      'label.windUnit':'風速單位',
      'label.themePrimary':'主題主色',
      'label.wallpaperUrl':'壁紙 URL（網路圖片）',
      'label.localImage':'本地圖片',
      'btn.chooseFile':'選擇檔案',
      'file.none':'未選擇檔案',
        'ai.ready':'就緒',
      'ai.dock.title':'🧠 AI Chat Dock',
      'ai.dock.close':'關閉',
      'ai.dock.fallbackHint':'該站點可能不支援站內嵌入，已在新標籤頁打開當前地址。',
      'ai.dock.openAgain':'再次打開',
      'viewer.free.enable':'開啟自由擺放',
      'viewer.free.disable':'關閉自由擺放',
      'viewer.controls':'操作：左鍵旋轉 | 空白/Shift 平移 | 滾輪縮放',
'viewer.resizerTip':'拖動可調整視圖大小（雙擊恢復默認）',
      'viewer.require.boxPallet':'請填寫外箱與托板尺寸',
      'viewer.require.box':'請填寫外箱尺寸',
      'viewer.noTruck':'暫無推薦車型',
      'viewer.title':'AI 3D 排佈視圖（首行固定托板 + 每托板 + 總覽 + 每箱）',
      'viewer.title.truck':'車輛裝載預覽',
      'viewer.palletLabel':'托板',
      'viewer.legend.pallet.size':'托板尺寸',
      'viewer.legend.box.size':'外箱尺寸',
      'viewer.legend.pattern':'鋪設策略',
      'viewer.legend.perLayer':'每層',
      'viewer.legend.orientation':'取向',
      'viewer.legend.layers':'可堆層數',
      'viewer.legend.perPallet':'每托總數',
      'viewer.legend.viewBoxesWithTotal':'本視圖顯示',
      'viewer.legend.totalBoxes':'總箱數',
      'viewer.legend.palletIndexPrefix':'第',
      'viewer.legend.palletIndexSuffix':'托起',
      'viewer.legend.truck.model':'車型',
      'viewer.legend.truck.layout':'擺放',
      'viewer.legend.truck.style':'造型',
      'viewer.legend.truck.cabStyle':'駕駛室斜面前臉（自動匹配）',
      'viewer.unit.boxes':'箱',
      'viewer.unit.boxPerTruck':' 箱/車',
      'box.dimUnit':'尺寸與單位',
      'ph.boxL':'箱長 L',
      'ph.boxW':'箱寬 W',
      'ph.boxH':'箱高 H',
      'unit.mm':'mm',
      'unit.cm':'cm',
      'unit.m':'m',
      'box.volUnitLabel':'體積單位',
      'option.m3':'立方米 (m³)',
      'option.cm3':'立方厘米 (cm³)',
      'box.commonLabel':'常見外箱',
      'box.commonSelectPlaceholder':'選擇常見外箱尺寸…',
      'boxPreset.600x450x330':'600×450×330（標準）',
      'boxPreset.530x430x300':'530×430×300（常用）',
      'boxPreset.500x400x300':'500×400×300（常用）',
      'boxPreset.400x300x250':'400×300×250（常用）',
      'boxPreset.350x250x200':'350×250×200（常用）',
      'btn.addPreset':'添加為預設',
      'box.weightMix':'重量與混裝',
      'label.enableWeight':'是否啟用重量功能',
      'label.allowMix':'允許不同產品混裝',
      'label.maxWeight':'最大重量',
      'ph.maxWeight':'最大重量',
      'unit.kg':'kg',
      'unit.g':'g',
      'unit.jin':'斤',
      'box.visualWireframe':'可視化與線框',
      'label.showParamInViewport':'顯示參數（視窗內）',
      'label.showProduct3DText':'顯示產品3D文字',
      'label.wireframeColor':'外箱線框顏色',
      'box.packCategory':'分類打包',
      'box.packPasteOnly':'膏體分類打包',
      'box.packHazOnly':'帶電/帶磁分類打包',
      'ph.palletL':'托板長 L',
      'ph.palletW':'托板寬 W',
      'ph.palletH':'最大堆高 H（可選）',
      'pallet.unitSame':'單位與外箱一致',
      'pallet.commonLabel':'常見尺寸',
      'pallet.commonSelectPlaceholder':'選擇常見托板尺寸…',
      'pPreset.1200x1000':'1200×1000（ISO/常用）',
      'pPreset.1200x800':'1200×800（歐標 EUR）',
      'pPreset.1100x1100':'1100×1100（亞洲常用）',
      'pPreset.1140x1140':'1140×1140（亞洲常用）',
      'pPreset.1219x1016':'1219×1016（美標 48×40in）',
      'pPreset.1000x1000':'1000×1000（通用）',
      'label.layoutPattern':'鋪設策略',
      'pPattern.auto':'自動選擇',
      'pPattern.grid':'標準網格',
      'pPattern.stagger':'錯位鋪設',
      'pPattern.altRotate':'交錯旋轉',
      'label.marginX':'邊距X',
      'label.marginY':'邊距Y',
      'label.gap':'間距',
      'ph.eg10':'如：10',
      'ph.eg0':'如：0',
      'label.palletColor':'托板顏色',
      'smartFill.title':'AI 識別內容自動填入（每行一個產品）',
      'chip.name':'名稱',
      'chip.len':'長(L)',
      'chip.width':'寬(W)',
      'chip.height':'高(H)',
      'chip.qty':'數量',
      'chip.weight':'重量',
      'chip.unit':'單位 kg/g',
      'chip.type':'類型',
      'chip.color':'顏色',
      'label.prodName':'產品名',
      'label.prodL':'L',
      'label.prodW':'W',
      'label.prodH':'H',
      'label.prodQty':'數量',
      'label.prodWeight':'重量',
      'label.prodUnit':'單位',
      'label.prodType':'類型',
      'label.prodColor':'顏色',
      'ph.prodName':'例如：A001',
      'ph.prodL':'長',
      'ph.prodW':'寬',
      'ph.prodH':'高',
      'ph.prodQty':'件數',
      'ph.prodWeight':'例如：0.5',
      'prod.type.normal':'普貨',
      'prod.type.paste':'膏體',
      'prod.type.haz':'帶電/帶磁',
      'thumb.pasteHint':'按 CTRL+V 貼上圖片',
      'thumb.title':'Ctrl/⌘+V 貼上圖片',
      'btn.uploadImage':'上傳',
      'btn.deleteRow':'刪除',
      // 新增：通用按鈕與標題
      'btn.backTop':'↑ 頂部',
      'title.backTop':'回到頂部',
      'btn.collapse':'折疊',
      'btn.expand':'展開',
      // 新增：占位符翻譯
      'ph.truckManualVol':'例如 12.5',
      'ph.wallpaperUrl':'例如：https://.../image.jpg',
      'ph.weatherFreq':'例如：30',
      'ph.weatherCity':'例如：上海 或 Shenzhen',
      'ph.customerName':'客戶名稱',
      'ph.customerContact':'聯絡人',
      'ph.customerPhone':'聯絡電話',
      'ph.customerEmail':'電子郵件',
      'ph.customerWechat':'微信/QQ（可選）',
      'ph.smartFill':'示例：\nA001 600 450 330 10 0.5 kg normal #34a853\n或 L:600 W:450 H:330 數量:10 重量:0.5kg 類型:膏體 顏色:#1a73e8',
      'phrases':['思考中…','檢索記憶…','分析場景…','優化擺放…','檢查體積…','匹配車型…','評估重量…','塗抹配色…','刷新視圖…','準備就緒…']
    },
    'en':{
      'header.title':'🤖 AI Logistics Layout Engine · CBM Smart Boxing & Pallet 3D',
      'badge.preview':'AI Visual Preview',
      
      'ct.base':'Basics',
      'ct.prod':'Products & AI Compute',
      'ct.reco':'Recommendations & History',
      'ct.theme':'Appearance',
      'lang.title':'Interface Language',
      'lang.choose':'Choose language',
      'dash.totalBoxes':'Total boxes',
      'dash.perPallet':'Items per pallet',
      'dash.totalVol':'Total volume',
      'dash.truckReco':'AI Recommended truck',
      'group.truck':'AI Truck Recommendation',
      'label.manualVol':'Manual Volume (m³)',
      'btn.aiRecommend':'AI Recommend',
      'truck.hint':'AI recommends truck type based on total box volume (common models approximated)',
      'btn.refreshAIRecommend':'Refresh AI Recommendation',
      'group.other':'Other Settings',
      'group.customer':'Customer Info',
      'group.box':'AI Box Parameters',
      'group.pallet':'Pallet Parameters',
      'group.product':'Product Parameters',
      'btn.addProduct':'Add Product',
      'btn.calc':'AI Pack Calculation',
      'btn.autoArrange':'AI Auto Arrange',
      'btn.clearAll':'Clear All',
      'btn.exportCSV':'Export Products/Results CSV',
      'btn.exportHistoryCSV':'Export All Records CSV',
      'btn.smartFillRun':'Recognize & Fill',
      'btn.smartFillSample1':'Fill Sample 1',
      'btn.smartFillSample2':'Fill Sample 2',
      'btn.smartFillClear':'Clear Input',
      'group.history':'Record History',
      'btn.saveHistory':'Save current as history',
      'btn.deleteLatestHistory':'Delete latest',
      'btn.clearHistoryAll':'Clear all history',
      'btn.wipeHistoryAll':'Delete all history',
      'btn.applyWallpaper':'Apply Wallpaper',
      'btn.clearWallpaper':'Clear Wallpaper',
      'btn.refreshWeather':'Refresh Weather',
      'hint.wallpaper':'Tip: Wallpaper uses cover+center and stays fixed on scroll.',
      'label.weatherFreq':'Weather refresh frequency (minutes)',
      'label.weatherCityManual':'Backup/Manual City',
      'label.windUnit':'Wind speed unit',
      'label.themePrimary':'Theme Primary Color',
      'label.wallpaperUrl':'Wallpaper URL (online image)',
      'label.localImage':'Local Image',
      'btn.chooseFile':'Choose File',
      'file.none':'No file chosen',
        'btn.backTop':'↑ Top',
      'title.backTop':'Back to top',
      'btn.collapse':'Collapse',
      'btn.expand':'Expand',
      'ai.ready':'Ready',
      'ai.dock.title':'🧠 AI Chat Dock',
      'ai.dock.close':'Close',
      'ai.dock.fallbackHint':'This site may not support embedding; opened in a new tab.',
      'ai.dock.openAgain':'Open again',
      'viewer.free.enable':'Enable Free Layout',
      'viewer.free.disable':'Disable Free Layout',
      'viewer.controls':'Controls: Left-drag rotate | Space/Shift pan | Wheel zoom',
'viewer.resizerTip':'Drag to resize view (double-click to reset)',
      'viewer.require.boxPallet':'Please fill box and pallet sizes',
      'viewer.require.box':'Please fill box sizes',
      'viewer.noTruck':'No recommended truck',
      'viewer.title':'AI 3D Layout View (First pallet fixed + Per pallet + Overview + Per box)',
      'viewer.title.truck':'Truck Loading Preview',
      'viewer.palletLabel':'Pallet',
      'viewer.legend.pallet.size':'Pallet size',
      'viewer.legend.box.size':'Box size',
      'viewer.legend.pattern':'Layout Pattern',
      'viewer.legend.perLayer':'Per layer',
      'viewer.legend.orientation':'Orientation',
      'viewer.legend.layers':'Stackable layers',
      'viewer.legend.perPallet':'Per pallet total',
      'viewer.legend.viewBoxesWithTotal':'Shown in this view',
      'viewer.legend.totalBoxes':'Total boxes',
      'viewer.legend.palletIndexPrefix':'No.',
      'viewer.legend.palletIndexSuffix':'pallet',
      'viewer.legend.truck.model':'Truck',
      'viewer.legend.truck.layout':'Layout',
      'viewer.legend.truck.style':'Styling',
      'viewer.legend.truck.cabStyle':'Cab front chamfer (auto-matched)',
      'viewer.unit.boxes':'boxes',
      'viewer.unit.boxPerTruck':' boxes/truck',
      'box.dimUnit':'Dimensions & Units',
      'ph.boxL':'Box Length L',
      'ph.boxW':'Box Width W',
      'ph.boxH':'Box Height H',
      'ph.truckManualVol':'e.g. 12.5',
      'ph.wallpaperUrl':'e.g.: https://.../image.jpg',
      'ph.weatherFreq':'e.g.: 30',
      'ph.weatherCity':'e.g.: Shanghai or Shenzhen',
      'ph.customerName':'Customer Name',
      'ph.customerContact':'Contact',
      'ph.customerPhone':'Phone',
      'ph.customerEmail':'Email',
      'ph.customerWechat':'WeChat/QQ (optional)',
      'unit.mm':'mm',
      'unit.cm':'cm',
      'unit.m':'m',
      'box.volUnitLabel':'Volume Unit',
      'option.m3':'Cubic meter (m³)',
      'option.cm3':'Cubic centimeter (cm³)',
      'box.commonLabel':'Common Box',
      'box.commonSelectPlaceholder':'Select common box size…',
      'boxPreset.600x450x330':'600×450×330 (Standard)',
      'boxPreset.530x430x300':'530×430×300 (Common)',
      'boxPreset.500x400x300':'500×400×300 (Common)',
      'boxPreset.400x300x250':'400×300×250 (Common)',
      'boxPreset.350x250x200':'350×250×200 (Common)',
      'btn.addPreset':'Add as Preset',
      'box.weightMix':'Weight & Mixed Packing',
      'label.enableWeight':'Enable Weight Feature',
      'label.allowMix':'Allow mixing different products',
      'label.maxWeight':'Max Weight',
      'ph.maxWeight':'Max Weight',
      'unit.kg':'kg',
      'unit.g':'g',
      'unit.jin':'jin',
      'box.visualWireframe':'Visualization & Wireframe',
      'label.showParamInViewport':'Show parameters (in viewport)',
      'label.showProduct3DText':'Show product 3D text',
      'label.wireframeColor':'Box wireframe color',
      'box.packCategory':'Categorized Packing',
      'box.packPasteOnly':'Paste category only',
      'box.packHazOnly':'Hazard/Electromagnetic category only',
      'ph.palletL':'Pallet Length L',
      'ph.palletW':'Pallet Width W',
      'ph.palletH':'Max Stack Height H (optional)',
      'pallet.unitSame':'Units same as box',
      'pallet.commonLabel':'Common Size',
      'pallet.commonSelectPlaceholder':'Select common pallet size…',
      'pPreset.1200x1000':'1200×1000 (ISO/Common)',
      'pPreset.1200x800':'1200×800 (EUR)',
      'pPreset.1100x1100':'1100×1100 (Asia common)',
      'pPreset.1140x1140':'1140×1140 (Asia common)',
      'pPreset.1219x1016':'1219×1016 (US 48×40in)',
      'pPreset.1000x1000':'1000×1000 (General)',
      'label.layoutPattern':'Layout Pattern',
      'pPattern.auto':'Auto Select',
      'pPattern.grid':'Standard Grid',
      'pPattern.stagger':'Staggered Layout',
      'pPattern.altRotate':'Alternating Rotation',
      'label.marginX':'Margin X',
      'label.marginY':'Margin Y',
      'label.gap':'Gap',
      'ph.eg10':'e.g. 10',
      'ph.eg0':'e.g. 0',
      'label.palletColor':'Pallet Color',
      'smartFill.title':'AI recognize and auto fill (one product per line)',
      'chip.name':'Name',
      'chip.len':'Length (L)',
      'chip.width':'Width (W)',
      'chip.height':'Height (H)',
      'chip.qty':'Quantity',
      'chip.weight':'Weight',
      'chip.unit':'Unit kg/g',
      'chip.type':'Type',
      'chip.color':'Color',
      'label.prodName':'Nombre del producto',
      'label.prodL':'L',
      'label.prodW':'W',
      'label.prodH':'H',
      'label.prodQty':'Cantidad',
      'label.prodWeight':'Peso',
      'label.prodUnit':'Unidad',
      'label.prodType':'Tipo',
      'label.prodColor':'Color',
      'ph.prodName':'p.ej. A001',
      'ph.prodL':'Longitud',
      'ph.prodW':'Anchura',
      'ph.prodH':'Altura',
      'ph.prodQty':'Cant.',
      'ph.prodWeight':'p.ej. 0.5',
      'prod.type.normal':'Normal',
      'prod.type.paste':'Pasta',
      'prod.type.haz':'Peligroso/Electromagnético',
      'thumb.pasteHint':'Pulsa CTRL+V para añadir imagen',
      'thumb.title':'Ctrl/⌘+V Pegar imagen',
      'btn.uploadImage':'Subir',
      'btn.deleteRow':'Eliminar',
      'label.prodName':'Product Name',
      'label.prodL':'L',
      'label.prodW':'W',
      'label.prodH':'H',
      'label.prodQty':'Quantity',
      'label.prodWeight':'Weight',
      'label.prodUnit':'Unit',
      'label.prodType':'Type',
      'label.prodColor':'Color',
      'ph.prodName':'e.g. A001',
      'ph.prodL':'Length',
      'ph.prodW':'Width',
      'ph.prodH':'Height',
      'ph.prodQty':'Qty',
      'ph.prodWeight':'e.g. 0.5',
      'prod.type.normal':'Normal',
      'prod.type.paste':'Paste',
      'prod.type.haz':'Hazard/Electromagnetic',
      'thumb.pasteHint':'Press CTRL+V to add image',
      'thumb.title':'Ctrl/⌘+V Paste image',
      'btn.uploadImage':'Upload',
      'btn.deleteRow':'Delete',
      'ph.smartFill':'Example:\nA001 600 450 330 10 0.5 kg normal #34a853\nor L:600 W:450 H:330 Qty:10 Weight:0.5kg Type:paste Color:#1a73e8',
      'phrases':['Thinking…','Retrieving memory…','Analyzing scene…','Optimizing layout…','Checking volume…','Matching truck…','Evaluating weight…','Painting colors…','Refreshing view…','Ready…']
    },
    'ar':{
      'header.title':'🤖 محرك ترتيب اللوجستيات · CBM تغليف ذكي ومنصة ثلاثية الأبعاد',
      'badge.preview':'معاينة بصرية للذكاء الاصطناعي',
      
      'ct.base':'الإعدادات الأساسية',
      'ct.prod':'المنتجات والحساب الذكي',
      'ct.reco':'التوصيات والسجل',
      'ct.theme':'المظهر',
      'lang.title':'لغة الواجهة',
      'lang.choose':'اختر اللغة',
      'dash.totalBoxes':'إجمالي الصناديق',
      'dash.perPallet':'عدد العناصر لكل منصة',
      'dash.totalVol':'الحجم الإجمالي',
      'dash.truckReco':'الشاحنة الموصى بها بواسطة الذكاء الاصطناعي',
      'group.truck':'توصية الشاحنات بالذكاء الاصطناعي',
      'label.manualVol':'الحجم اليدوي (م³)',
      'btn.aiRecommend':'توصية الذكاء الاصطناعي',
      'truck.hint':'يقترح الذكاء الاصطناعي نوع الشاحنة حسب الحجم الإجمالي للصناديق (نماذج شائعة تقريبية)',
      'btn.refreshAIRecommend':'تحديث توصية الذكاء الاصطناعي',
      'group.other':'إعدادات أخرى',
      'group.customer':'معلومات العميل',
      'group.box':'معلمات الصندوق',
      'group.pallet':'معلمات المنصة',
      'group.product':'معلمات المنتج',
      'btn.addProduct':'إضافة منتج',
      'btn.calc':'حساب التغليف الذكي',
      'btn.autoArrange':'ترتيب تلقائي',
      'btn.clearAll':'مسح الكل',
      'btn.exportCSV':'تصدير المنتجات/النتائج CSV',
      'btn.exportHistoryCSV':'تصدير كل السجلات CSV',
      'btn.smartFillRun':'تعرف واملأ',
      'btn.smartFillSample1':'ملء مثال 1',
      'btn.smartFillSample2':'ملء مثال 2',
      'btn.smartFillClear':'مسح الإدخال',
      'group.history':'سجل التاريخ',
      'btn.saveHistory':'احفظ الحالي كسجل',
      'btn.deleteLatestHistory':'حذف الأحدث',
      'btn.clearHistoryAll':'مسح كل السجل',
      'btn.wipeHistoryAll':'حذف كل السجل',
      'btn.applyWallpaper':'تطبيق الخلفية',
      'btn.clearWallpaper':'مسح الخلفية',
      'btn.refreshWeather':'تحديث الطقس',
      'hint.wallpaper':'ملاحظة: الخلفية تغطي وتتمركز وتبقى ثابتة عند التمرير.',
      'label.weatherFreq':'تكرار تحديث الطقس (بالدقائق)',
      'label.weatherCityManual':'مدينة احتياطية/يدوية',
      'label.windUnit':'وحدة سرعة الرياح',
      'label.themePrimary':'لون المظهر الأساسي',
      'label.wallpaperUrl':'رابط الخلفية (صورة على الإنترنت)',
      'label.localImage':'صورة محلية',
      'btn.chooseFile':'اختر ملف',
      'file.none':'لم يتم اختيار ملف',
        'ai.ready':'جاهز',
      'ai.dock.title':'🧠 رصيف دردشة الذكاء الاصطناعي',
      'ai.dock.close':'إغلاق',
      'ai.dock.fallbackHint':'قد لا يدعم هذا الموقع التضمين؛ تم فتح الرابط في علامة تبويب جديدة.',
      'ai.dock.openAgain':'افتح مرة أخرى',
      'viewer.free.enable':'تفعيل الترتيب الحر',
      'viewer.free.disable':'تعطيل الترتيب الحر',
      'viewer.controls':'التحكم: سحب بزر الفأرة الأيسر للدوران | Space/Shift للتحريك | عجلة للتكبير/التصغير',
'viewer.resizerTip':'اسحب لتغيير حجم العرض (انقر نقرًا مزدوجًا لإعادة الضبط)',
      'viewer.require.boxPallet':'يرجى إدخال أبعاد الصندوق والمنصة',
      'viewer.require.box':'يرجى إدخال أبعاد الصندوق',
      'viewer.noTruck':'لا توجد شاحنة موصى بها',
      'viewer.title':'عرض تخطيط ثلاثي الأبعاد AI (أول منصة ثابتة + لكل منصة + نظرة عامة + لكل صندوق)',
      'viewer.title.truck':'معاينة تحميل الشاحنة',
      'viewer.palletLabel':'المنصة',
      'viewer.legend.pallet.size':'أبعاد المنصة',
      'viewer.legend.box.size':'أبعاد الصندوق',
      'viewer.legend.pattern':'نمط الترتيب',
      'viewer.legend.perLayer':'لكل طبقة',
      'viewer.legend.orientation':'الاتجاه',
      'viewer.legend.layers':'عدد الطبقات القابلة للتكديس',
      'viewer.legend.perPallet':'إجمالي لكل منصة',
      'viewer.legend.viewBoxesWithTotal':'المعروض في هذه الرؤية',
      'viewer.legend.totalBoxes':'إجمالي الصناديق',
      'viewer.legend.palletIndexPrefix':'رقم',
      'viewer.legend.palletIndexSuffix':'منصة',
      'viewer.legend.truck.model':'الشاحنة',
      'viewer.legend.truck.layout':'الترتيب',
      'viewer.legend.truck.style':'الشكل',
      'viewer.legend.truck.cabStyle':'واجهة مقصورة مشطوفة (مطابقة آليًا)',
      'viewer.unit.boxes':'صناديق',
      'viewer.unit.boxPerTruck':' صناديق/شاحنة',
      'box.dimUnit':'الأبعاد والوحدات',
      'ph.boxL':'طول الصندوق L',
      'ph.boxW':'عرض الصندوق W',
      'ph.boxH':'ارتفاع الصندوق H',
      'unit.mm':'مم',
      'unit.cm':'سم',
      'unit.m':'م',
      'box.volUnitLabel':'وحدة الحجم',
      'option.m3':'متر مكعب (m³)',
      'option.cm3':'سنتيمتر مكعب (cm³)',
      'box.commonLabel':'صندوق شائع',
      'box.commonSelectPlaceholder':'اختر حجم صندوق شائع…',
      'boxPreset.600x450x330':'600×450×330 (قياسي)',
      'boxPreset.530x430x300':'530×430×300 (شائع)',
      'boxPreset.500x400x300':'500×400×300 (شائع)',
      'boxPreset.400x300x250':'400×300×250 (شائع)',
      'boxPreset.350x250x200':'350×250×200 (شائع)',
      'btn.addPreset':'إضافة كمسبق',
      'box.weightMix':'الوزن والتعبئة المختلطة',
      'label.enableWeight':'تمكين ميزة الوزن',
      'label.allowMix':'السماح بخلط المنتجات المختلفة',
      'label.maxWeight':'الوزن الأقصى',
      'ph.maxWeight':'الوزن الأقصى',
      'unit.kg':'كجم',
      'unit.g':'جم',
      'unit.jin':'جين',
      'box.visualWireframe':'التصور والإطار السلكي',
      'label.showParamInViewport':'عرض المعلمات (داخل العرض)',
      'label.showProduct3DText':'عرض نص المنتج ثلاثي الأبعاد',
      'label.wireframeColor':'لون إطار الصندوق',
      'box.packCategory':'تعبئة مصنفة',
      'box.packPasteOnly':'فئة المعجون فقط',
      'box.packHazOnly':'فئة الخطر/المغناطيسية فقط',
      'ph.palletL':'طول المنصة L',
      'ph.palletW':'عرض المنصة W',
      'ph.palletH':'ارتفاع التكديس الأقصى H (اختياري)',
      'pallet.unitSame':'الوحدات مثل الصندوق',
      'pallet.commonLabel':'حجم شائع',
      'pallet.commonSelectPlaceholder':'اختر حجم منصة شائع…',
      'pPreset.1200x1000':'1200×1000 (ISO/شائع)',
      'pPreset.1200x800':'1200×800 (أوروبي EUR)',
      'pPreset.1100x1100':'1100×1100 (آسيوي شائع)',
      'pPreset.1140x1140':'1140×1140 (آسيوي شائع)',
      'pPreset.1219x1016':'1219×1016 (أمريكي 48×40in)',
      'pPreset.1000x1000':'1000×1000 (عام)',
      'label.layoutPattern':'نمط الترتيب',
      'pPattern.auto':'اختيار تلقائي',
      'pPattern.grid':'شبكة قياسية',
      'pPattern.stagger':'ترتيب متعاقب',
      'pPattern.altRotate':'تدوير متناوب',
      'label.marginX':'هامش X',
      'label.marginY':'هامش Y',
      'label.gap':'فجوة',
      'ph.eg10':'مثال: 10',
      'ph.eg0':'مثال: 0',
      'label.palletColor':'لون المنصة',
      'smartFill.title':'تعرف AI واملأ تلقائيًا (سطر لكل منتج)',
      'chip.name':'الاسم',
      'chip.len':'الطول (L)',
      'chip.width':'العرض (W)',
      'chip.height':'الارتفاع (H)',
      'chip.qty':'الكمية',
      'chip.weight':'الوزن',
      'chip.unit':'الوحدة كجم/جم',
      'chip.type':'النوع',
      'chip.color':'اللون',
      'label.prodName':'اسم المنتج',
      'label.prodL':'L',
      'label.prodW':'W',
      'label.prodH':'H',
      'label.prodQty':'الكمية',
      'label.prodWeight':'الوزن',
      'label.prodUnit':'الوحدة',
      'label.prodType':'النوع',
      'label.prodColor':'اللون',
      'ph.prodName':'مثال: A001',
      'ph.prodL':'الطول',
      'ph.prodW':'العرض',
      'ph.prodH':'الارتفاع',
      'ph.prodQty':'عدد القطع',
      'ph.prodWeight':'مثال: 0.5',
      'prod.type.normal':'عادي',
      'prod.type.paste':'معجون',
      'prod.type.haz':'خطر/كهربائي-مغناطيسي',
      'thumb.pasteHint':'اضغط CTRL+V لإضافة صورة',
      'thumb.title':'Ctrl/⌘+V لصق الصورة',
      'btn.uploadImage':'رفع',
      'btn.deleteRow':'حذف',
      'ph.smartFill':'مثال:\nA001 600 450 330 10 0.5 kg normal #34a853\nأو L:600 W:450 H:330 الكمية:10 الوزن:0.5kg النوع:معجون اللون:#1a73e8',
      'phrases':['جارٍ التفكير…','يسترجع الذاكرة…','يحلل المشهد…','يحسّن الترتيب…','يفحص الحجم…','يطابق الشاحنة…','يقيّم الوزن…','يختار الألوان…','يحدّث العرض…','جاهز…']
    },
    'es':{
      'header.title':'🤖 Motor de Logística AI · CBM Empaque Inteligente y Palet 3D',
      'badge.preview':'Vista Visual AI',
      
      'ct.base':'Configuración básica',
      'ct.prod':'Productos y Cálculo Inteligente',
      'ct.reco':'Recomendaciones e Historial',
      'ct.theme':'Apariencia',
      'lang.title':'Idioma de la interfaz',
      'lang.choose':'Elegir idioma',
      'dash.totalBoxes':'Cajas totales',
      'dash.perPallet':'Artículos por palé',
      'dash.totalVol':'Volumen total',
      'dash.truckReco':'Camión recomendado por IA',
      'group.truck':'Recomendación de camión AI',
      'label.manualVol':'Volumen manual (m³)',
      'btn.aiRecommend':'Recomendación AI',
      'truck.hint':'AI recomienda tipo de camión según volumen total de cajas (modelos comunes aproximados)',
      'btn.refreshAIRecommend':'Actualizar recomendación AI',
      'group.other':'Otros ajustes',
      'group.customer':'Información del cliente',
      'group.box':'Parámetros de caja',
      'group.pallet':'Parámetros del palet',
      'group.product':'Parámetros de producto',
      'btn.addProduct':'Agregar producto',
      'btn.calc':'Cálculo de empaque AI',
      'btn.autoArrange':'Organización automática AI',
      'btn.clearAll':'Limpiar todo',
      'btn.exportCSV':'Exportar productos/resultados CSV',
      'btn.exportHistoryCSV':'Exportar todos los registros CSV',
      'btn.smartFillRun':'Reconocer y rellenar',
      'btn.smartFillSample1':'Rellenar ejemplo 1',
      'btn.smartFillSample2':'Rellenar ejemplo 2',
      'btn.smartFillClear':'Limpiar entrada',
      'group.history':'Registrar historial',
      'btn.saveHistory':'Guardar actual como historial',
      'btn.deleteLatestHistory':'Eliminar la última',
      'btn.clearHistoryAll':'Vaciar todo el historial',
      'btn.wipeHistoryAll':'Eliminar todo el historial',
      'btn.applyWallpaper':'Aplicar fondo',
      'btn.clearWallpaper':'Borrar fondo',
      'btn.refreshWeather':'Actualizar tiempo',
      'hint.wallpaper':'Consejo: El fondo usa cubrir+centrar y permanece fijo al desplazarse.',
      'label.weatherFreq':'Frecuencia de actualización del tiempo (minutos)',
      'label.weatherCityManual':'Ciudad de respaldo/manual',
      'label.windUnit':'Unidad de velocidad del viento',
      'label.themePrimary':'Color primario del tema',
      'label.wallpaperUrl':'URL de fondo (imagen en línea)',
      'label.localImage':'Imagen local',
      'btn.chooseFile':'Elegir archivo',
      'file.none':'No se ha seleccionado ningún archivo',
        'ai.ready':'Listo',
      'ai.dock.title':'🧠 Muelle de chat AI',
      'ai.dock.close':'Cerrar',
      'ai.dock.fallbackHint':'Este sitio puede no admitir la inserción; se abrió en una nueva pestaña.',
      'ai.dock.openAgain':'Abrir de nuevo',
      'viewer.free.enable':'Activar colocación libre',
      'viewer.free.disable':'Desactivar colocación libre',
      'viewer.controls':'Controles: Arrastrar con botón izq. rota | Space/Shift desplaza | Rueda zum',
'viewer.resizerTip':'Arrastra para cambiar el tamaño de la vista (doble clic para restablecer)',
      'viewer.require.boxPallet':'Completa medidas de caja y palet',
      'viewer.require.box':'Completa medidas de caja',
      'viewer.noTruck':'Sin camión recomendado',
      'viewer.title':'Vista de distribución 3D AI (primera tarima fija + por tarima + vista general + por caja)',
      'viewer.title.truck':'Vista de carga de camión',
      'viewer.palletLabel':'Palet',
      'viewer.legend.pallet.size':'Tamaño del palet',
      'viewer.legend.box.size':'Tamaño de caja',
      'viewer.legend.pattern':'Estrategia de colocación',
      'viewer.legend.perLayer':'Por capa',
      'viewer.legend.orientation':'Orientación',
      'viewer.legend.layers':'Capas apilables',
      'viewer.legend.perPallet':'Total por palet',
      'viewer.legend.viewBoxesWithTotal':'Mostrados en esta vista',
      'viewer.legend.totalBoxes':'Cajas totales',
      'viewer.legend.palletIndexPrefix':'N.º',
      'viewer.legend.palletIndexSuffix':'palet',
      'viewer.legend.truck.model':'Camión',
      'viewer.legend.truck.layout':'Disposición',
      'viewer.legend.truck.style':'Estética',
      'viewer.legend.truck.cabStyle':'Chaflán frontal de cabina (auto)',
      'viewer.unit.boxes':'cajas',
      'viewer.unit.boxPerTruck':' cajas/camión',
      'box.dimUnit':'Dimensiones y unidades',
      'ph.boxL':'Longitud de caja L',
      'ph.boxW':'Ancho de caja W',
      'ph.boxH':'Altura de caja H',
      'unit.mm':'mm',
      'unit.cm':'cm',
      'unit.m':'m',
      'box.volUnitLabel':'Unidad de volumen',
      'option.m3':'Metro cúbico (m³)',
      'option.cm3':'Centímetro cúbico (cm³)',
      'box.commonLabel':'Caja común',
      'box.commonSelectPlaceholder':'Elegir tamaño de caja común…',
      'boxPreset.600x450x330':'600×450×330 (Estándar)',
      'boxPreset.530x430x300':'530×430×300 (Común)',
      'boxPreset.500x400x300':'500×400×300 (Común)',
      'boxPreset.400x300x250':'400×300×250 (Común)',
      'boxPreset.350x250x200':'350×250×200 (Común)',
      'btn.addPreset':'Agregar como preajuste',
      'box.weightMix':'Peso y empaque mixto',
      'label.enableWeight':'Habilitar función de peso',
      'label.allowMix':'Permitir mezclar productos diferentes',
      'label.maxWeight':'Peso máximo',
      'ph.maxWeight':'Peso máximo',
      'unit.kg':'kg',
      'unit.g':'g',
      'unit.jin':'jin',
      'box.visualWireframe':'Visualización y alambre',
      'label.showParamInViewport':'Mostrar parámetros (en visor)',
      'label.showProduct3DText':'Mostrar texto 3D del producto',
      'label.wireframeColor':'Color del alambre de la caja',
      'box.packCategory':'Empaque categorizado',
      'box.packPasteOnly':'Solo categoría de pasta',
      'box.packHazOnly':'Solo categoría peligrosa/electromagnética',
      'ph.palletL':'Longitud del palet L',
      'ph.palletW':'Ancho del palet W',
      'ph.palletH':'Altura máxima de apilado H (opcional)',
      'pallet.unitSame':'Unidades iguales a caja',
      'pallet.commonLabel':'Tamaño común',
      'pallet.commonSelectPlaceholder':'Elegir tamaño de palet común…',
      'pPreset.1200x1000':'1200×1000 (ISO/Común)',
      'pPreset.1200x800':'1200×800 (EUR)',
      'pPreset.1100x1100':'1100×1100 (Asia común)',
      'pPreset.1140x1140':'1140×1140 (Asia común)',
      'pPreset.1219x1016':'1219×1016 (EE. UU. 48×40in)',
      'pPreset.1000x1000':'1000×1000 (General)',
      'label.layoutPattern':'Estrategia de colocación',
      'pPattern.auto':'Selección automática',
      'pPattern.grid':'Cuadrícula estándar',
      'pPattern.stagger':'Colocación escalonada',
      'pPattern.altRotate':'Rotación alternada',
      'label.marginX':'Margen X',
      'label.marginY':'Margen Y',
      'label.gap':'Espacio',
      'ph.eg10':'ej.: 10',
      'ph.eg0':'ej.: 0',
      'label.palletColor':'Color del palet',
      'smartFill.title':'AI reconoce y rellena automáticamente (un producto por línea)',
      'chip.name':'Nombre',
      'chip.len':'Longitud (L)',
      'chip.width':'Ancho (W)',
      'chip.height':'Altura (H)',
      'chip.qty':'Cantidad',
      'chip.weight':'Peso',
      'chip.unit':'Unidad kg/g',
      'chip.type':'Tipo',
      'chip.color':'Color',
      'label.prodName':'Nombre del producto',
      'label.prodL':'L',
      'label.prodW':'W',
      'label.prodH':'H',
      'label.prodQty':'Cantidad',
      'label.prodWeight':'Peso',
      'label.prodUnit':'Unidad',
      'label.prodType':'Tipo',
      'label.prodColor':'Color',
      'ph.prodName':'p.ej. A001',
      'ph.prodL':'Longitud',
      'ph.prodW':'Anchura',
      'ph.prodH':'Altura',
      'ph.prodQty':'Cant.',
      'ph.prodWeight':'p.ej. 0.5',
      'prod.type.normal':'Normal',
      'prod.type.paste':'Pasta',
      'prod.type.haz':'Peligroso/Electromagnético',
      'thumb.pasteHint':'Pulsa CTRL+V para añadir imagen',
      'thumb.title':'Ctrl/⌘+V Pegar imagen',
      'btn.uploadImage':'Subir',
      'btn.deleteRow':'Eliminar',
      // Nuevos: botones y títulos
      'btn.backTop':'↑ Arriba',
      'title.backTop':'Volver arriba',
      'btn.collapse':'Colapsar',
      'btn.expand':'Desplegar',
      // Nuevos: placeholders
      'ph.truckManualVol':'p. ej. 12.5',
      'ph.wallpaperUrl':'p. ej.: https://.../image.jpg',
      'ph.weatherFreq':'p. ej.: 30',
      'ph.weatherCity':'p. ej.: Shanghái o Shenzhen',
      'ph.customerName':'Nombre del cliente',
      'ph.customerContact':'Contacto',
      'ph.customerPhone':'Teléfono',
      'ph.customerEmail':'Correo electrónico',
      'ph.customerWechat':'WeChat/QQ (opcional)',
      'ph.smartFill':'Ejemplo:\nA001 600 450 330 10 0.5 kg normal #34a853\no L:600 W:450 H:330 Cant.:10 Peso:0.5kg Tipo:crema Color:#1a73e8',
      'phrases':['Pensando…','Recuperando memoria…','Analizando escena…','Optimizando disposición…','Comprobando volumen…','Emparejando camión…','Evaluando peso…','Aplicando colores…','Actualizando vista…','Listo…']
    }
  };

  function ensureProductRowI18n(lang){
    const dict = translations[lang] || translations['zh-CN'] || {};
    document.querySelectorAll('.product-row').forEach(row=>{
      const setLabelByInput=(sel,key)=>{
        const el=row.querySelector(sel); if(!el) return;
        const parent=el.closest('label.field'); if(!parent) return;
        const span=parent.querySelector('span.label'); if(!span) return;
        if(!span.getAttribute('data-i18n')) span.setAttribute('data-i18n', key);
        span.textContent = dict[key] || span.textContent;
      };
      const setPh=(sel,key)=>{ const el=row.querySelector(sel); if(!el) return; if(!el.getAttribute('data-i18n-ph')) el.setAttribute('data-i18n-ph', key); el.setAttribute('placeholder', (dict[key]||el.getAttribute('placeholder')||'')); };
      // 字段标签与占位符
      setLabelByInput('.pname','label.prodName'); setPh('.pname','ph.prodName');
      setLabelByInput('.pL','label.prodL'); setPh('.pL','ph.prodL');
      setLabelByInput('.pW','label.prodW'); setPh('.pW','ph.prodW');
      setLabelByInput('.pH','label.prodH'); setPh('.pH','ph.prodH');
      setLabelByInput('.pqty','label.prodQty'); setPh('.pqty','ph.prodQty');
      setLabelByInput('.pweight','label.prodWeight'); setPh('.pweight','ph.prodWeight');
      // 单位选择与标签
      const wu=row.querySelector('.pweightunit'); if(wu){
        const parent=wu.closest('label.field'); const span=parent && parent.querySelector('span.label');
        if(span){ if(!span.getAttribute('data-i18n')) span.setAttribute('data-i18n','label.prodUnit'); span.textContent = dict['label.prodUnit'] || span.textContent; }
        const okg=wu.querySelector('option[value="kg"]'); if(okg){ okg.setAttribute('data-i18n','unit.kg'); okg.textContent = dict['unit.kg']||okg.textContent; }
        const og=wu.querySelector('option[value="g"]'); if(og){ og.setAttribute('data-i18n','unit.g'); og.textContent = dict['unit.g']||og.textContent; }
        const ojin=wu.querySelector('option[value="jin"]'); if(ojin){ ojin.setAttribute('data-i18n','unit.jin'); ojin.textContent = dict['unit.jin']||ojin.textContent; }
      }
      // 颜色与类型标签
      const pcolor=row.querySelector('.pcolor'); if(pcolor){ const parent=pcolor.closest('label.field'); const span=parent && parent.querySelector('span.label'); if(span){ if(!span.getAttribute('data-i18n')) span.setAttribute('data-i18n','label.prodColor'); span.textContent = dict['label.prodColor']||span.textContent; } }
      const typeRadio=row.querySelector(`input[name='${row.dataset.ptname||''}']`); if(typeRadio){ const parent=typeRadio.closest('label.field'); const span=parent && parent.querySelector('span.label'); if(span){ if(!span.getAttribute('data-i18n')) span.setAttribute('data-i18n','label.prodType'); span.textContent = dict['label.prodType']||span.textContent; } }
      const setRadioText=(val,key)=>{ const input=row.querySelector(`input[name='${row.dataset.ptname||''}'][value='${val}']`); if(!input) return; const lbl=input.parentElement; let s=lbl.querySelector('span'); if(!s){ s=document.createElement('span'); lbl.appendChild(s); } s.setAttribute('data-i18n',key); s.textContent = dict[key] || s.textContent; };
      setRadioText('normal','prod.type.normal');
      setRadioText('paste','prod.type.paste');
      setRadioText('haz','prod.type.haz');
      // 缩略图提示与上传按钮
      const hint=row.querySelector('.thumb-hint-out'); if(hint){ hint.setAttribute('data-i18n','thumb.pasteHint'); hint.textContent = dict['thumb.pasteHint']||hint.textContent; }
      const tu=row.querySelector('.thumb-upload'); if(tu){ tu.setAttribute('data-i18n','btn.uploadImage'); tu.setAttribute('data-i18n-title','btn.uploadImage'); tu.textContent = dict['btn.uploadImage']||tu.textContent; tu.setAttribute('title', dict['btn.uploadImage']||tu.getAttribute('title')||''); }
      const rm=row.querySelector('.remove'); if(rm){ rm.setAttribute('data-i18n-title','btn.deleteRow'); rm.setAttribute('title', dict['btn.deleteRow']||rm.getAttribute('title')||''); }
    });
  }

  function applyTranslations(lang){
    ensureProductRowI18n(lang);
    const dict = translations[lang] || {};
    // 文本内容
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      if(key && (key in dict)) el.textContent = dict[key];
    });
    // 占位符
    document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
      const key = el.getAttribute('data-i18n-ph');
      if(key && (key in dict)) el.setAttribute('placeholder', dict[key]);
    });
    // 标题提示
    document.querySelectorAll('[data-i18n-title]').forEach(el=>{
      const key = el.getAttribute('data-i18n-title');
      if(key && (key in dict)) el.setAttribute('title', dict[key]);
    });
    // value 属性（如 input[type=button]）
    document.querySelectorAll('[data-i18n-value]').forEach(el=>{
      const key = el.getAttribute('data-i18n-value');
      if(key && (key in dict)) el.setAttribute('value', dict[key]);
    });
    // 分组折叠按钮文本（根据当前状态选择展开/折叠）
    document.querySelectorAll('.group').forEach(g=>{
      const btn = g.querySelector('.group-toggle');
      if(!btn) return;
      if(g.classList.contains('collapsed')){
        btn.textContent = (dict['btn.expand']||'展开');
      }else{
        btn.textContent = (dict['btn.collapse']||'折叠');
      }
    });
  }

  function setLangAttrs(lang){
    document.documentElement.lang = lang;
    document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
  }

  const __i18n = {
    t(key){ const lang = localStorage.getItem('uiLang') || 'zh-CN'; const dict = translations[lang]||{}; return (key in dict) ? dict[key] : key; },
    getLang(){ return localStorage.getItem('uiLang') || 'zh-CN'; },
    phrases(lang){ const d = translations[lang]||{}; return d.phrases || []; },
    apply(lang){ setLangAttrs(lang); applyTranslations(lang); }
  };
  window.__i18n = __i18n;

  function fixLangSelectContrast(){
    const sel = document.getElementById('langSelect');
    if(!sel) return;
    try{
      const dark = document.body.classList.contains('dark');
      sel.style.backgroundColor = dark ? 'rgba(0,0,0,0.75)' : 'rgba(255,255,255,0.95)';
      sel.style.color = dark ? '#fff' : '#111';
      sel.style.borderColor = dark ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.3)';
      sel.style.textShadow = 'none';
      sel.style.mixBlendMode = 'normal';
    }catch(e){}
  }

  function initI18n(){
    const saved = __i18n.getLang();
    setLangAttrs(saved);
    applyTranslations(saved);
    fixLangSelectContrast();
    const sel = document.getElementById('langSelect');
    if(sel){
      sel.value = saved;
      sel.addEventListener('change', (e)=>{
        const lang = e.target.value;
        localStorage.setItem('uiLang', lang);
        __i18n.apply(lang);
        fixLangSelectContrast();
        // 同步自定义下拉显示
        try{
          const d = document.getElementById('langDisplay');
          const opt = sel.querySelector(`option[value="${lang}"]`);
          if(d && opt){ d.querySelector('.current').textContent = opt.textContent; }
        }catch(ex){}
        // 重建通用自定义下拉，更新文本
        try{ if(window.__refreshCustomSelects__) window.__refreshCustomSelects__(); }catch(ex){}
      });
    }
    // 初始化自定义下拉组件
    try{
      const custom = document.getElementById('langCustom');
      const display = document.getElementById('langDisplay');
      const options = document.getElementById('langOptions');
      if(custom && display && options && sel){
        // 初始当前文字
        const curOpt = sel.querySelector(`option[value="${sel.value}"]`);
        if(curOpt){ display.querySelector('.current').textContent = curOpt.textContent; }

        // 门户定位：将选项层移动到 body 顶层并与触发器对齐
        function placeLangPortal(){
          const rect = display.getBoundingClientRect();
          options.classList.add('ui-portal');
          options.style.top = `${Math.round(rect.bottom)}px`;
          options.style.left = `${Math.round(rect.left)}px`;
          options.style.width = `${Math.round(rect.width)}px`;
        }
        function closeAllPortals(){
          try{
            document.querySelectorAll('.ui-portal').forEach(el=>{
              try{
                el.style.display='none';
                const owner=el.__originParent; if(owner){ owner.classList.remove('open'); owner.appendChild(el); }
                el.classList.remove('ui-portal');
              }catch(_){}
            });
          }catch(_){}
        }
        function openLang(){
          closeAllPortals();
          custom.classList.add('open');
          document.body.appendChild(options);
          options.style.display = 'block';
          options.__originParent = custom;
          placeLangPortal();
        }
        function closeLang(){
          custom.classList.remove('open');
          // 关闭时若原容器仍存在则放回，保持结构
          try{ custom.appendChild(options); }catch(_){ /* ignore */ }
          options.style.display = 'none';
          options.classList.remove('ui-portal');
        }

        // 展开/收起（使用 mousedown 并阻止冒泡，避免文档级关闭干扰）
        display.addEventListener('mousedown', (e)=>{ e.stopPropagation();
          if(custom.classList.contains('open')){ closeLang(); } else { openLang(); }
        });
        // 窗口滚动/尺寸变化时保持对齐
        window.addEventListener('scroll', ()=>{ if(custom.classList.contains('open')) placeLangPortal(); }, true);
        window.addEventListener('resize', ()=>{ if(custom.classList.contains('open')) placeLangPortal(); });

        // 选项点击
        options.querySelectorAll('.lang-option').forEach(it=>{
          it.addEventListener('mousedown', (e)=>{ e.stopPropagation();
            const lang = it.getAttribute('data-lang');
            if(!lang) return;
            sel.value = lang;
            sel.dispatchEvent(new Event('change', {bubbles:true}));
            closeLang();
          });
        });
        // 点击外部关闭
        document.addEventListener('mousedown', (ev)=>{
          const t = ev.target; if(!custom.contains(t) && !options.contains(t)){ closeLang(); }
        });
      }
    }catch(e){ console.warn('Custom lang select init failed', e); }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initI18n);
  } else {
    try { initI18n(); } catch(e) { console.warn('initI18n immediate run failed', e); }
  }
})();
</script>
<script id="custom-select-script">
(function(){
  function buildCustomFromSelect(sel){
    try{
      if(!sel || sel.classList.contains('native-hidden')) return null;
      const wrap = document.createElement('div');
      wrap.className = 'ui-select-custom';
      const display = document.createElement('div');
      display.className = 'ui-select-display';
      const span = document.createElement('span'); span.className='current';
      const arrow = document.createElement('span'); arrow.className='arrow';
      display.appendChild(span); display.appendChild(arrow);
      const list = document.createElement('div'); list.className='ui-select-options';
      [...sel.options].forEach(opt=>{
        const item = document.createElement('div'); item.className='ui-select-option';
        const t = document.createElement('span'); t.textContent = opt.textContent;
        const c = document.createElement('span'); c.className='code'; c.textContent = opt.value;
        item.appendChild(t); item.appendChild(c);
        item.addEventListener('mousedown', (e)=>{ e.stopPropagation();
          sel.value = opt.value;
          sel.dispatchEvent(new Event('change', {bubbles:true}));
          span.textContent = opt.textContent;
          closePortal();
        });
        list.appendChild(item);
      });
      const selected = sel.selectedIndex>=0 ? sel.options[sel.selectedIndex] : sel.options[0];
      if(selected) span.textContent = selected.textContent;
      // 门户定位逻辑：将选项层移动到 body 顶层
      function placePortal(){
        const rect = display.getBoundingClientRect();
        list.classList.add('ui-portal');
        list.style.top = `${Math.round(rect.bottom)}px`;
        list.style.left = `${Math.round(rect.left)}px`;
        list.style.width = `${Math.round(rect.width)}px`;
      }
      function closeAllPortals(){
        try{
          document.querySelectorAll('.ui-portal').forEach(el=>{
            try{
              el.style.display='none';
              const owner=el.__originParent; if(owner){ owner.classList.remove('open'); owner.appendChild(el); }
              el.classList.remove('ui-portal');
            }catch(_){}
          });
        }catch(_){}
      }
      function openPortal(){
        closeAllPortals();
        wrap.classList.add('open');
        document.body.appendChild(list);
        list.style.display = 'block';
        list.__originParent = wrap;
        placePortal();
      }
      function closePortal(){
        wrap.classList.remove('open');
        try{ wrap.appendChild(list); }catch(_){ }
        list.style.display = 'none';
        list.classList.remove('ui-portal');
      }
      // 展开/收起（mousedown + 阻止冒泡，避免文档级关闭干扰）
      display.addEventListener('mousedown', (e)=>{ e.stopPropagation();
        if(wrap.classList.contains('open')){ closePortal(); } else { openPortal(); }
      });
      document.addEventListener('mousedown', (ev)=>{ const t=ev.target; if(!wrap.contains(t) && !list.contains(t)) closePortal(); });
      window.addEventListener('scroll', ()=>{ if(wrap.classList.contains('open')) placePortal(); }, true);
      window.addEventListener('resize', ()=>{ if(wrap.classList.contains('open')) placePortal(); });
      sel.classList.add('native-hidden');
      wrap.appendChild(display); wrap.appendChild(list);
      sel.parentNode.insertBefore(wrap, sel.nextSibling);
      return wrap;
    }catch(e){ console.warn('buildCustomFromSelect failed', e); return null; }
  }
  function initAll(){
    // 统一左栏与主区的所有select（跳过已隐藏的语言选择与显式要求原生的）
    document.querySelectorAll('select:not(.native-hidden):not([data-native-only])').forEach(s=>{
      // 跳过颜色选择器等特殊控件
      if(s.closest('.color-popover')) return;
      buildCustomFromSelect(s);
    });
  }
  // 暴露刷新方法，便于语言切换后重新生成文本
  window.__refreshCustomSelects__ = function(){
    try{
      // 先统一关闭所有门户层并归位，避免遗留的顶层浮层影响布局
      try{
        document.querySelectorAll('.ui-portal').forEach(el=>{
          try{
            el.style.display='none';
            const owner=el.__originParent; if(owner){ owner.classList.remove('open'); owner.appendChild(el); }
            el.classList.remove('ui-portal');
          }catch(_){}
        });
      }catch(_){}
      // 移除已有自定义组件（保留原生select隐藏状态）
      document.querySelectorAll('.ui-select-custom').forEach(w=>w.remove());
      document.querySelectorAll('select.native-hidden').forEach(s=>{ s.classList.remove('native-hidden'); });
      initAll();
    }catch(e){}
  };
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAll);
  } else {
    try { initAll(); } catch(e) { console.warn('initAll immediate run failed', e); }
  }
})();
</script>
<script>
try{
  addEventListener('paste',e=>{
    if(!activePasteRow)return;
    const t=activePasteRow.querySelector('[data-role\"thumb\"]');
    if(!t)return;
    setTimeout(()=>{
      try{
        if(t.style && t.style.backgroundImage){
          t.classList.add('has-image');
          activePasteRow.classList.add('thumb-has-image');
        }
      }catch(err){}
    },60);
  });
}catch(err){}
</script>
<style id="thumb-upload-style">
.product-row .thumb{position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden}
.product-row .thumb-hint-out{font-size:12px;line-height:1.2;color:#888;flex:0 0 100%;margin-bottom:4px}
.product-row.thumb-has-image .thumb-hint-out{display:none}
.product-row .thumb-upload{position:relative;font-size:12px;padding:2px 8px;border-radius:3px;cursor:pointer;color:#000 !important}
.product-row .thumb-upload:hover{filter:brightness(1.06)}
.product-row .thumb.has-image .thumb-upload{display:none}
</style>
</body>
</html>
